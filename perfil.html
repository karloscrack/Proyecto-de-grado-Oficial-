<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Unidad Educativa Despertar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="diseno.css"> 
    
    <style>
        /* =========================================
           üé® SISTEMA DE TEMAS (GEMELO AL ADMIN)
           ========================================= */
        :root {
            /* MODO CLARO */
            --bg-image: url('Img/Claro.png'); 
            --bg-body: #f4f6f9;
            --bg-card: rgba(255, 255, 255, 0.95);
            --bg-header: rgba(255, 255, 255, 0.98);
            --bg-menu: #ffffff;
            --text-main: #333333;
            --text-sec: #666666;
            --border-color: #e0e0e0;
            --input-bg: #ffffff;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --icon-color: #6A0DAD;
            --hover-item: #f3e5f5;
            --accent-color: #6A0DAD;
            --preview-bg: #e0e0e0; /* Color fondo miniaturas */
        }

        body.dark-mode {
            /* MODO OSCURO */
            --bg-image: url('Img/Oscuro.png'); 
            --bg-body: #121212;
            --bg-card: rgba(30, 30, 30, 0.95);
            --bg-header: rgba(30, 30, 30, 0.98);
            --bg-menu: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sec: #a0a0a0;
            --border-color: #333333;
            --input-bg: #2d2d2d;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
            --icon-color: #ffffff;
            --hover-item: #2c2c2c;
            --accent-color: #ab47bc;
            --preview-bg: #000000; /* Fondo negro para videos en modo noche */
        }

        /* --- ACCESIBILIDAD (MODO ALTO CONTRASTE) --- */
        body.high-contrast {
            --bg-image: none !important;
            --bg-body: #000000 !important;
            --bg-card: #000000 !important;
            --text-main: #FFFF00 !important;
            --text-sec: #00FF00 !important;
            --border-color: #FFFFFF !important;
            --icon-color: #FFFF00 !important;
            --accent-color: #00FFFF !important;
            --preview-bg: #000000 !important;
        }
        
        body.large-text { font-size: 130% !important; }

        /* BASE */
        body { 
            background-color: var(--bg-body); 
            background-image: var(--bg-image) !important;
            background-size: cover; background-position: center; 
            background-attachment: fixed; background-repeat: no-repeat;
            color: var(--text-main); transition: all 0.5s ease;
            padding-top: 80px;
        }

        /* --- HEADER (IGUAL AL ADMIN) --- */
        .header {
            background-color: var(--bg-header) !important;
            box-shadow: var(--shadow);
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 30px !important; 
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
        }
        .header-right { display: flex; align-items: center; gap: 15px; }

        .btn-login-header {
            background: #c62828; color: white; border: none; cursor: pointer; border-radius: 25px; 
            text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: 5px; 
            transition: 0.3s; padding: 10px 20px !important; font-size: 0.95rem !important;
        }
        .btn-login-header:hover { background: #b71c1c; transform: translateY(-2px); }

        /* --- PERFIL HERO (TARJETA) --- */
        .profile-hero { 
            background: var(--bg-card) !important; backdrop-filter: blur(10px); 
            border-radius: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow); 
            display: flex; align-items: center; padding: 40px; margin-bottom: 30px; gap: 30px; 
        }
        .profile-hero img { 
            width: 120px; height: 120px; border-radius: 50%; 
            object-fit: cover; border: 4px solid var(--accent-color); 
        }
        .hero-text h1 { color: #2E8B57; font-size: 2.2rem; margin: 0; }
        .hero-text h2 { color: var(--accent-color); font-size: 1.5rem; margin: 5px 0; }
        .hero-text p { color: var(--text-sec); font-size: 1rem; margin: 5px 0; }

        /* --- FILTROS Y T√çTULO (MEJORADO) --- */
        .gallery-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
            /* Fondo sutil para que el t√≠tulo resalte en modo claro */
            background: var(--bg-card);
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        
        .section-title { 
            color: var(--text-main); font-size: 1.3rem; margin: 0; font-weight: bold;
            border-left: 5px solid var(--accent-color); padding-left: 15px; 
        }
        
        .filter-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-btn {
            background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: 0.3s;
            display: flex; align-items: center; gap: 8px; font-weight: bold;
        }
        .filter-btn.active, .filter-btn:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); }

        /* --- GALER√çA (VIDEO CORREGIDO) --- */
        .files-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; padding-bottom: 50px; 
        }
        
        .file-card { 
            background: var(--bg-card) !important; 
            border-radius: 12px; 
            overflow: hidden; 
            transition: all 0.3s ease; 
            cursor: pointer; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border-color); 
            position: relative;
            aspect-ratio: 1 / 1; 
        }
        .file-card:hover { transform: scale(1.05); border-color: var(--accent-color); z-index: 2; }
        
        .card-preview { 
            width: 100%; height: 100%; 
            background: var(--preview-bg); /* Fondo oscuro para evitar pantallazo blanco */
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; 
        }
        .card-preview img, .card-preview video { width: 100%; height: 100%; object-fit: cover; }
        .card-preview i { font-size: 3rem; color: var(--text-sec); opacity: 0.7; }

        /* --- MEN√ö LATERAL --- */
        .side-menu {
            background-color: var(--bg-menu) !important; color: var(--text-main) !important;
            border-right: 1px solid var(--border-color); position: fixed; top: 0; right: -320px; width: 300px; height: 100vh;
            transition: right 0.4s ease; z-index: 1001; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        .side-menu.active { right: 0; }
        
        .side-menu ul { list-style: none; padding: 0; margin-top: 20px; }
        .side-menu li button { 
            width: 100%; padding: 12px 15px; text-align: left; background: none; border: none; 
            color: var(--text-main); font-size: 1.1rem; cursor: pointer; border-radius: 10px;
            display: flex; align-items: center; gap: 15px; transition: 0.3s;
        }
        .side-menu li button:hover { background-color: var(--hover-item); color: var(--accent-color); }
        .side-menu li button i { width: 25px; text-align: center; color: var(--accent-color); }
        
        .close-menu { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 1.5rem; color: var(--text-main); cursor: pointer; }
        .overlay-menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 1000; }
        .overlay-menu.active { display: block; }

        /* --- TEMA BTN --- */
        .theme-toggle {
            background: transparent; border: 2px solid var(--icon-color); color: var(--icon-color);
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s;
        }
        .theme-toggle:hover { transform: scale(1.1); background-color: var(--hover-item); }
        .rotate-anim { animation: spin 0.5s ease-in-out; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- LIGHTBOX --- */
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; display: none; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .lightbox.active { display: flex; }
        .lightbox-content img, .lightbox-content video { max-width: 90%; max-height: 80vh; border-radius: 10px; }
        .lightbox-details { margin-top: 15px; text-align: center; }
        .btn-download { background: #2E8B57; color: white; padding: 10px 25px; border-radius: 30px; text-decoration: none; font-weight: bold; }
        
        /* --- MODALES --- */
        .info-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2500; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .info-modal.active { display: flex; animation: fadeIn 0.3s; }
        .info-card { background: var(--bg-card); color: var(--text-main); width: 90%; max-width: 450px; border-radius: 20px; padding: 30px; border-top: 5px solid var(--accent-color); text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .btn-close-modal { background: var(--accent-color); color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; margin-top: 20px; width: 100%; }

        /* Accesibilidad dentro del men√∫ hamburguesa */
        .acc-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
        .acc-btn { background: var(--input-bg); border: 1px solid var(--border-color); padding: 12px; border-radius: 10px; cursor: pointer; color: var(--text-main); font-weight: bold; display: flex; align-items: center; gap: 10px; transition: 0.2s; text-align: left; }
        .acc-btn:hover { background: var(--hover-item); border-color: var(--accent-color); }
        .acc-btn i { font-size: 1.2rem; color: var(--accent-color); width: 25px; text-align: center; }

        footer { background: #2c2c2c; color: white; padding: 40px 20px; text-align: center; margin-top: auto; }
.footer-content { max-width: 1200px; margin: 0 auto; }
.footer-logo img { height: 100px; margin-bottom: 15px; }
.footer-logo h3 { color: #6A0DAD; font-size: 1.8rem; margin: 0; }
.footer-social { display: flex; justify-content: center; gap: 20px; margin: 25px 0; }
.footer-social a { 
    display: flex; align-items: center; justify-content: center; 
    width: 40px; height: 40px; background: #444; 
    color: white; border-radius: 50%; transition: all 0.3s ease; text-decoration: none; 
}
.footer-social a:hover { background: #6A0DAD; transform: translateY(-5px); }
.copyright { color: #999; font-size: 0.9rem; padding-top: 20px; border-top: 1px solid #444; }
        @media (max-width: 768px) {
            .header { padding: 10px 15px !important; }
            .profile-hero { flex-direction: column; text-align: center; padding: 20px; }
            .files-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; } /* 2 columnas en m√≥vil */
            .btn-login-header span { display: none; }
            .gallery-header { justify-content: center; text-align: center; } /* Centrar filtros en m√≥vil */
        }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    </style>
</head>
<body>
    
    <header class="header">
        <div class="logo">
            <a href="index.html"><img src="Img/Logo-Despertar-SKAS-Unidad-Educativa23.png" alt="Logo"></a>
        </div>
        
        <div class="header-right">
            <button onclick="toggleTheme()" class="theme-toggle" id="themeBtn" title="Cambiar Tema">
                <i class="fas fa-moon"></i>
            </button>
            <button onclick="cerrarSesion()" class="btn-login-header">
                <span>Salir</span>
            </button>
            <button class="menu-toggle" id="menuToggle" style="background:none; border:none; color:var(--icon-color); font-size:1.8rem; cursor:pointer;">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>
    
    <div class="overlay-menu" id="overlayMenu"></div>
    <div class="side-menu" id="sideMenu">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--border-color); padding-bottom:10px;">
            <h3 style="margin:0; color:var(--accent-color);">Men√∫</h3>
            <button class="close-menu" id="closeMenu" style="background:none; border:none; font-size:1.5rem; color:var(--text-main); cursor:pointer;"><i class="fas fa-times"></i></button>
        </div>
        <ul>
            <li><button onclick="location.reload()"><i class="fas fa-user"></i> Mi Perfil</button></li>
            <li><button onclick="window.location.href='index.html'"><i class="fas fa-home"></i> Inicio</button></li>
            <li><button onclick="mostrarModal('modalAccesibilidad')"><i class="fas fa-universal-access"></i> Accesibilidad</button></li>
            <li><button onclick="mostrarModal('modalAyuda')"><i class="fas fa-question-circle"></i> Soporte</button></li>
            <hr style="border:0; border-top:1px solid var(--border-color); margin: 15px 0;">
            <li><button onclick="cerrarSesion()" style="color:#c62828 !important;"><i class="fas fa-sign-out-alt" style="color:#c62828 !important;"></i> Cerrar Sesi√≥n</button></li>
        </ul>
    </div>
    
    <div class="container">
        <div class="profile-hero">
            <img id="profilePhoto" src="" alt="Perfil">
            <div class="hero-text">
                <h1>¬°Hola!</h1>
                <h2 id="userNameDisplay">Cargando...</h2>
                <p><i class="fas fa-id-card"></i> C.I: <span id="userCedulaDisplay">...</span></p>
                <p style="font-size: 1rem; color: #2E8B57; font-weight:bold; margin-top:5px;">
                    <i class="fas fa-circle" style="font-size: 0.7rem;"></i> Estudiante Activo
                </p>
            </div>
        </div>

        <div class="gallery-header">
    <div style="display:flex; align-items:center; justify-content:space-between; width:100%; flex-wrap:wrap; gap:10px;">
        <h3 class="section-title">Mis Evidencias</h3>
        
        <button onclick="activarSeleccion()" id="btnSelectMode" class="action-pill btn-select-pill">
            <i class="fas fa-check-circle"></i> Seleccionar
        </button>
    </div>
    
    <div class="filter-buttons" style="margin-top:15px;">
        <button class="filter-btn active" onclick="filtrarGaleria('todo', this)"><i class="fas fa-th-large"></i> Todo</button>
        </div>
</div>

<div id="barraSeleccion" class="selection-toolbar" style="bottom: 80px;"> <span id="contadorSeleccion">0 seleccionados</span>
    <button onclick="descargarSeleccionados()"><i class="fas fa-download"></i> Descargar ZIP</button>
    <button onclick="cancelarSeleccion()" style="background:transparent; color:white; border:1px solid white;">Cancelar</button>
</div>
        
        <div id="galleryContainer" class="files-grid"></div>

        <div id="noFilesMessage" class="search-card" style="display:none; text-align:center; padding: 40px;">
            <i class="fas fa-folder-open" style="font-size: 4rem; color: var(--text-sec); opacity:0.5; margin-bottom: 15px;"></i>
            <p style="color: var(--text-sec); font-size: 1.2rem;">No se encontraron evidencias.</p>
        </div>
    </div>

    <div class="info-modal" id="modalAccesibilidad">
        <div class="info-card">
            <i class="fas fa-universal-access" style="font-size: 3rem; color: var(--accent-color); margin-bottom: 15px;"></i>
            <h3>Accesibilidad</h3>
            <div class="acc-grid">
                <button class="acc-btn" onclick="toggleTextSize()">
                    <i class="fas fa-text-height"></i> <span>Texto Grande</span>
                </button>
                <button class="acc-btn" onclick="toggleHighContrast()">
                    <i class="fas fa-adjust"></i> <span>Alto Contraste</span>
                </button>
                <button class="acc-btn" onclick="leerPantalla()">
                    <i class="fas fa-volume-up"></i> <span>Leer Pantalla</span>
                </button>
                <button class="acc-btn" onclick="mostrarModal('modalGuia')">
                    <i class="fas fa-info-circle"></i> <span>Gu√≠a Simple</span>
                </button>
            </div>
            <button class="btn-close-modal" onclick="cerrarModal('modalAccesibilidad')">Cerrar</button>
        </div>
    </div>

    <div class="info-modal" id="modalGuia">
        <div class="info-card">
            <h3>¬øC√≥mo uso esto?</h3>
            <ul style="text-align:left; font-size:1.1rem; line-height:1.8; list-style:none; padding:0;">
                <li>üì∏ <strong>Tus fotos:</strong> Est√°n abajo en cuadros.</li>
                <li>üëÜ <strong>Ver grande:</strong> Toca una foto para abrirla.</li>
                <li>üîç <strong>Buscar:</strong> Usa los botones de "Fotos" o "Videos".</li>
            </ul>
            <button class="btn-close-modal" onclick="cerrarModal('modalGuia')">Entendido</button>
        </div>
    </div>

    <div class="info-modal" id="modalAyuda">
        <div class="info-card">
            <i class="fas fa-headset" style="font-size: 3rem; color: #2E8B57; margin-bottom: 15px;"></i>
            <h3>Soporte</h3>
            <p><strong>üìß:</strong> akuamtam@hotmail.com</p>
            <p><strong>üìû:</strong> 098 608 9754</p>
            <button class="btn-close-modal" onclick="cerrarModal('modalAyuda')">Cerrar</button>
        </div>
    </div>

    <div class="lightbox" id="lightbox">
        <span style="position:absolute; top:20px; right:30px; color:white; font-size:3rem; cursor:pointer;" id="lightboxClose">&times;</span>
        <div style="position:absolute; top:50%; left:20px; color:white; font-size:3rem; cursor:pointer;" id="lightboxPrev"><i class="fas fa-chevron-left"></i></div>
        <div style="position:absolute; top:50%; right:20px; color:white; font-size:3rem; cursor:pointer;" id="lightboxNext"><i class="fas fa-chevron-right"></i></div>
        <div class="lightbox-content" id="lightboxContent"></div>
        <div class="lightbox-details">
            <h3 id="lightboxFilename" style="color:white; margin-bottom:10px;">Archivo</h3>
            <a href="#" class="btn-download" id="lightboxDownload" download target="_blank"><i class="fas fa-download"></i> Descargar</a>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <img src="Img/Logo-Despertar-SKAS-Unidad-Educativa23.png" alt="Logo">
                <h3>Unidad Educativa Particular Despertar</h3>
            </div>
            <div class="footer-social">
                <a href="https://www.facebook.com/uepdespertar"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.youtube.com/@DespertarSKAS"><i class="fab fa-youtube"></i></a>
                <a href="https://www.instagram.com/skas_despertar"><i class="fab fa-instagram"></i></a>
            </div>
            <div class="copyright">
                <p>¬© 2025 Plataforma Educativa - Unidad Educativa Particular Despertar. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        const baseUrl = "https://proyecto-de-grado-oficial-production.up.railway.app";

        // --- ACCESIBILIDAD ---
        function toggleTextSize() { document.body.classList.toggle('large-text'); }
        function toggleHighContrast() { document.body.classList.toggle('high-contrast'); }
        function leerPantalla() {
            const nombre = document.getElementById('userNameDisplay').textContent;
            const msg = new SpeechSynthesisUtterance(`Hola ${nombre}. Bienvenido a tu perfil.`);
            window.speechSynthesis.speak(msg);
        }

        // --- TEMA ---
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('themeBtn');
            const icon = btn.querySelector('i');
            icon.classList.add('rotate-anim'); 
            setTimeout(() => {
                body.classList.toggle('dark-mode');
                if (body.classList.contains('dark-mode')) {
                    icon.classList.remove('fa-moon'); icon.classList.add('fa-sun');
                    localStorage.setItem('student_theme', 'dark');
                } else {
                    icon.classList.remove('fa-sun'); icon.classList.add('fa-moon');
                    localStorage.setItem('student_theme', 'light');
                }
            }, 200); 
            setTimeout(() => { icon.classList.remove('rotate-anim'); }, 500);
        }

        let currentGallery = [];
        let currentIndex = 0;
        let activeFilter = 'todo';

        window.onload = async function() {
            const savedTheme = localStorage.getItem('student_theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const icon = document.querySelector('#themeBtn i');
                if(icon) icon.classList.replace('fa-moon', 'fa-sun');
            }

            const cedula = localStorage.getItem('usuario_cedula');
            const contrasena = localStorage.getItem('usuario_contrasena');
            
            if (!cedula) { alert("Sesi√≥n no iniciada."); window.location.href = "biblioteca.html"; return; }

            document.getElementById('userCedulaDisplay').textContent = cedula;
            
            const datosForm = new FormData();
            datosForm.append('cedula', cedula);
            if(contrasena) datosForm.append('contrasena', contrasena);

            try {
                const res = await fetch(`${baseUrl}/buscar_estudiante`, { 
                    method: "POST", body: datosForm 
                });
                const data = await res.json();

                if (data.encontrado) {
                    const primerNombre = data.datos.nombre.split(' ')[0];
                    const primerApellido = data.datos.apellido.split(' ')[0];
                    document.getElementById('userNameDisplay').textContent = `${primerNombre} ${primerApellido}`;
                    
                    if(data.datos.url_foto) document.getElementById('profilePhoto').src = data.datos.url_foto;
                    else document.getElementById('profilePhoto').src = "https://via.placeholder.com/150";

                    currentGallery = data.datos.galeria || [];
                    if (data.datos.url_foto) {
                        const yaExiste = currentGallery.some(a => (a.url || a.url_foto) === data.datos.url_foto);
                        if (!yaExiste) currentGallery.unshift({ url: data.datos.url_foto });
                    }
                    renderGallery(currentGallery);
                } else {
                    alert("Sesi√≥n inv√°lida o expirada."); cerrarSesion();
                }
            } catch (error) { 
                console.error(error); 
                alert("Error de conexi√≥n con el servidor."); 
            }
        };

        // --- FILTRADO NUEVO (INCLUYE DOCS) ---
        function filtrarGaleria(tipo, btn) {
            activeFilter = tipo;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            if (tipo === 'todo') {
                renderGallery(currentGallery);
            } else {
                const filtrados = currentGallery.filter(item => {
                    const url = item.url || item.url_foto;
                    const ext = url.split('.').pop().toLowerCase();
                    if (tipo === 'foto') return ['jpg', 'jpeg', 'png', 'webp', 'gif'].includes(ext);
                    if (tipo === 'video') return ['mp4', 'webm', 'ogg', 'mov', 'avi'].includes(ext);
                    // L√≥gica para documentos
                    if (tipo === 'doc') return ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'zip', 'rar'].includes(ext);
                    return false;
                });
                renderGallery(filtrados);
            }
        }

        // --- RENDERIZADO MEJORADO (CON DOCS) ---
        function renderGallery(listaItems) {
            const container = document.getElementById('galleryContainer');
            container.innerHTML = '';

            if (listaItems.length > 0) {
                document.getElementById('noFilesMessage').style.display = 'none';
                
                listaItems.forEach((archivo) => {
                    const originalIndex = currentGallery.indexOf(archivo);
                    const url = archivo.url || archivo.url_foto;
                    const extension = url.split('.').pop().toLowerCase();
                    const isImage = ['jpg', 'jpeg', 'png', 'webp', 'gif'].includes(extension);
                    const isVideo = ['mp4', 'webm', 'ogg', 'mov', 'avi'].includes(extension);
                    const isDoc = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'zip', 'rar'].includes(extension);
                    
                    const card = document.createElement('div');
                    card.className = 'file-card';
                    card.onclick = () => openLightbox(originalIndex);
                    
                    let previewContent = '';
                    if (isImage) {
                        previewContent = `<img src="${url}" alt="Evidencia">`;
                    } else if (isVideo) {
                        // FIX: Video con fondo negro y playsinline para evitar pantallazo blanco
                        previewContent = `<video src="${url}#t=0.1" preload="metadata" muted playsinline style="background:black;"></video><div style="position:absolute; font-size:3rem; color:white; opacity:0.8;"><i class="fas fa-play-circle"></i></div>`;
                    } else {
                        // FIX: Icono para documentos
                        let iconClass = 'fa-file-alt';
                        if(extension === 'pdf') iconClass = 'fa-file-pdf';
                        if(['doc','docx'].includes(extension)) iconClass = 'fa-file-word';
                        if(['xls','xlsx'].includes(extension)) iconClass = 'fa-file-excel';
                        previewContent = `<i class="fas ${iconClass}"></i>`;
                    }

                    // SOLO IMAGEN/ICONO, SIN TEXTO ABAJO
                    card.innerHTML = `<div class="card-preview">${previewContent}</div>`;
                    container.appendChild(card);
                });
            } else {
                document.getElementById('noFilesMessage').style.display = 'block';
            }
        }

        const menuToggle = document.getElementById('menuToggle');
        const sideMenu = document.getElementById('sideMenu');
        const closeMenu = document.getElementById('closeMenu');
        const overlayMenu = document.getElementById('overlayMenu');

        function abrirMenu() { sideMenu.classList.add('active'); overlayMenu.classList.add('active'); }
        function cerrarMenu() { sideMenu.classList.remove('active'); overlayMenu.classList.remove('active'); }
        
        if(menuToggle) menuToggle.addEventListener('click', abrirMenu);
        if(closeMenu) closeMenu.addEventListener('click', cerrarMenu);
        if(overlayMenu) overlayMenu.addEventListener('click', cerrarMenu);

        // CERRAR AL TOCAR FUERA (UX)
        overlayMenu.onclick = cerrarMenu;

        function mostrarModal(id) { document.getElementById(id).classList.add('active'); cerrarMenu(); }
        function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }
        document.querySelectorAll('.info-modal').forEach(modal => {
            modal.addEventListener('click', (e) => { if(e.target === modal) cerrarModal(modal.id); });
        });

        // LIGHTBOX MEJORADO
        const lightbox = document.getElementById('lightbox');
        const lightboxContent = document.getElementById('lightboxContent');
        const lightboxFilename = document.getElementById('lightboxFilename');
        const lightboxDownload = document.getElementById('lightboxDownload');
        const lightboxClose = document.getElementById('lightboxClose');
        const lightboxPrev = document.getElementById('lightboxPrev');
        const lightboxNext = document.getElementById('lightboxNext');

        function openLightbox(index) {
            currentIndex = index; updateLightboxContent();
            lightbox.classList.add('active'); document.body.style.overflow = 'hidden';
        }
        function closeLightbox() {
            lightbox.classList.remove('active'); lightboxContent.innerHTML = '';
            document.body.style.overflow = 'auto';
        }
        function updateLightboxContent() {
            const archivo = currentGallery[currentIndex];
            const url = archivo.url || archivo.url_foto;
            const nombre = url.split('/').pop();
            const ext = url.split('.').pop().toLowerCase();
            const isImg = ['jpg', 'jpeg', 'png', 'webp', 'gif'].includes(ext);
            const isVid = ['mp4', 'webm', 'ogg', 'mov', 'avi'].includes(ext);

            lightboxContent.innerHTML = '';
            if (isImg) lightboxContent.innerHTML = `<img src="${url}">`;
            else if (isVid) lightboxContent.innerHTML = `<video src="${url}" controls autoplay></video>`;
            else lightboxContent.innerHTML = `<div style="color:white;text-align:center;"><i class="fas fa-file-download" style="font-size:5rem; margin-bottom:20px;"></i><p>Vista previa no disponible para este archivo.</p><p>Desc√°rgalo para verlo.</p></div>`;

            lightboxFilename.textContent = nombre;
            lightboxDownload.href = url;
        }
        
        function getFilteredIndices() {
            return currentGallery.map((item, idx) => {
                const url = item.url || item.url_foto;
                const ext = url.split('.').pop().toLowerCase();
                let match = false;
                if (activeFilter === 'todo') match = true;
                else if (activeFilter === 'foto') match = ['jpg', 'jpeg', 'png', 'webp'].includes(ext);
                else if (activeFilter === 'video') match = ['mp4', 'webm', 'ogg', 'mov'].includes(ext);
                else if (activeFilter === 'doc') match = !['jpg', 'jpeg', 'png', 'webp', 'mp4', 'webm', 'ogg', 'mov', 'avi'].includes(ext);
                return match ? idx : -1;
            }).filter(i => i !== -1);
        }

        function prevImage() { 
            const indices = getFilteredIndices();
            const currentPos = indices.indexOf(currentIndex);
            if (currentPos === -1) currentIndex = indices[indices.length - 1]; 
            else {
                const newPos = (currentPos - 1 + indices.length) % indices.length;
                currentIndex = indices[newPos];
            }
            updateLightboxContent(); 
        }
        function nextImage() { 
            const indices = getFilteredIndices();
            const currentPos = indices.indexOf(currentIndex);
            if (currentPos === -1) currentIndex = indices[0];
            else {
                const newPos = (currentPos + 1) % indices.length;
                currentIndex = indices[newPos];
            }
            updateLightboxContent(); 
        }

        lightboxClose.addEventListener('click', closeLightbox);
        lightboxPrev.addEventListener('click', (e) => { e.stopPropagation(); prevImage(); });
        lightboxNext.addEventListener('click', (e) => { e.stopPropagation(); nextImage(); });
        lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });
        
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('active')) return;
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') prevImage();
            if (e.key === 'ArrowRight') nextImage();
        });

        let touchstartX = 0; let touchendX = 0;
        lightbox.addEventListener('touchstart', e => touchstartX = e.changedTouches[0].screenX);
        lightbox.addEventListener('touchend', e => { 
            touchendX = e.changedTouches[0].screenX; 
            if (touchendX < touchstartX - 50) nextImage(); 
            if (touchendX > touchstartX + 50) prevImage(); 
        });

        function cerrarSesion() { 
            const tema = localStorage.getItem('student_theme');
            localStorage.clear(); 
            if(tema) localStorage.setItem('student_theme', tema);
            window.location.href = "index.html"; 
        }
        // --- L√ìGICA DE SELECCI√ìN M√öLTIPLE (ESTUDIANTE) ---
let modoSeleccion = false;
let itemsSeleccionados = [];

function activarSeleccion() {
    modoSeleccion = !modoSeleccion;
    const btn = document.getElementById('btnSelectMode');
    const cards = document.querySelectorAll('.file-card'); // Ojo: en estudiante se llaman .file-card
    const barra = document.getElementById('barraSeleccion');

    if (modoSeleccion) {
        btn.innerHTML = '<i class="fas fa-times"></i> Cancelar';
        btn.classList.add('active');
        // A√±adimos clase visual para indicar que se puede seleccionar
        cards.forEach(c => c.style.cursor = "alias"); 
        barra.classList.add('active');
    } else {
        cancelarSeleccion();
    }
}

function cancelarSeleccion() {
    modoSeleccion = false;
    itemsSeleccionados = [];
    document.querySelectorAll('.file-card').forEach(c => {
        c.classList.remove('selected');
        c.style.cursor = "pointer";
        // Quitamos el check visual si lo tuviera
        const check = c.querySelector('.select-checkbox');
        if(check) check.classList.remove('checked');
    });
    document.getElementById('barraSeleccion').classList.remove('active');
    
    const btn = document.getElementById('btnSelectMode');
    if(btn) {
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Seleccionar';
        btn.classList.remove('active');
    }
    document.getElementById('contadorSeleccion').innerText = "0 seleccionados";
}

// Modificamos el renderGallery para incluir el checkbox oculto
// NOTA: Reemplaza o modifica tu funci√≥n renderGallery existente
function renderGallery(listaItems) {
    const container = document.getElementById('galleryContainer');
    container.innerHTML = '';

    if (listaItems.length > 0) {
        document.getElementById('noFilesMessage').style.display = 'none';
        
        listaItems.forEach((archivo) => {
            // ... (c√≥digo existente de detecci√≥n de tipo) ...
            const originalIndex = currentGallery.indexOf(archivo);
            const url = archivo.url || archivo.url_foto;
            const idArchivo = archivo.id; // Aseg√∫rate de que tu backend devuelve el ID en buscar_estudiante
            
            // ... (l√≥gica de previewContent) ...
            // Aqu√≠ simulamos previewContent para el ejemplo
            let previewContent = `<img src="${url}" style="width:100%;height:100%;object-fit:cover;">`; 
            
            const card = document.createElement('div');
            card.className = 'file-card';
            // IMPORTANTE: ID √∫nico para seleccionarlo
            card.id = `card-${idArchivo}`;
            
            // Insertamos Checkbox visual
            card.innerHTML = `
                <div class="select-checkbox" id="check-${idArchivo}" style="position:absolute; top:10px; left:10px; z-index:10; width:25px; height:25px; background:white; border-radius:50%; border:2px solid #ccc; display:${modoSeleccion ? 'flex':'none'}; align-items:center; justify-content:center; color:#6A0DAD; font-weight:bold;"></div>
                <div class="card-preview">${previewContent}</div>
            `;
            
            // L√≥gica de clic: Si es modo selecci√≥n, selecciona. Si no, Lightbox.
            card.onclick = (e) => {
                if(modoSeleccion) {
                    toggleSeleccion(idArchivo);
                } else {
                    openLightbox(originalIndex);
                }
            };

            container.appendChild(card);
        });
    } else {
        document.getElementById('noFilesMessage').style.display = 'block';
    }
}

function toggleSeleccion(id) {
    const index = itemsSeleccionados.indexOf(id);
    const checkDiv = document.getElementById(`check-${id}`);
    const card = document.getElementById(`card-${id}`);

    if (index === -1) {
        if(itemsSeleccionados.length >= 25) return alert("M√°ximo 25 archivos.");
        itemsSeleccionados.push(id);
        card.style.border = "3px solid #6A0DAD";
        card.style.transform = "scale(0.95)";
        if(checkDiv) { checkDiv.style.display="flex"; checkDiv.innerHTML = "‚úì"; checkDiv.style.borderColor="#6A0DAD"; }
    } else {
        itemsSeleccionados.splice(index, 1);
        card.style.border = "none"; // O el borde original
        card.style.transform = "scale(1)";
        if(checkDiv) { checkDiv.innerHTML = ""; checkDiv.style.borderColor="#ccc"; }
    }
    document.getElementById('contadorSeleccion').innerText = `${itemsSeleccionados.length} seleccionados`;
}

// Reutilizamos la funci√≥n de descarga ZIP del admin (aseg√∫rate de que el endpoint est√© en main.py)
async function descargarSeleccionados() {
    if(itemsSeleccionados.length === 0) return;
    const btn = document.querySelector('#barraSeleccion button');
    const txt = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    
    const fd = new FormData();
    fd.append('ids', itemsSeleccionados.join(','));
    
    try {
        const res = await fetch(`${baseUrl}/descargar_seleccion_zip`, { method: "POST", body: fd });
        if(!res.ok) throw new Error("Error en descarga");
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = "Mis_Evidencias.zip";
        document.body.appendChild(a); a.click(); a.remove();
        cancelarSeleccion();
    } catch(e) { alert("Error: " + e.message); } 
    finally { btn.innerHTML = txt; }
}
    </script>
</body>
</html>