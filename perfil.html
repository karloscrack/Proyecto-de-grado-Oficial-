<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Perfil Estudiantil - Plataforma de Evidencias Digitales">
    <meta name="theme-color" content="#6A0DAD">
    
    <title>Mi Perfil - Unidad Educativa Despertar</title>
    
    <link rel="icon" type="image/png" href="Img/Logo_pestaña.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        /* ==========================================================================
           1. SISTEMA DE DISEÑO & VARIABLES (DESIGN TOKENS)
           ========================================================================== */
        :root {
            /* --- IDENTIDAD CORPORATIVA --- */
            --primary: #6A0DAD;       /* Morado Institucional */
            --primary-dark: #4a0072;  /* Morado Profundo (Hover) */
            --primary-light: #9d46ff; /* Morado Brillante (Active) */
            --primary-soft: rgba(106, 13, 173, 0.08);
            
            --secondary: #2E8B57;     /* Verde Éxito */
            --secondary-hover: #1e5e3a;
            
            --error: #d32f2f;         /* Rojo Alerta */
            --warning: #f9a825;       /* Amarillo Precaución */
            --info: #0288d1;          /* Azul Información */
            
            /* --- PALETA DE COLORES (MODO CLARO) --- */
            --bg-image: url('Img/Claro.png'); /* Fondo texturizado */
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --bg-header: rgba(255, 255, 255, 0.95);
            --bg-sidebar: #ffffff;
            
            --text-main: #2c3e50;
            --text-sec: #5f6368;
            --text-muted: #9aa0a6;
            --text-inverse: #ffffff;
            
            --border-color: #e0e0e0;
            --input-bg: #f8f9fa;
            
            /* --- SOMBRAS Y PROFUNDIDAD --- */
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
            --shadow-hover: 0 10px 25px rgba(106, 13, 173, 0.15);
            --shadow-card: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-nav: 0 2px 15px rgba(0,0,0,0.05);
            
            /* --- EFECTOS DE VIDRIO (GLASSMORPHISM) --- */
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --glass-backdrop: blur(12px);
            
            /* --- DIMENSIONES --- */
            --header-height: 80px;
            --header-height-mobile: 70px;
            --border-radius: 16px;
            --transition-speed: 0.3s;
            --transition-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* --- CAPAS (Z-INDEX) --- */
            --z-back: -1;
            --z-normal: 1;
            --z-header: 1000;
            --z-dropdown: 1100;
            --z-overlay: 1500;
            --z-sidebar: 2000;
            --z-fab: 3000;
            --z-modal: 5000;
            --z-toast: 6000;
        }

        /* ==========================================================================
           2. MODO OSCURO (DARK MODE)
           ========================================================================== */
        body.dark-mode {
            --bg-image: url('Img/Oscuro.png');
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --bg-header: rgba(30, 30, 30, 0.95);
            --bg-sidebar: #1e1e1e;
            
            --text-main: #e8eaed;
            --text-sec: #b0b3b8;
            --text-muted: #6e7175;
            
            --border-color: #3c4043;
            --input-bg: #2d2d2d;
            
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.4);
            --shadow-hover: 0 10px 30px rgba(0,0,0,0.6);
            
            --glass-bg: rgba(30, 30, 30, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* ==========================================================================
           3. RESET & BASE
           ========================================================================== */
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            outline: none; -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            background-image: var(--bg-image);
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            color: var(--text-main);
            padding-top: var(--header-height);
            transition: background var(--transition-speed), color var(--transition-speed);
            min-height: 100vh;
            display: flex; flex-direction: column;
            overflow-x: hidden;
        }

        a { text-decoration: none; color: inherit; transition: var(--transition-speed); }
        ul { list-style: none; }
        button, input, textarea, select { font-family: inherit; }

        /* Scrollbar Estilizado */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-dark); }

        /* ==========================================================================
           4. HEADER RESTAURADO (DISEÑO ORIGINAL)
           ========================================================================== */
        .main-header {
            position: fixed; top: 0; left: 0; width: 100%;
            height: var(--header-height);
            background: var(--bg-header);
            border-bottom: 3px solid var(--primary);
            box-shadow: var(--shadow-nav);
            z-index: var(--z-header);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 5%;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .logo-container img {
            height: 50px; width: auto;
            transition: transform 0.3s var(--transition-bounce);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        .logo-container img:hover { transform: scale(1.05); }

        .header-actions {
            display: flex; align-items: center; gap: 15px;
        }

        /* Botones Circulares del Header (Tema y Notis) */
        .btn-icon-header {
            background: transparent;
            border: 2px solid var(--primary); /* Borde original */
            color: var(--primary);
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer;
            transition: 0.3s;
            position: relative;
        }
        .btn-icon-header:hover {
            background: var(--primary-soft);
            transform: rotate(15deg);
            box-shadow: 0 0 15px var(--primary-soft);
        }

        /* Badge de Notificaciones - NUEVO: siempre visible si hay notificaciones */
        .noti-badge {
            position: absolute; top: -5px; right: -5px;
            background: var(--error); color: white;
            font-size: 0.7rem; font-weight: 700;
            width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--bg-header);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: popIn 0.3s var(--transition-bounce);
        }

        /* Botón Salir (Estilo Píldora) */
        .btn-logout-header {
            background: var(--error); color: white; border: none;
            padding: 0 25px; height: 42px; border-radius: 50px;
            font-weight: 600; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            transition: 0.3s;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.25);
        }
        .btn-logout-header:hover {
            background: #b71c1c; transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(211, 47, 47, 0.35);
        }

        /* Menú Hamburguesa */
        .menu-toggle {
            background: none; border: none; font-size: 1.8rem;
            color: var(--primary); cursor: pointer;
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .menu-toggle:active { transform: scale(0.9); }

        /* ==========================================================================
           5. NOTIFICACIONES (DROPDOWN) - MEJORADO
           ========================================================================== */
        .notis-dropdown {
            position: absolute; top: 70px; right: 0;
            width: 320px; max-height: 400px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            z-index: var(--z-dropdown);
            display: none; flex-direction: column; overflow: hidden;
            animation: fadeInUp 0.2s ease-out;
        }
        .notis-dropdown.active { display: flex; }

        .notis-header {
            padding: 15px; border-bottom: 1px solid var(--border-color);
            background: var(--input-bg); font-weight: 600;
            display: flex; justify-content: space-between; align-items: center;
            color: var(--text-main); font-size: 0.9rem;
        }
        .notis-header span { 
            color: var(--primary); font-size: 0.8rem; cursor: pointer; letter-spacing: 0.5px;
        }
        
        .notis-body { overflow-y: auto; flex: 1; }
        
        .noti-item {
            padding: 15px; border-bottom: 1px solid var(--border-color);
            transition: 0.2s; cursor: pointer; display: flex; gap: 12px;
            align-items: start; background: var(--bg-card);
        }
        .noti-item:hover { background: var(--input-bg); }
        .noti-item.unread { 
            background: var(--primary-soft); 
            border-left: 3px solid var(--primary);
            animation: pulseUnread 2s infinite;
        }
        
        @keyframes pulseUnread {
            0% { background: var(--primary-soft); }
            50% { background: rgba(106, 13, 173, 0.12); }
            100% { background: var(--primary-soft); }
        }
        
        .noti-icon { 
            width: 32px; height: 32px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.9rem;
        }
        .noti-icon.success { background: rgba(46, 139, 87, 0.1); color: var(--secondary); }
        .noti-icon.error { background: rgba(211, 47, 47, 0.1); color: var(--error); }
        .noti-icon.info { background: rgba(2, 136, 209, 0.1); color: var(--info); }
        .noti-icon.warning { background: rgba(249, 168, 37, 0.1); color: var(--warning); }
        
        .noti-content h4 { margin: 0 0 4px; font-size: 0.9rem; color: var(--text-main); font-weight: 600; }
        .noti-content p { margin: 0 0 6px; font-size: 0.8rem; color: var(--text-sec); line-height: 1.4; }
        .noti-time { font-size: 0.75rem; color: var(--text-muted); }

        /* ==========================================================================
           6. MENÚ LATERAL (SIDEBAR)
           ========================================================================== */
        .side-menu {
            position: fixed; top: 0; right: -320px;
            width: 300px; height: 100vh;
            background: var(--bg-sidebar);
            box-shadow: -5px 0 30px rgba(0,0,0,0.3);
            z-index: var(--z-sidebar);
            transition: right 0.4s cubic-bezier(0.77, 0, 0.175, 1);
            padding: 25px; display: flex; flex-direction: column;
            border-left: 1px solid var(--border-color);
        }
        .side-menu.active { right: 0; }

        .side-menu-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 20px; margin-bottom: 20px;
        }
        .side-menu-header h3 { color: var(--primary); font-size: 1.3rem; margin: 0; font-weight: 700; }
        
        /* BOTÓN CERRAR MENÚ (Estilo Mejorado) */
        .close-menu {
            background: transparent; border: none; font-size: 1.8rem;
            color: var(--text-sec); cursor: pointer;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: all 0.3s var(--transition-bounce);
        }
        .close-menu:hover {
            color: var(--error); background: rgba(211, 47, 47, 0.1);
            transform: rotate(90deg);
        }

        .menu-list { list-style: none; display: flex; flex-direction: column; gap: 10px; flex: 1; }
        .menu-btn {
            width: 100%; text-align: left; background: transparent; border: none;
            padding: 15px 20px; font-size: 1rem; color: var(--text-main);
            border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; gap: 15px; transition: 0.3s;
            font-weight: 500;
        }
        .menu-btn:hover { background: var(--primary-soft); color: var(--primary); transform: translateX(5px); }
        .menu-btn i { width: 25px; text-align: center; color: var(--primary); font-size: 1.2rem; }

        .overlay-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: var(--z-overlay); display: none; opacity: 0; transition: opacity 0.3s;
        }
        .overlay-bg.active { display: block; opacity: 1; }

        /* ==========================================================================
           7. PERFIL & CONTENIDO PRINCIPAL
           ========================================================================== */
        .container {
            width: 95%; max-width: 1250px; margin: 0 auto;
            padding: 40px 20px; flex: 1;
        }

        .profile-card {
            background: var(--bg-card); border-radius: var(--border-radius);
            padding: 40px; box-shadow: var(--shadow-soft);
            display: flex; align-items: center; gap: 40px;
            border: 1px solid var(--border-color); margin-bottom: 40px;
            position: relative; overflow: hidden;
            animation: fadeInUp 0.8s ease-out;
        }
        .profile-card::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 200px; height: 200px; background: var(--primary);
            border-radius: 50%; opacity: 0.05; z-index: 0;
        }

        .profile-img {
            width: 140px; height: 140px; border-radius: 50%;
            object-fit: cover; border: 5px solid var(--bg-body);
            outline: 3px solid var(--primary); background: white; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 1;
        }

        .profile-info { flex: 1; z-index: 1; }
        .profile-info h1 { font-size: 2.2rem; margin-bottom: 5px; color: var(--text-main); font-weight: 700; }
        .profile-info h2 { font-size: 1.1rem; color: var(--text-sec); font-weight: 400; margin-bottom: 15px; }

        .badge-active {
            background: rgba(46, 139, 87, 0.1); color: var(--secondary);
            padding: 8px 16px; border-radius: 30px; font-size: 0.9rem; font-weight: 600;
            display: inline-flex; align-items: center; gap: 8px; border: 1px solid rgba(46, 139, 87, 0.2);
        }

        .btn-contact {
            background: var(--primary); color: white; border: none;
            padding: 14px 30px; border-radius: 50px; font-weight: 600;
            cursor: pointer; transition: 0.3s; z-index: 1;
            display: flex; align-items: center; gap: 10px; font-size: 1rem;
            box-shadow: 0 4px 15px rgba(106, 13, 173, 0.25);
        }
        .btn-contact:hover { background: var(--primary-dark); transform: translateY(-3px); }

        /* ==========================================================================
           8. TOOLBAR Y FILTROS (CORREGIDO OVERFLOW MÓVIL)
           ========================================================================== */
        .toolbar {
            background: var(--bg-card); padding: 15px 25px;
            border-radius: 50px; box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color); margin-bottom: 30px;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px;
            animation: fadeInUp 1s ease-out 0.2s backwards;
            position: relative; z-index: 5;
        }

        /* Scroll horizontal en móvil sin salirse */
        .filter-group { 
            display: flex; gap: 10px; 
            overflow-x: auto; /* Permite scroll */
            padding-bottom: 5px; 
            max-width: 100%; /* Evita desbordamiento */
            white-space: nowrap; /* Evita que los botones bajen */
            -webkit-overflow-scrolling: touch; /* Suavidad en iOS */
            /* Ocultar scrollbar visualmente */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .filter-group::-webkit-scrollbar { display: none; }

        .filter-pill {
            background: var(--input-bg); border: 1px solid var(--border-color);
            color: var(--text-sec); padding: 10px 22px; border-radius: 30px;
            cursor: pointer; font-size: 0.95rem; white-space: nowrap; transition: 0.3s; font-weight: 500;
            flex-shrink: 0; /* Evita que se aplasten */
        }
        .filter-pill:hover, .filter-pill.active {
            background: var(--primary); color: white; border-color: var(--primary);
            transform: translateY(-2px); box-shadow: 0 4px 12px rgba(106, 13, 173, 0.2);
        }

        .btn-select-desktop {
            background: transparent; border: 2px solid var(--primary);
            color: var(--primary); padding: 8px 24px; border-radius: 30px;
            font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 10px;
            transition: 0.3s;
        }
        .btn-select-desktop:hover, .btn-select-desktop.active { background: var(--primary); color: white; }

        /* FAB SELECTION (Solo Desktop ahora) */
        .fab-selection {
            position: fixed; bottom: 40px; right: 40px;
            width: 60px; height: 60px; background: var(--primary); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 10px 25px rgba(106, 13, 173, 0.4);
            cursor: pointer; z-index: var(--z-fab); transform: translateY(150px); opacity: 0;
            transition: all 0.4s var(--transition-bounce); border: 2px solid white;
        }
        .fab-selection.visible { transform: translateY(0); opacity: 1; }
        .fab-selection:hover { transform: translateY(-5px) scale(1.1); background: var(--primary-dark); }
        .fab-selection.hidden { transform: scale(0); opacity: 0; }

        /* ==========================================================================
           9. GRID DE EVIDENCIAS
           ========================================================================== */
        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px; min-height: 300px; padding-bottom: 120px; position: relative;
        }

        .evidence-card {
            background: var(--bg-card); border-radius: 12px;
            overflow: hidden; aspect-ratio: 1; position: relative;
            cursor: pointer; box-shadow: var(--shadow-soft);
            border: 2px solid transparent;
            transition: transform 0.3s var(--transition-bounce), box-shadow 0.3s;
            user-select: none;
        }
        .evidence-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-hover); z-index: 2; }
        
        .card-media { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; pointer-events: none; }
        .evidence-card:hover .card-media { transform: scale(1.05); }

        .video-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            display:flex; align-items:center; justify-content:center;
            color: white; font-size: 3rem; background: rgba(0,0,0,0.3); opacity: 0.8; transition: 0.3s;
        }
        .evidence-card:hover .video-overlay { background: rgba(0,0,0,0.1); opacity: 1; }

        .selection-check {
            position: absolute; top: 12px; right: 12px; width: 28px; height: 28px;
            background: rgba(255,255,255,0.95); border: 2px solid #ccc;
            border-radius: 50%; color: var(--primary); display: none; 
            align-items: center; justify-content: center; z-index: 10; font-size: 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .evidence-card.selected { border-color: var(--primary); transform: scale(0.95); background: var(--primary-soft); }
        .evidence-card.selected .selection-check { display: flex; background: var(--primary); color: white; border-color: var(--primary); }
        .selection-mode-active .selection-check { display: flex; }

        .empty-state {
            grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 60px 20px; color: var(--text-sec); display: none;
            animation: fadeIn 0.5s; min-height: 300px;
        }
        .empty-state i { font-size: 5rem; opacity: 0.2; margin-bottom: 25px; color: var(--text-main); }
        .empty-state h3 { font-size: 1.5rem; margin-bottom: 10px; }

        /* ==========================================================================
           10. LIGHTBOX & BARRA FLOTANTE
           ========================================================================== */
        .lightbox-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); backdrop-filter: var(--glass-backdrop);
            z-index: var(--z-modal); display: none;
            justify-content: center; align-items: center; flex-direction: column;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .lightbox-modal.active { display: flex; opacity: 1; }

        .lb-content-wrapper {
            position: relative; width: 100%; height: 80%;
            display: flex; justify-content: center; align-items: center; pointer-events: none; 
        }
        .lb-media-item {
            max-width: 90%; max-height: 100%; border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); object-fit: contain;
            pointer-events: auto; animation: popIn 0.4s var(--transition-bounce);
        }

        .lb-close-fixed {
            position: absolute; top: 30px; right: 30px;
            background: rgba(255,255,255,0.15); color: white; border: none;
            padding: 12px 24px; border-radius: 30px; font-weight: bold;
            cursor: pointer; z-index: 5005; display: flex; align-items: center; gap: 10px;
            transition: 0.3s; backdrop-filter: blur(5px);
        }
        .lb-close-fixed:hover { background: var(--error); transform: scale(1.05); }

        .lb-nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 70px; height: 70px; background: rgba(255,255,255,0.08);
            color: white; border: none; border-radius: 50%; font-size: 2rem;
            cursor: pointer; z-index: 5005; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .lb-nav-btn:hover { background: var(--primary); transform: translateY(-50%) scale(1.1); }
        .lb-prev { left: 40px; }
        .lb-next { right: 40px; }

        .lb-actions-panel {
            margin-top: 25px; display: flex; gap: 20px; z-index: 5005; 
            pointer-events: auto; flex-wrap: wrap; justify-content: center;
        }
        .btn-lb-action {
            padding: 12px 30px; border-radius: 30px; font-weight: bold;
            cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 10px;
            border: none; font-size: 1rem; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-lb-action:hover { transform: translateY(-3px); }
        .btn-lb-report {
            background: var(--error); color: white; border: none;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4);
        }
        .btn-lb-report:hover { background: #b71c1c; box-shadow: 0 6px 20px rgba(211, 47, 47, 0.6); }

        .floating-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 150%);
            background: #222; color: white; padding: 15px 30px; border-radius: 50px;
            display: flex; align-items: center; gap: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.6); z-index: var(--z-fab);
            width: 90%; max-width: 650px; transition: transform 0.4s var(--transition-bounce);
        }
        .floating-bar.active { transform: translate(-50%, 0); }

        .btn-float {
            background: var(--primary); color: white; border: none;
            padding: 10px 24px; border-radius: 25px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; gap: 10px; font-size: 0.95rem; transition: 0.3s;
        }
        .btn-float:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-float.danger { background: var(--error); }
        .btn-float-cancel {
            background: transparent; border: 1px solid #666; color: #ccc;
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.3s;
        }
        .btn-float-cancel:hover { border-color: white; color: white; }

        /* ==========================================================================
           11. MODALES & FOOTER
           ========================================================================== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: var(--z-modal); display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s forwards; }

        .modal-card {
            background: var(--bg-card); width: 90%; max-width: 480px;
            border-radius: 20px; padding: 35px;
            position: relative; box-shadow: 0 30px 80px rgba(0,0,0,0.5);
            border-top: 5px solid var(--primary); text-align: center;
            animation: popIn 0.4s ease-out;
        }

        /* DISEÑO COMPACTO PARA EL HUB DE CONTACTO */
        .hub-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 25px; 
        }
        .hub-btn {
            background: var(--input-bg); border: 1px solid var(--border-color);
            padding: 15px 5px; border-radius: 12px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            transition: 0.3s; color: var(--text-main); height: 100%; justify-content: center;
        }
        .hub-btn i { font-size: 1.6rem; color: var(--primary); transition: 0.3s; }
        .hub-btn h4 { margin: 0; font-size: 0.85rem; font-weight: 600; line-height: 1.2; }
        .hub-btn:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 8px 15px rgba(106, 13, 173, 0.2); }
        .hub-btn:hover i { color: white; }

        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; }
        .form-control { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--input-bg); color: var(--text-main); font-size: 1rem; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(106,13,173,0.1); }
        .btn-submit { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1.05rem; transition: 0.3s; }
        .btn-submit:hover { background: var(--primary-dark); transform: translateY(-2px); }
        
        /* FOOTER */
        footer {
            background: #1a1a1a; color: white; padding: 30px 20px;
            text-align: center; margin-top: auto; border-top: 4px solid var(--primary);
        }
        .footer-logo Img { height: 60px; margin-bottom: 10px; }
        .footer-social { margin: 20px 0; }
        .footer-social a { 
            display: inline-flex; width: 40px; height: 40px; 
            background: #333; color: white; border-radius: 50%; 
            align-items: center; justify-content: center; margin: 0 8px; 
            text-decoration: none; transition: 0.3s;
        }
        .footer-social a:hover { background: var(--primary); transform: translateY(-3px); }
        .footer-links a { color: #aaa; text-decoration: none; margin: 0 10px; }
        .footer-links a:hover { color: var(--primary); }
        .copyright { font-size: 0.85rem; color: #888; border-top: 1px solid #333; padding-top: 15px; }

        /* ==========================================================================
           12. ANIMACIONES
           ========================================================================== */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ==========================================================================
           13. RESPONSIVE
           ========================================================================== */
        @media (max-width: 768px) {
            /* HEADER MÓVIL (Con botón de tema visible) */
            .main-header { height: var(--header-height-mobile); padding: 0 15px; }
            .header-actions { gap: 8px; }
            
            /* Ajuste de logo */
            .logo-container img { height: 40px; }
            
            /* Ocultar solo el texto de Salir, mantener icono */
            .btn-logout-header span { display: none; }
            .btn-logout-header { padding: 0 15px; }

            /* Grid Móvil */
            .container { padding: 20px 15px; }
            .gallery-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            
            /* Ajuste Perfil */
            .profile-card { flex-direction: column; text-align: center; padding: 25px 15px; gap: 20px; }
            .profile-card::before { display: none; }
            .btn-contact { width: 100%; justify-content: center; }

            /* Toolbar y Filtros */
            .toolbar { justify-content: center; gap: 15px; padding: 15px; border-radius: 12px; }
            
            /* OCULTAR FAB en móvil (Long press preferido) */
            .fab-selection { display: none !important; }
            
            /* Ocultar botón "Seleccionar" de escritorio */
            .btn-select-desktop { display: none; }

            /* Notificaciones Full Width */
            .notis-dropdown {
                position: fixed; top: var(--header-height-mobile); left: 0; right: 0;
                width: 100%; max-height: 60vh; border-radius: 0 0 15px 15px;
                border: none; border-bottom: 1px solid var(--border-color);
                box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            }

            /* Lightbox Táctil */
            .lb-nav-btn { display: none; } 
            .lb-close-fixed { top: 15px; right: 15px; padding: 8px 15px; font-size: 0.9rem; background: rgba(0,0,0,0.6); }
            .lb-media-item { max-width: 100%; border-radius: 0; }
            .lb-actions-panel { flex-direction: column; width: 90%; gap: 12px; }
            .btn-lb-action, .btn-lb-report { width: 100%; justify-content: center; }

            /* Barra Flotante Acción */
            .floating-bar { 
                flex-direction: column; width: 100%; border-radius: 20px 20px 0 0;
                padding: 20px; gap: 15px; bottom: 0; left: 0; transform: translateY(100%); max-width: 100%;
            }
            .floating-bar.active { transform: translateY(0); }
            .floating-bar div { text-align: center; width: 100%; margin-bottom: 5px; }
            .btn-float { width: 100%; justify-content: center; }
            
            /* Ajuste Hub Movil */
            .hub-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .hub-btn h4 { font-size: 0.75rem; }
            .hub-btn i { font-size: 1.4rem; }
        }
    </style>
</head>

<body class="profile-page">

    <header class="main-header">
        <div class="logo-container">
            <a href="index.html">
                <img src="Img/Logo-Despertar-SKAS-Unidad-Educativa23.png" alt="Logo">
            </a>
        </div>
        <div class="header-actions">
            <button onclick="toggleTheme()" class="btn-icon-header" id="themeBtn" title="Cambiar Tema">
                <i class="fas fa-moon"></i>
            </button>

            <div style="position:relative;">
                <button class="btn-icon-header" onclick="toggleNotificaciones()" title="Notificaciones">
                    <i class="fas fa-bell"></i>
                    <!-- NOTA: El badge ahora se muestra siempre si hay notificaciones no leídas -->
                    <span id="notisBadge" class="noti-badge" style="display:none;">0</span>
                </button>
                <div class="notis-dropdown" id="notisDropdown">
                    <div class="notis-header">
                        Notificaciones
                        <span id="markReadBtn" onclick="marcarTodasLeidas()">Marcar leídas</span>
                    </div>
                    <div class="notis-body" id="notisList"></div>
                </div>
            </div>

            <button onclick="cerrarSesion()" class="btn-logout-header" title="Cerrar Sesión">
                <i class="fas fa-sign-out-alt"></i> <span>Salir</span>
            </button>

            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <div class="overlay-bg" id="overlayMenu"></div>
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h3><i class="fas fa-user-graduate"></i> Menú</h3>
            <button class="close-menu" id="closeMenu" title="Cerrar Menú">&times;</button>
        </div>
        <ul class="menu-list">
            <li><button class="menu-btn" onclick="location.reload()"><i class="fas fa-id-card"></i> Mi Perfil</button></li>
            <li><button class="menu-btn" onclick="window.location.href='index.html'"><i class="fas fa-home"></i> Inicio</button></li>
            <li><button class="menu-btn" onclick="abrirHubContacto()"><i class="fas fa-headset"></i> Soporte / Contacto</button></li>
            <li style="margin-top:auto; border-top:1px solid var(--border-color); padding-top:20px;">
                <button class="menu-btn" onclick="cerrarSesion()" style="color:var(--error); font-weight:700;">
                    <i class="fas fa-power-off"></i> Cerrar Sesión
                </button>
            </li>
        </ul>
    </div>

    <div class="container">
        <div class="profile-card">
            <img id="profilePhoto" src="https://via.placeholder.com/150" alt="Foto Perfil" class="profile-img" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiB2aWV3Qm94PSIwIDAgMTUwIDE1MCI+PHJlY3Qgd2lkdGg9IjE1MCIgaGVpZ2h0PSIxNTAiIGZpbGw9IiNGRUZFRkUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiPlNpbiBGb3RvPC90ZXh0Pjwvc3ZnPg=='">
            <div class="profile-info">
                <h1 id="userNameDisplay">Cargando datos...</h1>
                <h2 id="userCedulaDisplay">Verificando...</h2>
                <div class="badge-active"><i class="fas fa-check-circle"></i> Cuenta Verificada</div>
            </div>
            <button class="btn-contact" onclick="abrirHubContacto()">
                <i class="fas fa-envelope-open-text"></i> Contactar Admin
            </button>
        </div>

        <div class="toolbar" id="mainToolbar">
            <div class="filter-group">
                <button class="filter-pill active" onclick="filtrarGaleria('todo', this)">Todo</button>
                <button class="filter-pill" onclick="filtrarGaleria('foto', this)">Fotos</button>
                <button class="filter-pill" onclick="filtrarGaleria('video', this)">Videos</button>
                <button class="filter-pill" onclick="filtrarGaleria('documento', this)">Docs</button>
            </div>
            <button class="btn-select-desktop" id="btnSelectMode" onclick="toggleModoSeleccion()">
                <i class="fas fa-check-square"></i> Seleccionar
            </button>
        </div>

        <div id="galleryContainer" class="gallery-grid"></div>

        <div id="emptyState" class="empty-state">
            <i class="fas fa-layer-group"></i>
            <h3>No tienes evidencias en esta categoría.</h3>
            <p>Si crees que es un error, contacta al administrador.</p>
        </div>
    </div>

    <button id="floatingSelectBtn" class="fab-selection" onclick="toggleModoSeleccion()" title="Modo Selección">
        <i class="fas fa-check-square"></i>
    </button>

    <div id="floatingBar" class="floating-bar">
        <div style="flex:1;">
            <span style="color:#aaa; font-size:0.8rem; letter-spacing:1px;">SELECCIONADOS</span><br>
            <strong style="font-size:1.2rem;"><span id="countSelection" style="color:var(--secondary);">0</span> archivos</strong>
        </div>
        <button class="btn-float" onclick="descargarSeleccionados()"><i class="fas fa-download"></i> Descargar</button>
        <button class="btn-float danger" onclick="reportarSeleccionados()"><i class="fas fa-flag"></i> Reportar</button>
        <button class="btn-float-cancel" onclick="cancelarSeleccion()" title="Cancelar">&times;</button>
    </div>

    <div class="lightbox-modal" id="lightbox" onclick="handleClickFondo(event)">
        <button class="lb-close-fixed" onclick="closeLightbox()"><i class="fas fa-times"></i> Cerrar</button>
        <button class="lb-nav-btn lb-prev" onclick="prevImage(event)" title="Anterior"><i class="fas fa-chevron-left"></i></button>
        <button class="lb-nav-btn lb-next" onclick="nextImage(event)" title="Siguiente"><i class="fas fa-chevron-right"></i></button>
        <div class="lb-content-wrapper" id="lightboxContent"></div>
        <div class="lb-actions-panel">
            <a id="lbDownloadLink" href="#" target="_blank" download class="btn-lb-action" style="background:white; color:black;"><i class="fas fa-download"></i> Descargar</a>
            <button class="btn-lb-action btn-lb-report" onclick="reportarEvidenciaActual()"><i class="fas fa-flag"></i> Reportar / No soy yo</button>
        </div>
    </div>

    <div class="modal-overlay" id="modalContactHub">
        <div class="modal-card">
            <button onclick="cerrarModal('modalContactHub')" style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:1.5rem; cursor:pointer; color:var(--text-sec);">&times;</button>
            <h3 style="color:var(--primary); margin-bottom:20px; font-size:1.4rem;"><i class="fas fa-headset"></i> Centro de Ayuda</h3>
            <p style="color:var(--text-sec); font-size:0.9rem; margin-bottom:20px;">Selecciona el motivo de tu consulta:</p>
            <div class="hub-grid">
                <button class="hub-btn" onclick="cambiarModal('modalContactHub', 'modalUpload')"><i class="fas fa-cloud-upload-alt"></i> <h4>Subir</h4></button>
                <button class="hub-btn" onclick="cambiarModal('modalContactHub', 'modalReport')"><i class="fas fa-bug"></i> <h4>Error</h4></button>
                <button class="hub-btn" onclick="cambiarModal('modalContactHub', 'modalProblem')"><i class="fas fa-user-shield"></i> <h4>Cuenta</h4></button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalUpload">
        <div class="modal-card">
            <h3 style="color:var(--primary);">Subir Evidencia</h3>
            <form onsubmit="enviarSolicitud(event, 'SUBIDA')">
                <div class="form-group"><label>Archivo</label><input type="file" id="fileUpload" class="form-control" required></div>
                <button type="submit" class="btn-submit">Enviar para Revisión</button>
                <button type="button" class="btn-submit" onclick="cambiarModal('modalUpload', 'modalContactHub')" style="background:transparent; color:#666; border:1px solid #ddd;">Volver</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modalReport">
        <div class="modal-card">
            <h3 style="color:var(--error);">Reportar Error</h3>
            <form onsubmit="enviarSolicitud(event, 'ERROR')">
                <div class="form-group">
                    <label>Describe el error:</label>
                    <textarea id="descError" class="form-control" rows="4" placeholder="Incluye tu email o teléfono aquí para contactarte." required></textarea>
                </div>
                <button type="submit" class="btn-submit" style="background:var(--error);">Enviar Reporte</button>
                <button type="button" class="btn-submit" onclick="cambiarModal('modalReport', 'modalContactHub')" style="background:transparent; color:#666; border:1px solid #ddd;">Volver</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modalProblem">
        <div class="modal-card">
            <h3 style="color:var(--warning);">Problema Cuenta</h3>
            <form onsubmit="enviarSolicitud(event, 'PROBLEMA')">
                <div class="form-group">
                    <label>Detalles del problema:</label>
                    <textarea id="descProblem" class="form-control" rows="4" placeholder="Ej: No puedo ver mis fotos. (Incluye tu contacto)" required></textarea>
                </div>
                <button type="submit" class="btn-submit" style="background:var(--warning); color:black;">Enviar Solicitud</button>
                <button type="button" class="btn-submit" onclick="cambiarModal('modalProblem', 'modalContactHub')" style="background:transparent; color:#666; border:1px solid #ddd;">Volver</button>
            </form>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <Img src="Img/Logo-Despertar-SKAS-Unidad-Educativa23.png" alt="Logo">
                <h3>Unidad Educativa Particular Despertar</h3>
            </div>
            <div class="footer-links" style="margin-bottom:20px;">
                <a href="https://uepdespertar.edu.ec/nosotros/" target="_blank">Sobre Nosotros</a>
            </div>
            <div class="footer-social">
                <a href="https://www.facebook.com/uepdespertar"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.youtube.com/@DespertarSKAS"><i class="fab fa-youtube"></i></a>
                <a href="https://www.instagram.com/skas_despertar"><i class="fab fa-instagram"></i></a>
            </div>
            <div class="copyright">
                <p>© 2025 Plataforma Educativa - Unidad Educativa Particular Despertar.</p>
            </div>
        </div>
    </footer>

    <script>
        // URL DE PRODUCCIÓN
        const API_URL = "https://proyecto-de-grado-oficial-production.up.railway.app";
        
        let appState = {
            galeria: [], 
            filtrada: [], 
            seleccionados: [],
            modoSeleccion: false, 
            indiceLightbox: 0, 
            notificaciones: [],
            solicitudesEstudiante: []
        };

        // Variables para Swipe y Long Press
        let pressTimer, isPressing = false;
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                initTheme();
                verificarAuth();
                document.getElementById('menuToggle').onclick = toggleMenu;
                document.getElementById('closeMenu').onclick = toggleMenu;
                document.getElementById('overlayMenu').onclick = toggleMenu;
                window.addEventListener('scroll', handleScroll);
                
                // Inicializar navegación del Lightbox
                setupLightboxNavigation(); 
            } catch (error) { console.error("Error init:", error); }
        });

        // =========================================================================
        // 1. GESTIÓN DE NOTIFICACIONES Y DATOS - MEJORADO
        // =========================================================================
        
        function verificarAuth() {
            const cedula = localStorage.getItem('usuario_cedula');
            if (!cedula) return window.location.href = 'index.html';
            cargarDatos(cedula);
        }

        async function cargarDatos(cedula) {
            const fd = new FormData();
            fd.append('cedula', cedula);
            // Si existe contraseña guardada, la enviamos (opcional según backend)
            if(localStorage.getItem('usuario_contrasena')) fd.append('contrasena', localStorage.getItem('usuario_contrasena'));
            
            try {
                const res = await fetch(`${API_URL}/buscar_estudiante`, { method: "POST", body: fd });
                const data = await res.json();
                
                if (data.encontrado) {
                    actualizarUI(data.datos);
                    // Cargar notificaciones del estudiante (incluyendo respuestas a solicitudes)
                    await cargarNotificacionesEstudiante(cedula);
                } else { 
                    alert("Sesión expirada o usuario no encontrado"); 
                    cerrarSesion(); 
                }
            } catch (e) { 
                console.error("Error conexión:", e);
                alert("Error de conexión con el servidor. Verifica tu internet."); 
            }
        }

        function actualizarUI(datos) {
            document.getElementById('userNameDisplay').textContent = `${datos.nombre.split(' ')[0]} ${datos.apellido.split(' ')[0]}`;
            document.getElementById('userCedulaDisplay').textContent = `C.I: ${datos.cedula || localStorage.getItem('usuario_cedula')}`;
            if(datos.url_foto) document.getElementById('profilePhoto').src = datos.url_foto;
            
            // Mapeo de evidencias
            appState.galeria = (datos.galeria || []).map(item => ({
                id: item.id, 
                url: item.url || item.url_foto, 
                tipo: obtenerTipo(item.url || item.url_foto)
            }));
            filtrarGaleria('todo');
        }

        async function cargarNotificacionesEstudiante(cedula) {
            try {
                // Cargar solicitudes del estudiante para ver respuestas
                const resSolicitudes = await fetch(`${API_URL}/obtener_solicitudes_por_cedula?cedula=${cedula}`);
                if (resSolicitudes.ok) {
                    const solicitudes = await resSolicitudes.json();
                    appState.solicitudesEstudiante = solicitudes;
                    
                    // Generar notificaciones a partir de las solicitudes
                    generarNotificacionesDesdeSolicitudes(solicitudes);
                } else {
                    // Si no hay endpoint específico, generamos notificaciones básicas
                    generarNotificacionesBasicas();
                }
            } catch (error) {
                console.error("Error cargando solicitudes:", error);
                generarNotificacionesBasicas();
            }
        }

        function generarNotificacionesDesdeSolicitudes(solicitudes) {
            appState.notificaciones = [];
            
            // 1. Bienvenida
            appState.notificaciones.push({
                id: 0,
                titulo: "Bienvenido/a",
                mensaje: "Tu perfil está activo.",
                tipo: "info",
                fecha: "Hoy",
                leida: true
            });
            
            const mensajesVistos = new Set();

            solicitudes.forEach((solicitud, index) => {
                let tipo = "info";
                let titulo = "Estado de Solicitud";
                let mensajeBase = "";
                
                // Extraer la respuesta del admin (Maneja mayúsculas/minúsculas por si acaso)
                const respuestaAdmin = solicitud.Respuesta || solicitud.respuesta || '';

                if (solicitud.Estado === 'APROBADA') {
                    tipo = "success";
                    titulo = "¡Solicitud Aprobada!";
                    mensajeBase = `Tu solicitud "${solicitud.Tipo.replace(/_/g, ' ')}" fue ACEPTADA.`;
                } else if (solicitud.Estado === 'RECHAZADA') {
                    tipo = "error";
                    titulo = "Solicitud Rechazada";
                    mensajeBase = `Tu solicitud "${solicitud.Tipo.replace(/_/g, ' ')}" fue DENEGADA.`;
                } else if (solicitud.Estado === 'PENDIENTE') {
                    tipo = "warning";
                    titulo = "En Revisión";
                    mensajeBase = `Tu solicitud "${solicitud.Tipo.replace(/_/g, ' ')}" está siendo revisada.`;
                }
                
                // Construir el mensaje final CON la respuesta del admin visible
                let mensajeFinal = mensajeBase;
                if (respuestaAdmin) {
                    // Agregamos un salto de línea y un icono de comentario para resaltar la respuesta
                    mensajeFinal += `<br><br><strong>💬 Admin dice:</strong> <em>"${respuestaAdmin}"</em>`;
                } else if (solicitud.Estado === 'RECHAZADA') {
                    mensajeFinal += `<br><br><em>(Sin comentarios del admin)</em>`;
                }

                // Evitar duplicados
                const firmaUnica = `${solicitud.Tipo}-${solicitud.Estado}-${respuestaAdmin}`;

                if (mensajeBase && !mensajesVistos.has(firmaUnica)) {
                    mensajesVistos.add(firmaUnica);
                    
                    appState.notificaciones.push({
                        id: index + 1,
                        titulo: titulo,
                        mensaje: mensajeFinal, // Aquí va el mensaje con HTML (br, strong)
                        tipo: tipo,
                        fecha: formatearFechaCorta(solicitud.Fecha),
                        leida: false
                    });
                }
            });
            
            renderNotificaciones();
        }
        
        // Asegúrate de que renderNotificaciones use .innerHTML en lugar de .textContent para que se vean las negritas
        function renderNotificaciones() {
            const lista = document.getElementById('notisList');
            const badge = document.getElementById('notisBadge');
            const noLeidas = appState.notificaciones.filter(n => !n.leida).length;
            
            if (noLeidas > 0) {
                badge.style.display = 'flex';
                badge.textContent = noLeidas;
            } else {
                badge.style.display = 'none';
            }
            
            lista.innerHTML = '';
            
            if(appState.notificaciones.length === 0) {
                lista.innerHTML = `<div style="padding:20px;text-align:center;color:#999;">Sin notificaciones</div>`;
                return;
            }

            appState.notificaciones.forEach(notis => {
                const item = document.createElement('div');
                item.className = `noti-item ${notis.leida ? '' : 'unread'}`;
                
                let iconClass = notis.tipo; 
                let iconSymbol = notis.tipo === 'success' ? '<i class="fas fa-check"></i>' : 
                                 notis.tipo === 'error' ? '<i class="fas fa-times"></i>' : 
                                 '<i class="fas fa-info"></i>';
                
                // Usamos innerHTML en el párrafo para que se renderice el <br> y <strong>
                item.innerHTML = `
                    <div class="noti-icon ${iconClass}">${iconSymbol}</div>
                    <div class="noti-content" style="width:100%;">
                        <h4>${notis.titulo}</h4>
                        <p style="white-space: pre-wrap;">${notis.mensaje}</p>
                        <span class="noti-time">${notis.fecha}</span>
                    </div>`;
                lista.appendChild(item);
            });
        }

        // Función auxiliar para fechas cortas en notificaciones
        function formatearFechaCorta(fechaString) {
            if (!fechaString) return "Reciente";
            const fecha = new Date(fechaString);
            return fecha.toLocaleDateString();
        }

        function generarNotificacionesBasicas() {
            appState.notificaciones = [];
            
            if (appState.galeria.length > 0) {
                appState.notificaciones.push({
                    id: 1,
                    titulo: "Datos Sincronizados",
                    mensaje: `Tienes ${appState.galeria.length} evidencias aprobadas y visibles.`,
                    tipo: "success",
                    fecha: "Ahora",
                    leida: false
                });
            } else {
                appState.notificaciones.push({
                    id: 0,
                    titulo: "Bienvenido",
                    mensaje: "Tu perfil está activo. Aún no tienes evidencias aprobadas.",
                    tipo: "info",
                    fecha: "Ahora",
                    leida: false
                });
            }
            renderNotificaciones();
        }

        function renderNotificaciones() {
            const lista = document.getElementById('notisList');
            const badge = document.getElementById('notisBadge');
            const noLeidas = appState.notificaciones.filter(n => !n.leida).length;
            
            // Actualizar badge - siempre visible si hay notificaciones no leídas
            if (noLeidas > 0) {
                badge.style.display = 'flex';
                badge.textContent = noLeidas;
            } else {
                badge.style.display = 'none';
            }
            
            lista.innerHTML = '';
            
            if(appState.notificaciones.length === 0) {
                lista.innerHTML = `<div class="notis-empty" style="padding:20px;text-align:center;color:#999;"><i class="fas fa-bell-slash" style="font-size:2rem;margin-bottom:10px;"></i><p>Sin notificaciones</p></div>`;
                return;
            }

            appState.notificaciones.forEach(notis => {
                const item = document.createElement('div');
                item.className = `noti-item ${notis.leida ? '' : 'unread'}`;
                
                // Determinar clase CSS para el icono según tipo
                let iconClass = '';
                let iconSymbol = '';
                
                switch(notis.tipo) {
                    case 'success':
                        iconClass = 'success';
                        iconSymbol = '<i class="fas fa-check"></i>';
                        break;
                    case 'error':
                        iconClass = 'error';
                        iconSymbol = '<i class="fas fa-times"></i>';
                        break;
                    case 'warning':
                        iconClass = 'warning';
                        iconSymbol = '<i class="fas fa-exclamation-triangle"></i>';
                        break;
                    default:
                        iconClass = 'info';
                        iconSymbol = '<i class="fas fa-info"></i>';
                }
                
                item.innerHTML = `<div class="noti-icon ${iconClass}">${iconSymbol}</div>
                                  <div class="noti-content">
                                    <h4>${notis.titulo}</h4>
                                    <p>${notis.mensaje}</p>
                                    <span class="noti-time">${notis.fecha}</span>
                                  </div>`;
                lista.appendChild(item);
            });
        }

        function toggleNotificaciones() { 
            document.getElementById('notisDropdown').classList.toggle('active'); 
        }
        
        function marcarTodasLeidas() {
            appState.notificaciones.forEach(n => n.leida = true);
            renderNotificaciones();
            
            // Ocultar el badge después de marcar todas como leídas
            document.getElementById('notisBadge').style.display = 'none';
        }

        // =========================================================================
        // 2. LÓGICA DE DESCARGAS Y FORMULARIOS (CONECTADO AL BACKEND)
        // =========================================================================

        async function descargarSeleccionados() {
            if (appState.seleccionados.length === 0) return alert("Selecciona al menos un archivo.");
            
            const btn = document.querySelector('.btn-float');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            
            try {
                const formData = new FormData();
                formData.append('ids', appState.seleccionados.join(','));

                // Endpoint de main.py: /descargar_seleccion_zip
                const res = await fetch(`${API_URL}/descargar_seleccion_zip`, {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Evidencias_Seleccion_${new Date().getTime()}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    cancelarSeleccion(); // Salir del modo selección tras descargar
                } else {
                    const errorData = await res.json();
                    alert("Error descargando: " + (errorData.detail || "Error desconocido"));
                }
            } catch (error) {
                console.error(error);
                alert("Error de red al intentar descargar.");
            } finally {
                btn.innerHTML = originalText;
            }
        }

        async function enviarSolicitud(e, tipo) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        btn.innerText = "Enviando...";
        btn.disabled = true;

        const cedula = localStorage.getItem('usuario_cedula');
        const formData = new FormData();
        formData.append('cedula', cedula);

        let endpoint = "";

        try {
            if (tipo === 'SUBIDA') {
                const fileInput = document.getElementById('fileUpload');
                if(fileInput.files.length > 0) {
                    formData.append('archivo', fileInput.files[0]);
                    endpoint = "/solicitar_subida";
                } else { throw new Error("Selecciona un archivo"); }
            } 
            else if (tipo === 'ERROR' || tipo === 'PROBLEMA') {
                const desc = tipo === 'ERROR' ? document.getElementById('descError').value : document.getElementById('descProblem').value;
                formData.append('email', ""); // Email opcional (admin responderá al del perfil)
                formData.append('mensaje', `${tipo}: ${desc}`);
                endpoint = "/solicitar_recuperacion"; // Usamos este endpoint como genérico para mensajes
            }

            const res = await fetch(`${API_URL}${endpoint}`, { method: 'POST', body: formData });
            const data = await res.json();

            if (data.status === "ok" || data.mensaje) {
                alert("✅ Solicitud enviada correctamente.");
                if(tipo === 'SUBIDA') cerrarModal('modalUpload');
                else cerrarModal('modalContactHub');
            } else {
                alert("❌ Error: " + (data.mensaje || "No se pudo enviar"));
            }

        } catch (error) {
            console.error(error);
            alert("❌ Ocurrió un error.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
        
        // Reportar evidencia individual (desde Lightbox)
        async function reportarEvidenciaActual() {
            const item = appState.filtrada[appState.indiceLightbox];
            if(!confirm("¿Deseas reportar esta evidencia como errónea o que no te pertenece?")) return;
            
            const cedula = localStorage.getItem('usuario_cedula');
            const fd = new FormData();
            fd.append('cedula', cedula);
            fd.append('id_evidencia', item.id);
            fd.append('motivo', "Reporte desde visor: No soy yo / Error");

            try {
                // Endpoint: /reportar_evidencia
                const res = await fetch(`${API_URL}/reportar_evidencia`, { method: 'POST', body: fd });
                const data = await res.json();
                if(data.status === 'ok') {
                    alert("✅ Reporte enviado correctamente.");
                    
                    // Agregar notificación local
                    appState.notificaciones.unshift({
                        id: Date.now(),
                        titulo: "Reporte de evidencia enviado",
                        mensaje: "Tu reporte ha sido enviado al administrador para revisión.",
                        tipo: "info",
                        fecha: "Ahora",
                        leida: false
                    });
                    
                    renderNotificaciones();
                }
                else alert("❌ Error enviando reporte.");
            } catch(e) { alert("❌ Error de conexión"); }
        }

        // =========================================================================
        // 3. UTILIDADES GALERÍA Y VISUALIZACIÓN
        // =========================================================================
        
        function obtenerTipo(url) {
            if(!url) return 'documento';
            const ext = url.split('?')[0].split('.').pop().toLowerCase();
            if(['jpg','jpeg','png','webp','gif'].includes(ext)) return 'imagen';
            if(['mp4','webm','mov'].includes(ext)) return 'video';
            return 'documento';
        }

        function filtrarGaleria(filtro, btn) {
            if(btn) {
                document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            appState.filtrada = filtro === 'todo' ? [...appState.galeria] : appState.galeria.filter(i => i.tipo === (filtro === 'foto' ? 'imagen' : filtro));
            renderGrid();
        }

        function renderGrid() {
            const container = document.getElementById('galleryContainer');
            container.innerHTML = '';
            document.getElementById('emptyState').style.display = appState.filtrada.length === 0 ? 'flex' : 'none';

            appState.filtrada.forEach((item, idx) => {
                const card = document.createElement('div');
                const isSelected = appState.seleccionados.includes(item.id);
                card.id = `ev-card-${item.id}`;
                card.className = `evidence-card ${isSelected ? 'selected' : ''} animate-enter`;
                card.style.animationDelay = `${idx * 40}ms`;
                
                card.onclick = () => handleClick(item.id, idx);
                // Eventos Touch para selección (Long Press)
                card.addEventListener('touchstart', (e) => handleTouchStart(e, item.id), {passive: true});
                card.addEventListener('touchend', handleTouchEnd);
                card.addEventListener('touchmove', handleTouchMove);

                let content = item.tipo === 'imagen' ? `<img src="${item.url}" class="card-media" loading="lazy">` :
                              item.tipo === 'video' ? `<video src="${item.url}#t=0.1" class="card-media"></video><div class="video-overlay"><i class="fas fa-play-circle"></i></div>` :
                              `<div style="width:100%;height:100%;background:#f4f4f4;display:flex;align-items:center;justify-content:center;color:#666;"><i class="fas fa-file-alt" style="font-size:2.5rem;"></i></div>`;

                card.innerHTML = `<div class="selection-check"><i class="fas fa-check"></i></div>${content}`;
                container.appendChild(card);
            });
            container.classList[appState.modoSeleccion ? 'add' : 'remove']('selection-mode-active');
        }

        function toggleItemSeleccion(id) {
            const idx = appState.seleccionados.indexOf(id);
            const el = document.getElementById(`ev-card-${id}`);
            if(idx === -1) { appState.seleccionados.push(id); if(el) el.classList.add('selected'); }
            else { appState.seleccionados.splice(idx, 1); if(el) el.classList.remove('selected'); }
            document.getElementById('countSelection').textContent = appState.seleccionados.length;
        }

        function handleClick(id, idx) {
            if(appState.modoSeleccion) toggleItemSeleccion(id);
            else abrirLightbox(idx);
        }

        // =========================================================================
        // 4. INTERACCIÓN TOUCH Y SCROLL
        // =========================================================================
        
        function handleScroll() {
            const toolbar = document.getElementById('mainToolbar');
            const floatBtn = document.getElementById('floatingSelectBtn');
            if(!toolbar || !floatBtn) return;
            
            const rect = toolbar.getBoundingClientRect();
            // Si el modo selección está activo, ocultar FAB. Si no, mostrarlo al bajar.
            if (appState.modoSeleccion) {
                floatBtn.classList.add('hidden');
            } else if (rect.bottom < 0) {
                floatBtn.classList.remove('hidden');
                floatBtn.classList.add('visible');
            } else {
                floatBtn.classList.remove('visible');
            }
        }

        function handleTouchStart(e, id) {
            if(appState.modoSeleccion) return;
            isPressing = true;
            pressTimer = setTimeout(() => {
                if(isPressing) {
                    if(navigator.vibrate) navigator.vibrate(50);
                    toggleModoSeleccion(true);
                    toggleItemSeleccion(id);
                }
            }, 800);
        }
        function handleTouchEnd() { clearTimeout(pressTimer); isPressing = false; }
        function handleTouchMove() { clearTimeout(pressTimer); isPressing = false; }

        function toggleModoSeleccion(force = null) {
            appState.modoSeleccion = force !== null ? force : !appState.modoSeleccion;
            const bar = document.getElementById('floatingBar');
            const btn = document.getElementById('btnSelectMode');
            const fab = document.getElementById('floatingSelectBtn');
            const container = document.getElementById('galleryContainer');

            if(appState.modoSeleccion) {
                bar.classList.add('active');
                if(btn) { btn.classList.add('active'); btn.innerHTML = '<i class="fas fa-times"></i> Cancelar'; }
                fab.classList.add('hidden');
                container.classList.add('selection-mode-active');
            } else {
                cancelarSeleccion();
            }
        }

        function cancelarSeleccion() {
            appState.modoSeleccion = false; appState.seleccionados = [];
            document.getElementById('floatingBar').classList.remove('active');
            const btn = document.getElementById('btnSelectMode');
            if(btn) { btn.classList.remove('active'); btn.innerHTML = '<i class="fas fa-check-square"></i> Seleccionar'; }
            
            document.querySelectorAll('.evidence-card.selected').forEach(e => e.classList.remove('selected'));
            document.getElementById('countSelection').textContent = '0';
            
            const container = document.getElementById('galleryContainer');
            if(container) container.classList.remove('selection-mode-active');
            
            const fab = document.getElementById('floatingSelectBtn');
            if(fab) fab.classList.remove('hidden');
            handleScroll();
        }

        // =========================================================================
        // 5. LIGHTBOX (VISOR)
        // =========================================================================

        function setupLightboxNavigation() {
            // Teclado
            document.addEventListener('keydown', (e) => {
                if (!document.getElementById('lightbox').classList.contains('active')) return;
                if (e.key === "ArrowLeft") prevImage();
                if (e.key === "ArrowRight") nextImage();
                if (e.key === "Escape") closeLightbox();
            });

            // Swipe (Táctil)
            const lbContent = document.getElementById('lightbox');
            lbContent.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, {passive: true});

            lbContent.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, {passive: true});
        }

        function handleSwipe() {
            const SWIPE_THRESHOLD = 50;
            if (touchEndX < touchStartX - SWIPE_THRESHOLD) {
                nextImage(); // Deslizar a la izquierda -> Siguiente
            }
            if (touchEndX > touchStartX + SWIPE_THRESHOLD) {
                prevImage(); // Deslizar a la derecha -> Anterior
            }
        }

        function abrirLightbox(idx) {
            appState.indiceLightbox = idx; actualizarLightbox();
            document.getElementById('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.getElementById('lightboxContent').innerHTML = '';
            document.body.style.overflow = '';
        }
        function handleClickFondo(e) { if(e.target.id === 'lightbox') closeLightbox(); }

        function actualizarLightbox() {
            const item = appState.filtrada[appState.indiceLightbox];
            const wrap = document.getElementById('lightboxContent');
            const btn = document.getElementById('lbDownloadLink');
            wrap.innerHTML = '';
            
            // Animación suave
            wrap.style.opacity = '0';
            setTimeout(() => {
                if(item.tipo === 'imagen') {
                    const img = document.createElement('img'); img.src = item.url; img.className = 'lb-media-item'; wrap.appendChild(img);
                } else if(item.tipo === 'video') {
                    const vid = document.createElement('video'); vid.src = item.url; vid.controls = true; vid.className = 'lb-media-item'; wrap.appendChild(vid);
                } else wrap.innerHTML = '<div style="color:white;text-align:center;">Documento (Vista previa no disponible)</div>';
                
                wrap.style.opacity = '1';
            }, 100);

            btn.href = item.url; // Enlace directo para descarga simple
        }
        function nextImage(e) { if(e) e.stopPropagation(); appState.indiceLightbox = (appState.indiceLightbox+1)%appState.filtrada.length; actualizarLightbox(); }
        function prevImage(e) { if(e) e.stopPropagation(); appState.indiceLightbox = (appState.indiceLightbox-1+appState.filtrada.length)%appState.filtrada.length; actualizarLightbox(); }

        // =========================================================================
        // 6. FUNCIONES BASE (TEMA, MODALES)
        // =========================================================================

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('global_theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            initTheme();
        }
        function initTheme() {
            const saved = localStorage.getItem('global_theme');
            const icon = document.querySelector('#themeBtn i');
            if(saved === 'dark') { document.body.classList.add('dark-mode'); icon.className = 'fas fa-sun'; }
            else { document.body.classList.remove('dark-mode'); icon.className = 'fas fa-moon'; }
        }
        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('active'); document.getElementById('overlayMenu').classList.toggle('active'); }
        function cerrarSesion() { localStorage.clear(); window.location.href = 'index.html'; }
        
        function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }
        function abrirHubContacto() { 
            cerrarModal('overlayMenu'); 
            document.getElementById('sideMenu').classList.remove('active'); 
            document.getElementById('modalContactHub').classList.add('active'); 
        }
        function cambiarModal(o, d) { cerrarModal(o); document.getElementById(d).classList.add('active'); }
        
        window.onclick = function(e) {
            if(e.target.classList.contains('modal-overlay')) e.target.classList.remove('active');
            if(!e.target.closest('.btn-icon-header') && !e.target.closest('.notis-dropdown')) document.getElementById('notisDropdown').classList.remove('active');
        }
        
        // Función específica para Reportar múltiples desde la barra flotante
        function reportarSeleccionados() {
           alert("Por favor, reporta las evidencias individualmente desde el visor para detallar el problema de cada una.");
        }
    </script>
</body>
</html>