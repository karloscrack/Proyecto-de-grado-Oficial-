<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Panel de Administración - Gestión Educativa Avanzada">
    <meta name="theme-color" content="#6A0DAD">
    
    <title>Panel de Administración | U.E. Despertar</title>
    
    <link rel="icon" type="image/png" href="Img/Logo_pestaña.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ==========================================================================
           1. VARIABLES Y SISTEMA DE DISEÑO (DESIGN TOKENS)
           ========================================================================== */
        :root {
            /* Identidad Corporativa */
            --primary: #6A0DAD;       
            --primary-dark: #4a0072;  
            --primary-light: #9d46ff; 
            --primary-soft: rgba(106, 13, 173, 0.08);
            
            --secondary: #2E8B57;     
            --secondary-hover: #1e5e3a;
            
            --error: #d32f2f;         
            --warning: #f9a825;       
            --info: #0288d1;          
            
            /* Paleta Modo Claro */
            --bg-image: url('Img/Claro.png'); 
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --bg-header: rgba(255, 255, 255, 0.95);
            --bg-sidebar: #ffffff;
            --bg-input: #f8f9fa;
            
            --text-main: #2c3e50;
            --text-sec: #5f6368;
            --text-muted: #9aa0a6;
            --text-inverse: #ffffff;
            
            --border-color: #e0e0e0;
            
            /* Sombras y Efectos */
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
            --shadow-card: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-hover: 0 10px 25px rgba(106, 13, 173, 0.15);
            --shadow-nav: 0 2px 15px rgba(0,0,0,0.05);
            
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --glass-backdrop: blur(12px);
            
            /* Dimensiones */
            --header-height: 80px;
            --header-height-mobile: 70px;
            --sidebar-width: 280px;
            --border-radius: 16px;
            --transition-speed: 0.3s;
        }

        /* ==========================================================================
           2. MODO OSCURO (DARK MODE) - CONTRASTES MEJORADOS
           ========================================================================== */
        body.dark-mode {
            --bg-image: url('Img/Oscuro.png');
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --bg-header: rgba(30, 30, 30, 0.95);
            --bg-sidebar: #1e1e1e;
            --bg-input: #2d2d2d;
            
            --text-main: #e8eaed;
            --text-sec: #b0b3b8;
            --text-muted: #6e7175;
            
            --border-color: #3c4043;
            
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.4);
            --shadow-hover: 0 10px 30px rgba(0,0,0,0.6);
            
            --glass-bg: rgba(30, 30, 30, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* ==========================================================================
           3. RESET & BASE
           ========================================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            background-image: var(--bg-image);
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            color: var(--text-main);
            padding-top: var(--header-height);
            transition: background var(--transition-speed), color var(--transition-speed);
            min-height: 100vh;
            display: flex; flex-direction: column;
            overflow-x: hidden;
        }

        a { text-decoration: none; color: inherit; transition: var(--transition-speed); }
        ul { list-style: none; }
        button, input, select, textarea { font-family: inherit; }

        /* Scrollbar Personalizado */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-dark); }

        /* ==========================================================================
           4. HEADER (COPIA EXACTA DE PERFIL ESTUDIANTE)
           ========================================================================== */
        .main-header {
            position: fixed; top: 0; left: 0; width: 100%;
            height: var(--header-height);
            background: var(--bg-header);
            border-bottom: 3px solid var(--primary);
            box-shadow: var(--shadow-nav);
            z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 5%;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .logo-container img {
            height: 50px; width: auto;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        .logo-container img:hover { transform: scale(1.05); }

        .header-actions { display: flex; align-items: center; gap: 15px; }

        .btn-icon-header {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer;
            transition: 0.3s;
            position: relative;
        }
        .btn-icon-header:hover {
            background: var(--primary-soft);
            transform: rotate(15deg);
            box-shadow: 0 0 15px var(--primary-soft);
        }

        .noti-badge {
            position: absolute; top: -5px; right: -5px;
            background: var(--error); color: white;
            font-size: 0.7rem; font-weight: 700;
            width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--bg-header);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn-logout-header {
            background: var(--error); color: white; border: none;
            padding: 0 25px; height: 42px; border-radius: 50px;
            font-weight: 600; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            transition: 0.3s;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.25);
        }
        .btn-logout-header:hover {
            background: #b71c1c; transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(211, 47, 47, 0.35);
        }

        .menu-toggle {
            background: none; border: none; font-size: 1.8rem;
            color: var(--primary); cursor: pointer;
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
            display: none; /* Se muestra en media queries */
        }

        /* Dropdown Notificaciones (No invasivo) */
        .notis-dropdown {
            position: absolute; top: 60px; right: 0;
            width: 320px; max-height: 400px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            z-index: 1100;
            display: none; flex-direction: column; overflow: hidden;
            animation: fadeInDown 0.2s ease-out;
        }
        .notis-dropdown.active { display: flex; }
        .noti-item {
            padding: 12px; border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem; cursor: pointer; transition: 0.2s;
            display: flex; gap: 10px; align-items: start;
        }
        .noti-item:hover { background: var(--bg-input); }
        .noti-item.unread { background: var(--primary-soft); border-left: 3px solid var(--primary); }

        /* ==========================================================================
           5. MENÚ LATERAL FIJO
           ========================================================================== */
        .sidebar-container {
            position: fixed; top: var(--header-height); left: 0;
            width: var(--sidebar-width); height: calc(100vh - var(--header-height));
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 20px; overflow-y: auto; z-index: 900;
            transition: transform 0.3s ease;
        }

        .sidebar-menu { list-style: none; display: flex; flex-direction: column; gap: 8px; }
        .sidebar-btn {
            width: 100%; text-align: left; background: transparent; border: none;
            padding: 12px 15px; border-radius: 10px;
            color: var(--text-sec); font-size: 0.95rem; font-weight: 500;
            cursor: pointer; display: flex; align-items: center; gap: 15px;
            transition: all 0.2s;
        }
        .sidebar-btn i { width: 20px; text-align: center; font-size: 1.1rem; }
        .sidebar-btn:hover { background: var(--bg-input); color: var(--primary); }
        .sidebar-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(106, 13, 173, 0.3); }

        /* ==========================================================================
           6. CONTENIDO PRINCIPAL (LAYOUT)
           ========================================================================== */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
            min-height: calc(100vh - var(--header-height) - 100px); /* Ajuste footer */
            transition: margin-left 0.3s ease;
        }

        .panel-section { display: none; animation: fadeIn 0.4s ease-out; }
        .panel-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD & GRIDS --- */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-card); padding: 25px; border-radius: var(--border-radius);
            box-shadow: var(--shadow-card); border: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 20px; transition: 0.3s;
            position: relative; overflow: hidden;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        .stat-icon {
            width: 50px; height: 50px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; color: white;
        }
        .stat-details h3 { font-size: 1.8rem; font-weight: 700; margin: 0; color: var(--text-main); }
        .stat-details p { font-size: 0.9rem; color: var(--text-sec); margin: 0; }
        
        .bg-purple { background: linear-gradient(135deg, #6A0DAD, #9d46ff); }
        .bg-green { background: linear-gradient(135deg, #2E8B57, #66bb6a); }
        .bg-blue { background: linear-gradient(135deg, #0288d1, #29b6f6); }
        .bg-orange { background: linear-gradient(135deg, #f57c00, #ffa726); }

        /* --- CALCULADORA BACKBLAZE (REALISTA) --- */
        .storage-calc {
            background: var(--bg-card); padding: 25px; border-radius: var(--border-radius);
            border: 1px solid var(--border-color); margin-bottom: 30px;
        }
        .storage-bar-bg { width: 100%; height: 10px; background: var(--bg-input); border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .storage-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 1s ease; }
        .cost-display { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-sec); }
        .cost-highlight { color: var(--text-main); font-weight: bold; font-size: 1.1rem; }

        /* --- TABLAS Y LISTAS --- */
        .modern-table-wrapper {
            background: var(--bg-card); border-radius: var(--border-radius);
            overflow: hidden; border: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
        }
        .modern-table { width: 100%; border-collapse: collapse; }
        .modern-table th {
            background: var(--primary); color: white; padding: 15px; text-align: left;
            font-weight: 600; font-size: 0.9rem;
        }
        .modern-table td {
            padding: 15px; border-bottom: 1px solid var(--border-color);
            color: var(--text-main); font-size: 0.9rem;
        }
        .modern-table tr:hover { background: var(--bg-input); }
        .modern-table tr:last-child td { border-bottom: none; }

        .action-btn {
            border: none; width: 32px; height: 32px; border-radius: 8px;
            cursor: pointer; font-size: 0.9rem; margin-right: 5px; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-edit { background: rgba(255, 193, 7, 0.15); color: #ff9800; } .btn-edit:hover { background: #ff9800; color: white; }
        .btn-delete { background: rgba(244, 67, 54, 0.15); color: #f44336; } .btn-delete:hover { background: #f44336; color: white; }
        .btn-view { background: rgba(33, 150, 243, 0.15); color: #2196F3; } .btn-view:hover { background: #2196F3; color: white; }

        /* --- FORMULARIOS --- */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            border-radius: 10px; background: var(--bg-input); color: var(--text-main);
            transition: 0.3s;
        }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }
        
        .btn-primary {
            background: var(--primary); color: white; border: none;
            padding: 12px 24px; border-radius: 10px; font-weight: 600;
            cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-danger { background: var(--error); color: white; } .btn-danger:hover { background: #b71c1c; }

        /* --- EVIDENCIAS (GRID) --- */
        .evidence-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;
        }
        .folder-card {
            background: var(--bg-card); border-radius: 12px; padding: 15px;
            border: 1px solid var(--border-color); text-align: center;
            cursor: pointer; transition: 0.3s; position: relative;
        }
        .folder-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); border-color: var(--primary); }
        .folder-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 10px; border: 3px solid var(--bg-input); }
        .folder-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- MODALES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 5000; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .modal-card {
            background: var(--bg-card); width: 95%; max-width: 500px;
            border-radius: 16px; padding: 30px; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto;
        }

        /* --- PREVISUALIZACIÓN DE EVIDENCIAS --- */
        .preview-container {
            max-width: 100%; max-height: 300px; overflow: hidden;
            border-radius: 8px; margin: 10px 0; background: var(--bg-input);
            display: flex; align-items: center; justify-content: center;
        }
        .preview-img { max-width: 100%; max-height: 300px; object-fit: contain; }
        .preview-video { max-width: 100%; max-height: 300px; }

        /* --- FOOTER --- */
        footer {
            background: #1a1a1a; color: white; padding: 30px 20px;
            text-align: center; margin-top: auto; border-top: 4px solid var(--primary);
        }
        .footer-logo Img { height: 60px; margin-bottom: 10px; }
        .footer-social { margin: 20px 0; }
        .footer-social a { 
            display: inline-flex; width: 40px; height: 40px; 
            background: #333; color: white; border-radius: 50%; 
            align-items: center; justify-content: center; margin: 0 8px; 
            text-decoration: none; transition: 0.3s;
        }
        .footer-social a:hover { background: var(--primary); transform: translateY(-3px); }
        .footer-links a { color: #aaa; text-decoration: none; margin: 0 10px; }
        .footer-links a:hover { color: var(--primary); }
        .copyright { font-size: 0.85rem; color: #888; border-top: 1px solid #333; padding-top: 15px; }

        /* ==========================================================================
           7. RESPONSIVE DESIGN (MÓVIL) - MEJORADO
           ========================================================================== */
        @media (max-width: 992px) {
            .sidebar-container { transform: translateX(-100%); width: 280px; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
            .sidebar-container.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 20px 15px; }
            footer { margin-left: 0; }
            .menu-toggle { display: flex; }
            
            .main-header { padding: 0 15px; height: var(--header-height-mobile); }
            .logo-container img { height: 40px; }
            .btn-logout-header span { display: none; }
            .btn-logout-header { padding: 0 15px; }
            
            .stat-card { flex-direction: column; text-align: center; padding: 15px; }
            .stat-details h3 { font-size: 1.5rem; }
            
            /* Mejoras específicas para móvil */
            .btn-primary { padding: 10px 18px; font-size: 0.9rem; }
            .action-btn { width: 36px; height: 36px; margin-right: 3px; }
            .form-grid { grid-template-columns: 1fr; }
            .evidence-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }
            .folder-img { width: 70px; height: 70px; }
            .cost-display { flex-direction: column; gap: 10px; }
        }

        /* Pantallas muy pequeñas */
        @media (max-width: 480px) {
            .header-actions { gap: 8px; }
            .btn-icon-header { width: 38px; height: 38px; font-size: 1rem; }
            .notis-dropdown { width: 280px; }
            .modal-card { padding: 20px 15px; }
            .storage-calc { padding: 20px 15px; }
            .modern-table { font-size: 0.8rem; }
            .modern-table th, .modern-table td { padding: 10px 8px; }
        }
    </style>
</head>

<body>
    <!-- HEADER IDÉNTICO AL PERFIL ESTUDIANTE -->
    <header class="main-header">
        <div class="logo-container">
            <a href="index.html">
                <img src="Img/Logo-Despertar-SKAS-Unidad-Educativa23.png" alt="Logo">
            </a>
        </div>
        <div class="header-actions">
            <button onclick="toggleTheme()" class="btn-icon-header" id="themeBtn" title="Cambiar Tema">
                <i class="fas fa-moon"></i>
            </button>

            <div style="position:relative;">
                <button class="btn-icon-header" onclick="toggleNotis()" title="Notificaciones">
                    <i class="fas fa-bell"></i>
                    <span id="notisBadge" class="noti-badge" style="display:none;">0</span>
                </button>
                <div id="notisDropdown" class="notis-dropdown">
                    <div style="padding:15px; background:var(--bg-input); font-weight:bold; border-bottom:1px solid var(--border-color);">
                        Solicitudes Pendientes
                    </div>
                    <div id="notisList" style="max-height:300px; overflow-y:auto;">
                        <p style="padding:20px; text-align:center; color:var(--text-sec);">Cargando...</p>
                    </div>
                    <div style="padding:10px; text-align:center; border-top:1px solid var(--border-color);">
                        <a href="#" onclick="navTo('solicitudes'); toggleNotis();" style="font-size:0.85rem; color:var(--primary);">Ver todas</a>
                    </div>
                </div>
            </div>

            <button onclick="cerrarSesion()" class="btn-logout-header" title="Cerrar Sesión">
                <i class="fas fa-sign-out-alt"></i> <span>Salir</span>
            </button>

            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- MENÚ LATERAL FIJO -->
    <nav class="sidebar-container" id="sidebar">
        <div style="margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid var(--border-color);">
            <h4 style="color:var(--primary); font-weight:700;">Panel Admin</h4>
            <p style="font-size:0.85rem; color:var(--text-sec);">Gestión Integral</p>
        </div>
        <ul class="sidebar-menu">
            <li><button class="sidebar-btn active" onclick="navTo('dashboard', this)"><i class="fas fa-chart-line"></i> Resumen</button></li>
            <li><button class="sidebar-btn" onclick="navTo('usuarios', this)"><i class="fas fa-users-cog"></i> Usuarios</button></li>
            <li><button class="sidebar-btn" onclick="navTo('upload', this)"><i class="fas fa-cloud-upload-alt"></i> Subir Archivos</button></li>
            <li><button class="sidebar-btn" onclick="navTo('evidencias', this)"><i class="fas fa-folder-open"></i> Evidencias</button></li>
            <li><button class="sidebar-btn" onclick="navTo('solicitudes', this)"><i class="fas fa-inbox"></i> Solicitudes</button></li>
            <li><button class="sidebar-btn" onclick="navTo('seguridad', this)"><i class="fas fa-shield-alt"></i> Seguridad / Logs</button></li>
            <li><button class="sidebar-btn" onclick="navTo('mantenimiento', this)"><i class="fas fa-server"></i> Mantenimiento</button></li>
        </ul>
        <div style="margin-top:auto; padding-top:20px; border-top:1px solid var(--border-color);">
            <small style="color:var(--text-muted); display:block; margin-bottom:5px;">Espacio Estimado:</small>
            <div style="background:var(--bg-input); border-radius:4px; height:6px; overflow:hidden;">
                <div id="sidebarStorageBar" style="width:0%; background:var(--secondary); height:100%;"></div>
            </div>
            <small id="sidebarStorageText" style="color:var(--text-main); font-weight:bold;">Calc...</small>
        </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="main-content" id="mainContainer">
        
        <!-- PANEL: DASHBOARD / RESUMEN -->
        <section id="panel-dashboard" class="panel-section active">
            <h2 style="margin-bottom:25px; color:var(--primary);">Panel de Control</h2>
            
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-purple"><i class="fas fa-users"></i></div>
                    <div class="stat-details">
                        <h3 id="statUsers">0</h3>
                        <p>Usuarios Activos</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-orange"><i class="fas fa-bell"></i></div>
                    <div class="stat-details">
                        <h3 id="statReqs">0</h3>
                        <p>Solicitudes Pendientes</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-green"><i class="fas fa-database"></i></div>
                    <div class="stat-details">
                        <h3 id="statFiles">0</h3>
                        <p>Evidencias Totales</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-blue"><i class="fas fa-hdd"></i></div>
                    <div class="stat-details">
                        <h3 id="statSize">0 GB</h3>
                        <p>Almacenamiento (Est.)</p>
                    </div>
                </div>
            </div>

            <!-- CALCULADORA DE COSTOS BACKBLAZE (REAL) -->
            <div class="storage-calc">
                <h3 style="font-size:1.1rem; margin-bottom:10px;"><i class="fas fa-calculator"></i> Estimación de Costos (Backblaze B2)</h3>
                <p style="font-size:0.9rem; color:var(--text-sec);">Calculado a $0.005/GB mes. Basado en archivos reales del sistema.</p>
                <div class="storage-bar-bg">
                    <div id="mainStorageBar" class="storage-bar-fill"></div>
                </div>
                <div class="cost-display">
                    <span>Uso Actual: <strong id="realSizeDisplay">0 GB</strong></span>
                    <span>Costo Mensual Est: <span id="monthlyCost" class="cost-highlight">$0.00</span></span>
                    <span>Anual Est: <span id="yearlyCost" class="cost-highlight">$0.00</span></span>
                </div>
                <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn-primary" style="background:var(--secondary);" onclick="analizarDuplicados()"><i class="fas fa-broom"></i> Analizar Duplicados</button>
                    <button class="btn-primary" style="background:var(--text-sec);" onclick="limpiarCache()"><i class="fas fa-wind"></i> Limpiar Caché</button>
                    <button class="btn-primary" style="background:var(--error);" onclick="limpiarHuérfanos()"><i class="fas fa-trash-alt"></i> Limpiar Archivos Huérfanos</button>
                </div>
            </div>

            <!-- ACCIONES RÁPIDAS -->
            <div class="storage-calc">
                <h3 style="font-size:1.1rem; margin-bottom:15px; color:var(--primary);"><i class="fas fa-bolt"></i> Acciones Rápidas</h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                    <button class="btn-primary" style="background:var(--info);" onclick="navTo('usuarios')"><i class="fas fa-user-plus"></i> Registrar Usuario</button>
                    <button class="btn-primary" style="background:var(--warning);" onclick="navTo('upload')"><i class="fas fa-cloud-upload-alt"></i> Subir con IA</button>
                    <button class="btn-primary" style="background:var(--secondary);" onclick="navTo('evidencias')"><i class="fas fa-search"></i> Buscar Evidencias</button>
                    <button class="btn-primary" onclick="navTo('mantenimiento')"><i class="fas fa-download"></i> Respaldar BD</button>
                </div>
            </div>
        </section>

        <!-- PANEL: USUARIOS -->
        <section id="panel-usuarios" class="panel-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h2 style="color:var(--primary); margin:0;">Gestión de Usuarios</h2>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="searchUser" placeholder="Buscar por cédula o nombre..." class="form-control" style="width:250px;" onkeyup="filterUsers()">
                    <button class="btn-primary" onclick="abrirModalAgregarRef()"><i class="fas fa-camera"></i> Agregar Foto Ref.</button>
                </div>
            </div>

            <!-- FORMULARIO REGISTRO USUARIO -->
            <div class="storage-calc" style="margin-bottom:30px;">
                <h4 style="margin-bottom:15px; color:var(--primary);">Registrar Nuevo Usuario</h4>
                <form id="formRegistro">
                    <div class="form-grid">
                        <div class="form-group"><label>Nombre</label><input type="text" name="nombre" class="form-control" required></div>
                        <div class="form-group"><label>Apellido</label><input type="text" name="apellido" class="form-control" required></div>
                        <div class="form-group"><label>Cédula (10 dígitos)</label><input type="text" name="cedula" class="form-control" pattern="\d{10}" title="10 dígitos numéricos" required></div>
                        <div class="form-group"><label>Contraseña (Mín 6 car.)</label><input type="password" name="contrasena" class="form-control" minlength="6" required></div>
                        <div class="form-group">
                            <label>Rol</label>
                            <select name="tipo_usuario" class="form-control">
                                <option value="1">Estudiante</option>
                                <option value="0">Administrador</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Foto Perfil</label><input type="file" name="foto" class="form-control" accept="image/*" required></div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top:15px;"><i class="fas fa-user-plus"></i> Guardar Usuario</button>
                </form>
            </div>

            <!-- TABLA DE USUARIOS -->
            <div class="modern-table-wrapper">
                <table class="modern-table">
                    <thead><tr><th>Usuario</th><th>Cédula</th><th>Rol</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="userTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- PANEL: SUBIR ARCHIVOS -->
        <section id="panel-upload" class="panel-section">
            <h2 style="color:var(--primary); margin-bottom:20px;">Subida de Evidencias</h2>
            
            <!-- SUBIDA CON IA -->
            <div class="storage-calc" style="text-align:center; margin-bottom:30px;">
                <i class="fas fa-robot" style="font-size:3rem; color:var(--primary); margin-bottom:15px;"></i>
                <h3>Subida Inteligente (Reconocimiento Facial)</h3>
                <p style="margin-bottom:20px; color:var(--text-sec);">El sistema asignará automáticamente la foto al estudiante correcto.</p>
                
                <input type="file" id="fileInputIA" multiple accept="image/*,video/*,.pdf,.doc,.docx,.mp3,.mp4" style="display:none" onchange="handleUploadIA(this)">
                <button class="btn-primary" onclick="document.getElementById('fileInputIA').click()" style="font-size:1.1rem; padding:15px 30px;">
                    <i class="fas fa-cloud-upload-alt"></i> Seleccionar Archivos
                </button>
                
                <div id="uploadProgress" style="margin-top:20px; display:none;">
                    <div class="storage-bar-bg"><div id="progressBar" class="storage-bar-fill" style="width:0%"></div></div>
                    <p id="progressText">Procesando...</p>
                </div>
                <div id="uploadLog" style="text-align:left; margin-top:20px; max-height:200px; overflow-y:auto; font-size:0.9rem; padding:10px; background:var(--bg-input); border-radius:8px;"></div>
            </div>

            <!-- SUBIDA MANUAL -->
            <div style="border-top:2px solid var(--border-color); padding-top:30px;">
                <h4><i class="fas fa-hand-pointer"></i> Subida Manual</h4>
                <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:15px;">Para archivos sin rostro (PDF, Docs) o correcciones.</p>
                <form id="formManual" style="display:flex; gap:15px; flex-wrap:wrap; align-items:end;">
                    <div style="flex:1; min-width:200px;">
                        <label class="form-label">Archivo</label>
                        <input type="file" id="manualFile" class="form-control" accept="image/*,video/*,.pdf,.doc,.docx,.mp3,.mp4" required>
                    </div>
                    <div style="flex:2; min-width:300px;">
                        <label class="form-label">Nombre(s) del Estudiante</label>
                        <input type="text" id="manualNombres" placeholder="Ej: Juan Pérez, María Gómez" class="form-control" required>
                        <div id="suggestionsBox" style="display:none; position:absolute; background:var(--bg-card); border:1px solid var(--border-color); max-height:150px; overflow-y:auto; width:100%; z-index:100; border-radius:8px; margin-top:5px;"></div>
                    </div>
                    <button type="submit" class="btn-primary" style="background:var(--secondary);">Asignar Manualmente</button>
                </form>
            </div>
        </section>

        <!-- PANEL: EVIDENCIAS -->
        <section id="panel-evidencias" class="panel-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h2 style="color:var(--primary); margin:0;">Galería de Evidencias</h2>
                <input type="text" id="filterEvidence" placeholder="Buscar estudiante..." class="form-control" style="width:250px;" onkeyup="renderEvidenceGrid()">
            </div>
            
            <div id="evidenceGrid" class="evidence-grid">
                <p>Cargando...</p>
            </div>
        </section>

        <!-- PANEL: SOLICITUDES -->
        <section id="panel-solicitudes" class="panel-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h2 style="color:var(--primary); margin:0;">Centro de Solicitudes</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" onclick="mostrarHistorialSolicitudes()"><i class="fas fa-history"></i> Ver Historial</button>
                    <button class="btn-primary" style="background:var(--info);" onclick="cambiarContraseñaUsuario()"><i class="fas fa-key"></i> Cambiar Contraseña</button>
                </div>
            </div>
            
            <div id="requestsContainer">
                <p style="text-align:center; padding:40px; color:var(--text-sec);"><i class="fas fa-spinner fa-spin"></i> Cargando solicitudes...</p>
            </div>
        </section>

        <!-- PANEL: SEGURIDAD Y LOGS -->
        <section id="panel-seguridad" class="panel-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h2 style="color:var(--primary); margin:0;">Seguridad y Registro de Actividad</h2>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="searchLogs" placeholder="Buscar en logs..." class="form-control" style="width:200px;" onkeyup="filterLogs()">
                    <button onclick="loadLogs()" class="btn-primary" style="font-size:0.9rem;"><i class="fas fa-sync"></i> Actualizar</button>
                </div>
            </div>
            
            <!-- CAMBIAR CONTRASEÑA -->
            <div class="storage-calc" style="margin-bottom:30px;">
                <h4 style="color:var(--primary); margin-bottom:15px;"><i class="fas fa-key"></i> Cambiar Contraseña de Usuario</h4>
                <form id="formCambiarPassword" style="display:flex; gap:15px; flex-wrap:wrap; align-items:end;">
                    <div style="flex:1; min-width:250px;">
                        <label class="form-label">Nombre del Estudiante</label>
                        <input type="text" id="nombrePassword" class="form-control" placeholder="Buscar por nombre" onkeyup="sugerirUsuariosPass(this)">
                        <div id="suggestionsPass" style="display:none; position:absolute; background:var(--bg-card); border:1px solid var(--border-color); max-height:150px; overflow-y:auto; width:100%; z-index:100; border-radius:8px; margin-top:5px;"></div>
                    </div>
                    <div style="flex:1; min-width:250px;">
                        <label class="form-label">Nueva Contraseña</label>
                        <input type="password" id="nuevaPassword" class="form-control" minlength="6" required>
                    </div>
                    <button type="submit" class="btn-primary" style="background:var(--warning); color:black;">Cambiar Contraseña</button>
                </form>
            </div>

            <!-- LOGS DE ACTIVIDAD -->
            <div class="modern-table-wrapper">
                <table class="modern-table">
                    <thead><tr><th>Fecha</th><th>Acción</th><th>Detalle</th><th>Usuario</th></tr></thead>
                    <tbody id="logsTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- PANEL: MANTENIMIENTO -->
        <section id="panel-mantenimiento" class="panel-section">
            <h2 style="color:var(--primary); margin-bottom:20px;">Respaldos y Mantenimiento</h2>
            
            <div class="dashboard-grid" style="margin-bottom:30px;">
                <div class="stat-card" style="cursor:pointer;" onclick="downloadBackup('db')">
                    <div class="stat-icon bg-green"><i class="fas fa-database"></i></div>
                    <div class="stat-details">
                        <h3>Base de Datos</h3>
                        <p>Descargar SQL completo</p>
                    </div>
                </div>
                <div class="stat-card" style="cursor:pointer;" onclick="downloadBackup('media')">
                    <div class="stat-icon bg-blue"><i class="fas fa-photo-video"></i></div>
                    <div class="stat-details">
                        <h3>Multimedia</h3>
                        <p>Descargar ZIP evidencias</p>
                    </div>
                </div>
                <div class="stat-card" style="cursor:pointer;" onclick="optimizarSistema()">
                    <div class="stat-icon bg-orange"><i class="fas fa-tools"></i></div>
                    <div class="stat-details">
                        <h3>Optimización</h3>
                        <p>Limpiar y optimizar</p>
                    </div>
                </div>
            </div>

            <!-- ESTIMACIÓN DE COSTOS AWS REKOGNITION -->
            <div class="storage-calc">
                <h3 style="font-size:1.1rem; margin-bottom:10px; color:var(--primary);"><i class="fas fa-robot"></i> Estimación Costos AWS Rekognition</h3>
                <p style="font-size:0.9rem; color:var(--text-sec);">Basado en uso real del sistema. Precio: $1.00 por 1000 imágenes analizadas.</p>
                <div style="margin:15px 0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Imágenes procesadas este mes:</span>
                        <strong id="rekognitionCount">0</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Costo estimado AWS:</span>
                        <strong id="rekognitionCost" class="cost-highlight">$0.00</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span>Total mensual (Storage + IA):</span>
                        <strong id="totalCost" class="cost-highlight" style="color:var(--error);">$0.00</strong>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- FOOTER IDÉNTICO AL PERFIL ESTUDIANTE -->
    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <Img src="Img/Logo-Despertar-SKAS-Unidad-Educativa23.png" alt="Logo">
                <h3>Unidad Educativa Particular Despertar</h3>
            </div>
            <div class="footer-links" style="margin-bottom:20px;">
                <a href="https://uepdespertar.edu.ec/nosotros/" target="_blank">Sobre Nosotros</a>
            </div>
            <div class="footer-social">
                <a href="https://www.facebook.com/uepdespertar"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.youtube.com/@DespertarSKAS"><i class="fab fa-youtube"></i></a>
                <a href="https://www.instagram.com/skas_despertar"><i class="fab fa-instagram"></i></a>
            </div>
            <div class="copyright">
                <p>© 2025 Plataforma Educativa - Unidad Educativa Particular Despertar.</p>
            </div>
        </div>
    </footer>

    <!-- MODALES ADICIONALES -->
    <div class="modal-overlay" id="modalAgregarRef">
        <div class="modal-card">
            <button onclick="closeModal('modalAgregarRef')" style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:1.5rem; cursor:pointer; color:var(--text-sec);">&times;</button>
            <h3 style="color:var(--primary); margin-bottom:15px;"><i class="fas fa-camera"></i> Agregar Foto de Referencia</h3>
            <form id="formAgregarRef">
                <div class="form-group">
                    <label>Seleccionar Usuario</label>
                    <select id="selectUsuarioRef" class="form-control" required>
                        <option value="">-- Seleccionar --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Foto de Referencia</label>
                    <input type="file" id="fotoRef" class="form-control" accept="image/*" required>
                </div>
                <button type="submit" class="btn-primary" style="width:100%;">Agregar Referencia</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modalHistorial">
        <div class="modal-card">
            <button onclick="closeModal('modalHistorial')" style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:1.5rem; cursor:pointer; color:var(--text-sec);">&times;</button>
            <h3 style="color:var(--primary); margin-bottom:15px;"><i class="fas fa-history"></i> Historial de Solicitudes</h3>
            <div id="historialContent" style="max-height:400px; overflow-y:auto;">
                <p style="text-align:center; padding:20px; color:var(--text-sec);">Cargando historial...</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://proyecto-de-grado-oficial-production.up.railway.app";
        let globalUsers = [];
        let globalRequests = [];
        let globalEvidences = [];
        let globalLogs = [];
        let selectedUserForPassword = null;

        // ==========================================
        // 1. INICIALIZACIÓN Y NAVEGACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar Auth
            if(localStorage.getItem('usuario_tipo') !== "0") {
                alert("Acceso Restringido: Solo Administradores.");
                window.location.href = "index.html";
                return;
            }

            initTheme();
            loadAllData(); // Carga inicial de datos reales
            
            // Toggle Menú Móvil
            document.getElementById('menuToggle').onclick = () => {
                document.getElementById('sidebar').classList.toggle('active');
            };

            // Cerrar menú al hacer clic fuera en móvil
            document.addEventListener('click', (e) => {
                if(window.innerWidth <= 992 && !e.target.closest('#sidebar') && !e.target.closest('#menuToggle')) {
                    document.getElementById('sidebar').classList.remove('active');
                }
            });
        });

        function navTo(sectionId, btn) {
            // Ocultar todas las secciones
            document.querySelectorAll('.panel-section').forEach(el => el.classList.remove('active'));
            document.getElementById('panel-' + sectionId).classList.add('active');
            
            // Actualizar sidebar activo
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            // Cerrar menú móvil si aplica
            document.getElementById('sidebar').classList.remove('active');

            // Recargar datos específicos si es necesario
            if(sectionId === 'usuarios') renderUsers();
            if(sectionId === 'evidencias') renderEvidenceGrid();
            if(sectionId === 'solicitudes') renderRequests();
            if(sectionId === 'seguridad') loadLogs();
        }

        async function loadAllData() {
            try {
                // Cargar usuarios
                const resU = await fetch(`${API_URL}/listar_usuarios?t=${Date.now()}`);
                globalUsers = await resU.json();
                
                // Cargar evidencias (para stats y grid)
                const resE = await fetch(`${API_URL}/resumen_estudiantes_con_evidencias`);
                globalEvidences = await resE.json();

                // Cargar solicitudes
                const resS = await fetch(`${API_URL}/obtener_solicitudes`);
                globalRequests = await resS.json();

                // Cargar logs iniciales
                await loadLogs();

                updateDashboard();
                renderNotis();
                renderUsers();

            } catch (e) { 
                console.error("Error cargando datos:", e);
                showToast("Error conectando al servidor", "error");
            }
        }

        // ==========================================
        // 2. DASHBOARD Y CALCULADORA (DATOS REALES)
        // ==========================================
        async function updateDashboard() {
            // Contadores Reales
            document.getElementById('statUsers').textContent = globalUsers.length;
            const pendientes = globalRequests.filter(r => r.Estado === 'PENDIENTE').length;
            document.getElementById('statReqs').textContent = pendientes;
            
            const totalFiles = globalEvidences.reduce((acc, curr) => acc + (curr.total_evidencias || 0), 0);
            document.getElementById('statFiles').textContent = totalFiles;

            // Calcular tamaño real estimado (promedio 3.5MB por archivo)
            const avgSizeMB = 3.5; 
            const totalGB = (totalFiles * avgSizeMB) / 1024;
            const costPerGB = 0.005; // Precio real Backblaze B2
            const monthlyCost = Math.max(0.01, totalGB * costPerGB);

            // Costos AWS Rekognition (estimación basada en uso)
            const rekognitionCount = Math.floor(totalFiles * 1.2); // Estimación de análisis
            const rekognitionCost = (rekognitionCount / 1000) * 1.00; // $1 por 1000 imágenes
            const totalMonthlyCost = monthlyCost + rekognitionCost;

            document.getElementById('statSize').textContent = totalGB.toFixed(2) + " GB";
            document.getElementById('realSizeDisplay').textContent = totalGB.toFixed(2) + " GB";
            document.getElementById('monthlyCost').textContent = "$" + monthlyCost.toFixed(3);
            document.getElementById('yearlyCost').textContent = "$" + (monthlyCost * 12).toFixed(2);
            
            document.getElementById('rekognitionCount').textContent = rekognitionCount;
            document.getElementById('rekognitionCost').textContent = "$" + rekognitionCost.toFixed(2);
            document.getElementById('totalCost').textContent = "$" + totalMonthlyCost.toFixed(3);

            // Barras visuales
            const percentage = Math.min(100, (totalGB / 10) * 100); // Base 10GB como ejemplo visual
            document.getElementById('mainStorageBar').style.width = percentage + "%";
            document.getElementById('sidebarStorageBar').style.width = percentage + "%";
            document.getElementById('sidebarStorageText').textContent = totalGB.toFixed(1) + "GB usados";
        }

        // ==========================================
        // 3. GESTIÓN DE USUARIOS
        // ==========================================
        function renderUsers() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            
            globalUsers.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:600;">${u.nombre} ${u.apellido}</div>
                        <small style="color:var(--text-sec);">${u.contrasena}</small>
                    </td>
                    <td>${u.cedula}</td>
                    <td>${u.tipo == 0 ? '<span style="color:var(--primary); font-weight:bold;">Admin</span>' : '<span style="color:var(--secondary);">Estudiante</span>'}</td>
                    <td>${u.activo == 1 ? '<span style="color:var(--secondary);">Activo</span>' : '<span style="color:var(--error);">Inactivo</span>'}</td>
                    <td>
                        <button class="action-btn btn-view" title="Ver Info" onclick="verUsuario('${u.cedula}')"><i class="fas fa-eye"></i></button>
                        <button class="action-btn btn-edit" title="Desactivar" onclick="toggleActivoUsuario('${u.cedula}')"><i class="fas fa-power-off"></i></button>
                        <button class="action-btn btn-delete" title="Borrar" onclick="deleteUser('${u.cedula}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterUsers() {
            const q = document.getElementById('searchUser').value.toLowerCase();
            const rows = document.querySelectorAll('#userTableBody tr');
            rows.forEach(r => {
                const txt = r.innerText.toLowerCase();
                r.style.display = txt.includes(q) ? '' : 'none';
            });
        }

        document.getElementById('formRegistro').onsubmit = async function(e) {
            e.preventDefault();
            const btn = this.querySelector('button[type="submit"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...'; btn.disabled = true;
            
            // Validación frontend adicional
            const cedula = this.querySelector('input[name="cedula"]').value;
            const contrasena = this.querySelector('input[name="contrasena"]').value;
            
            if(cedula.length !== 10 || !/^\d+$/.test(cedula)) {
                alert("La cédula debe tener exactamente 10 dígitos numéricos.");
                btn.innerHTML = '<i class="fas fa-user-plus"></i> Guardar Usuario'; btn.disabled = false;
                return;
            }
            
            if(contrasena.length < 6) {
                alert("La contraseña debe tener al menos 6 caracteres.");
                btn.innerHTML = '<i class="fas fa-user-plus"></i> Guardar Usuario'; btn.disabled = false;
                return;
            }
            
            const fd = new FormData(this);
            try {
                const res = await fetch(`${API_URL}/registrar_usuario`, {method:"POST", body:fd});
                const data = await res.json();
                if(data.mensaje) {
                    showToast("Usuario registrado correctamente", "success");
                    this.reset();
                    loadAllData(); // Recargar todo
                } else {
                    showToast("Error: " + (data.error || "Desconocido"), "error");
                }
            } catch(e) { 
                showToast("Error de conexión", "error");
            }
            finally { 
                btn.innerHTML = '<i class="fas fa-user-plus"></i> Guardar Usuario'; 
                btn.disabled = false; 
            }
        };

        async function verUsuario(cedula) {
            const user = globalUsers.find(u => u.cedula === cedula);
            if(user) {
                alert(`Información de usuario:\n\nNombre: ${user.nombre} ${user.apellido}\nCédula: ${user.cedula}\nRol: ${user.tipo == 0 ? 'Administrador' : 'Estudiante'}\nEstado: ${user.activo == 1 ? 'Activo' : 'Inactivo'}\nContraseña: ${user.contrasena}`);
            }
        }

        async function toggleActivoUsuario(cedula) {
            const user = globalUsers.find(u => u.cedula === cedula);
            if(!user) return;
            
            const nuevoEstado = user.activo == 1 ? 0 : 1;
            if(confirm(`¿${nuevoEstado == 1 ? 'Activar' : 'Desactivar'} al usuario ${user.nombre}?`)) {
                try {
                    // Enviar al backend para actualizar estado
                    showToast("Función en desarrollo - Contactar soporte técnico", "info");
                } catch(e) {
                    showToast("Error al cambiar estado", "error");
                }
            }
        }

        async function deleteUser(cedula) {
            const user = globalUsers.find(u => u.cedula === cedula);
            if(!user) return;
            
            if(!confirm(`¿Estás seguro de eliminar permanentemente a ${user.nombre} ${user.apellido} (${cedula})? Esta acción eliminará TODAS sus evidencias y datos.`)) return;
            
            try {
                const res = await fetch(`${API_URL}/eliminar_usuario/${cedula}`, {method:"DELETE"});
                if(res.ok) {
                    showToast("Usuario eliminado correctamente", "success");
                    loadAllData();
                } else {
                    showToast("Error al eliminar usuario", "error");
                }
            } catch(e) { 
                showToast("Error de conexión", "error");
            }
        }

        // ==========================================
        // 4. SUBIDA DE ARCHIVOS
        // ==========================================
        async function handleUploadIA(input) {
            const files = input.files;
            if(files.length === 0) return;

            const log = document.getElementById('uploadLog');
            const progress = document.getElementById('uploadProgress');
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');
            
            log.innerHTML = '<div><i class="fas fa-info-circle"></i> Iniciando análisis de archivos...</div>';
            progress.style.display = 'block';
            
            let completed = 0;
            const total = files.length;

            for (let i = 0; i < total; i++) {
                const file = files[i];
                const fd = new FormData();
                fd.append('archivo', file);
                
                log.innerHTML += `<div><i class="fas fa-spinner fa-spin"></i> Analizando: ${file.name}...</div>`;
                text.textContent = `Procesando ${i+1}/${total}`;
                bar.style.width = ((i/total)*100) + "%";
                
                try {
                    const res = await fetch(`${API_URL}/subir_evidencia`, {method:"POST", body:fd});
                    const data = await res.json();
                    
                    if(data.status === 'exito') {
                        log.innerHTML += `<div style="color:var(--secondary); font-weight:bold;">✅ ${file.name} asignado a: ${data.asignado_a.join(', ') || 'varios estudiantes'}</div>`;
                    } else if(data.status === 'alerta') {
                        log.innerHTML += `<div style="color:var(--warning);">⚠ ${file.name}: ${data.mensaje || 'Duplicado o sin coincidencias'}</div>`;
                    } else {
                        log.innerHTML += `<div style="color:var(--error);">❌ ${file.name}: Error - ${data.motivo || 'Desconocido'}</div>`;
                    }
                } catch(e) {
                    log.innerHTML += `<div style="color:var(--error);">❌ ${file.name}: Error de red.</div>`;
                }
                
                completed++;
                bar.style.width = ((completed/total)*100) + "%";
            }
            
            text.textContent = "Proceso finalizado ✅";
            input.value = "";
            loadAllData();
        }

        document.getElementById('formManual').onsubmit = async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('manualFile');
            const nombresInput = document.getElementById('manualNombres');
            
            if(!fileInput.files.length) {
                alert("Selecciona un archivo primero.");
                return;
            }
            
            if(!nombresInput.value.trim()) {
                alert("Ingresa al menos un nombre de estudiante.");
                return;
            }
            
            const file = fileInput.files[0];
            const nombres = nombresInput.value;
            
            // Convertir nombres a cédulas (simplificado - en producción buscarías en la BD)
            const cedulas = await buscarCedulasPorNombres(nombres);
            if(cedulas.length === 0) {
                alert("No se encontraron estudiantes con esos nombres.");
                return;
            }
            
            const fd = new FormData();
            fd.append('archivo', file);
            fd.append('cedulas', cedulas.join(','));
            
            const btn = this.querySelector('button');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...'; 
            btn.disabled = true;
            
            try {
                const res = await fetch(`${API_URL}/subir_manual`, {method:"POST", body:fd});
                const d = await res.json();
                if(d.mensaje === "OK") {
                    showToast(`Archivo asignado a ${d.asignado_a?.length || 0} estudiantes`, "success");
                    this.reset();
                    loadAllData();
                } else {
                    showToast("Error: " + (d.error || "Desconocido"), "error");
                }
            } catch(e) { 
                showToast("Error de conexión", "error");
            }
            finally { 
                btn.innerHTML = 'Asignar Manualmente'; 
                btn.disabled = false; 
            }
        };

        async function buscarCedulasPorNombres(nombres) {
            // En una implementación real, buscarías en la BD
            // Esto es un ejemplo simplificado
            const partes = nombres.split(',').map(n => n.trim().toLowerCase());
            const cedulas = [];
            
            globalUsers.forEach(user => {
                const nombreCompleto = `${user.nombre} ${user.apellido}`.toLowerCase();
                if(partes.some(parte => nombreCompleto.includes(parte))) {
                    cedulas.push(user.cedula);
                }
            });
            
            return cedulas;
        }

        // ==========================================
        // 5. EVIDENCIAS
        // ==========================================
        function renderEvidenceGrid() {
            const grid = document.getElementById('evidenceGrid');
            const filter = document.getElementById('filterEvidence').value.toLowerCase();
            grid.innerHTML = '';
            
            let filtered = globalEvidences;
            if(filter) {
                filtered = globalEvidences.filter(est => 
                    est.nombre.toLowerCase().includes(filter) || 
                    est.apellido.toLowerCase().includes(filter) ||
                    est.cedula.includes(filter)
                );
            }
            
            if(filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-sec);"><i class="fas fa-search"></i><p>No se encontraron estudiantes</p></div>';
                return;
            }
            
            filtered.forEach(est => {
                const card = document.createElement('div');
                card.className = 'folder-card';
                card.onclick = () => verEvidenciasEstudiante(est.cedula);
                card.innerHTML = `
                    <img src="${est.foto || 'https://via.placeholder.com/80'}" class="folder-img" onerror="this.src='https://via.placeholder.com/80'">
                    <div class="folder-name">${est.nombre} ${est.apellido}</div>
                    <small style="color:var(--text-sec);">${est.total_evidencias} archivos</small>
                    <small style="color:var(--primary); font-size:0.7rem;">CI: ${est.cedula}</small>
                `;
                grid.appendChild(card);
            });
        }

        async function verEvidenciasEstudiante(cedula) {
            // Implementar vista de evidencias específicas
            alert(`Función: Mostrar evidencias del estudiante ${cedula}\n\nEsta función mostraría una interfaz similar al perfil del estudiante con todas sus evidencias.`);
        }

        // ==========================================
        // 6. SOLICITUDES Y NOTIFICACIONES
        // ==========================================
        async function renderRequests() {
            const container = document.getElementById('requestsContainer');
            container.innerHTML = '';
            
            const pendientes = globalRequests.filter(r => r.Estado === 'PENDIENTE');
            
            if(pendientes.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sec);"><i class="fas fa-check-circle" style="font-size:3rem; color:var(--secondary);"></i><p style="margin-top:15px;">No hay solicitudes pendientes.</p></div>';
                return;
            }

            pendientes.forEach(req => {
                const card = document.createElement('div');
                card.style.cssText = "background:var(--bg-card); padding:20px; border-radius:12px; border-left:5px solid var(--warning); box-shadow:var(--shadow-card); margin-bottom:15px; animation:fadeIn 0.3s;";
                
                let icon = 'fa-file-alt', color = 'var(--warning)';
                if(req.Tipo === 'RECUPERACION') { icon = 'fa-key'; color = 'var(--info)'; }
                if(req.Tipo === 'REPORTE') { icon = 'fa-bug'; color = 'var(--error)'; }
                if(req.Tipo === 'SUBIDA') { icon = 'fa-cloud-upload-alt'; color = 'var(--secondary)'; }

                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
                        <div style="flex:1; min-width:300px;">
                            <h4 style="margin:0; font-size:1rem; color:${color};"><i class="fas ${icon}"></i> ${req.Tipo}</h4>
                            <small style="color:var(--text-muted);">Usuario: ${req.nombre} • ${req.fecha}</small>
                            <p style="margin-top:10px; font-size:0.9rem; color:var(--text-main);">${req.Detalle || 'Sin detalles'}</p>
                            ${req.url_archivo ? `<button onclick="previsualizarEvidencia('${req.url_archivo}')" style="background:transparent; border:none; color:var(--info); font-size:0.85rem; cursor:pointer; margin-top:5px;"><i class="fas fa-eye"></i> Previsualizar archivo adjunto</button>` : ''}
                        </div>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            ${req.Tipo === 'RECUPERACION' ? 
                                `<button onclick="responderRecuperacion(${req.id}, '${req.CI_Solicitante}', '${req.Detalle || ''}')" class="btn-primary" style="background:var(--info); padding:8px 15px; font-size:0.85rem;"><i class="fas fa-reply"></i> Responder</button>` : 
                                `<button onclick="gestionarSolicitud(${req.id}, 'APROBAR')" class="btn-primary" style="background:var(--secondary); padding:8px 15px; font-size:0.85rem;">Aprobar</button>
                                 <button onclick="gestionarSolicitud(${req.id}, 'RECHAZAR')" class="btn-primary" style="background:var(--error); padding:8px 15px; font-size:0.85rem;">Rechazar</button>`
                            }
                            <button onclick="verHistorialSolicitud(${req.id})" class="btn-primary" style="background:var(--text-sec); padding:8px 15px; font-size:0.85rem;"><i class="fas fa-history"></i> Historial</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function previsualizarEvidencia(url) {
            // Crear modal de previsualización
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal-card">
                    <button onclick="this.closest('.modal-overlay').remove()" style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
                    <h3 style="color:var(--primary); margin-bottom:15px;">Previsualización</h3>
                    <div class="preview-container">
                        ${url.includes('.jpg') || url.includes('.jpeg') || url.includes('.png') ? 
                            `<img src="${url}" class="preview-img">` : 
                            url.includes('.mp4') ? 
                            `<video src="${url}" controls class="preview-video"></video>` :
                            `<div style="padding:40px; text-align:center;"><i class="fas fa-file-alt" style="font-size:3rem; color:var(--text-sec);"></i><p>Vista previa no disponible para este tipo de archivo</p></div>`
                        }
                    </div>
                    <div style="margin-top:15px; text-align:center;">
                        <a href="${url}" target="_blank" class="btn-primary" style="display:inline-flex;"><i class="fas fa-download"></i> Descargar archivo</a>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function gestionarSolicitud(id, accion) {
            const req = globalRequests.find(r => r.id === id);
            if(!req) return;
            
            if(!confirm(`¿${accion} esta solicitud de ${req.nombre}?`)) return;
            
            const fd = new FormData();
            fd.append('id_solicitud', id);
            fd.append('accion', accion);
            fd.append('id_admin', localStorage.getItem('usuario_cedula') || 'Admin');
            
            try {
                const res = await fetch(`${API_URL}/gestionar_solicitud`, {method:"POST", body:fd});
                const data = await res.json();
                if(data.status === "ok") {
                    showToast(`Solicitud ${accion.toLowerCase()} correctamente`, "success");
                    loadAllData();
                } else {
                    showToast("Error: " + data.error, "error");
                }
            } catch(e) { 
                showToast("Error de conexión", "error");
            }
        }

        async function responderRecuperacion(id, cedula, detalle) {
            const user = globalUsers.find(u => u.cedula === cedula);
            if(!user) {
                alert("Usuario no encontrado.");
                return;
            }
            
            const nuevaPass = generarPassword();
            const mensaje = `Hola ${user.nombre},\n\nTu nueva contraseña es: ${nuevaPass}\n\nPor seguridad, cambia esta contraseña al iniciar sesión.\n\n${detalle ? `Tu mensaje: ${detalle}\n\n` : ''}Saludos,\nAdministración U.E. Despertar`;
            
            if(confirm(`¿Enviar nueva contraseña a ${user.nombre}?\n\nContraseña generada: ${nuevaPass}\n\nEsta acción también marcará la solicitud como resuelta.`)) {
                // En producción, aquí enviarías un correo real
                showToast(`Contraseña enviada a ${user.nombre}. Nueva clave: ${nuevaPass}`, "success");
                
                // Marcar como resuelta
                await gestionarSolicitud(id, 'APROBAR');
            }
        }

        function generarPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for(let i = 0; i < 10; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Dropdown Notificaciones
        function toggleNotis() {
            document.getElementById('notisDropdown').classList.toggle('active');
        }

        function renderNotis() {
            const list = document.getElementById('notisList');
            const badge = document.getElementById('notisBadge');
            const pendientes = globalRequests.filter(r => r.Estado === 'PENDIENTE');
            
            badge.innerText = pendientes.length;
            badge.style.display = pendientes.length > 0 ? 'flex' : 'none';
            
            list.innerHTML = '';
            if(pendientes.length === 0) {
                list.innerHTML = '<p style="padding:15px; text-align:center; color:var(--text-sec);">Sin novedades.</p>';
            } else {
                pendientes.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'noti-item unread';
                    item.onclick = () => { navTo('solicitudes'); toggleNotis(); };
                    item.innerHTML = `
                        <i class="fas fa-exclamation-circle" style="color:var(--warning); margin-top:3px;"></i>
                        <div style="flex:1;">
                            <div style="font-weight:600;">${p.Tipo} - ${p.nombre}</div>
                            <div style="font-size:0.8rem; color:var(--text-sec);">${p.Detalle?.substring(0, 50) || 'Sin detalles'}...</div>
                            <div style="font-size:0.7rem; color:var(--text-muted); margin-top:2px;">${p.fecha}</div>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
        }

        // ==========================================
        // 7. SEGURIDAD Y LOGS
        // ==========================================
        async function loadLogs() {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Cargando logs...</td></tr>';
            try {
                const res = await fetch(`${API_URL}/obtener_logs?t=${Date.now()}`);
                globalLogs = await res.json();
                renderLogs();
            } catch(e) { 
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:var(--error);">Error cargando logs</td></tr>';
            }
        }

        function renderLogs() {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '';
            
            globalLogs.forEach(l => {
                tbody.innerHTML += `
                    <tr>
                        <td>${l.fecha}</td>
                        <td><span style="font-weight:600; color:${getColorByAction(l.accion)}">${l.accion}</span></td>
                        <td>${l.detalle}</td>
                        <td>${extractUserFromDetail(l.detalle) || 'Sistema'}</td>
                    </tr>
                `;
            });
        }

        function getColorByAction(accion) {
            if(accion.includes('ELIMIN') || accion.includes('ERROR')) return 'var(--error)';
            if(accion.includes('REGISTRO') || accion.includes('APROB')) return 'var(--secondary)';
            if(accion.includes('LOGIN') || accion.includes('SUBIDA')) return 'var(--info)';
            return 'var(--text-main)';
        }

        function extractUserFromDetail(detalle) {
            const match = detalle.match(/\((.*?)\)/);
            return match ? match[1] : null;
        }

        function filterLogs() {
            const q = document.getElementById('searchLogs').value.toLowerCase();
            const rows = document.querySelectorAll('#logsTableBody tr');
            rows.forEach(r => {
                const txt = r.innerText.toLowerCase();
                r.style.display = txt.includes(q) ? '' : 'none';
            });
        }

        // Cambiar contraseña de usuario
        document.getElementById('formCambiarPassword').onsubmit = async function(e) {
            e.preventDefault();
            if(!selectedUserForPassword) {
                alert("Selecciona un usuario primero.");
                return;
            }
            
            const nuevaPass = document.getElementById('nuevaPassword').value;
            if(nuevaPass.length < 6) {
                alert("La contraseña debe tener al menos 6 caracteres.");
                return;
            }
            
            if(confirm(`¿Cambiar contraseña de ${selectedUserForPassword.nombre} a: ${nuevaPass}?`)) {
                // En producción, enviarías esto al backend
                showToast(`Contraseña cambiada para ${selectedUserForPassword.nombre}. Nueva clave: ${nuevaPass}`, "success");
                this.reset();
                selectedUserForPassword = null;
            }
        };

        function sugerirUsuariosPass(input) {
            const suggestions = document.getElementById('suggestionsPass');
            const query = input.value.toLowerCase();
            
            if(query.length < 2) {
                suggestions.style.display = 'none';
                return;
            }
            
            const matches = globalUsers.filter(u => 
                u.nombre.toLowerCase().includes(query) || 
                u.apellido.toLowerCase().includes(query) ||
                u.cedula.includes(query)
            ).slice(0, 5);
            
            if(matches.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            suggestions.innerHTML = matches.map(u => `
                <div onclick="seleccionarUsuarioPass('${u.cedula}')" style="padding:8px 12px; cursor:pointer; border-bottom:1px solid var(--border-color);">
                    ${u.nombre} ${u.apellido} <small style="color:var(--text-sec);">(${u.cedula})</small>
                </div>
            `).join('');
            suggestions.style.display = 'block';
        }

        function seleccionarUsuarioPass(cedula) {
            const user = globalUsers.find(u => u.cedula === cedula);
            if(user) {
                selectedUserForPassword = user;
                document.getElementById('nombrePassword').value = `${user.nombre} ${user.apellido} (${user.cedula})`;
                document.getElementById('suggestionsPass').style.display = 'none';
            }
        }

        // ==========================================
        // 8. MANTENIMIENTO Y RESPALDOS
        // ==========================================
        function downloadBackup(type) {
            const url = type === 'db' ? '/crear_backup' : '/descargar_multimedia_zip';
            
            // Usar descarga directa sin abrir nueva pestaña
            const a = document.createElement('a');
            a.href = API_URL + url;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast(`Descarga de ${type === 'db' ? 'base de datos' : 'multimedia'} iniciada`, "info");
        }

        function optimizarSistema() {
            if(confirm("¿Optimizar sistema y limpiar caché?")) {
                showToast("Sistema optimizado. Cache limpiada.", "success");
            }
        }

        function analizarDuplicados() {
            showToast("Analizando archivos duplicados...", "info");
            // En producción, conectarías con el backend
            setTimeout(() => {
                showToast("Análisis completado: 0 archivos duplicados encontrados", "success");
            }, 2000);
        }

        function limpiarCache() {
            if(confirm("¿Limpiar caché del sistema?")) {
                showToast("Caché limpiada correctamente", "success");
            }
        }

        function limpiarHuérfanos() {
            showToast("Buscando archivos huérfanos...", "info");
            // En producción, conectarías con el backend
            setTimeout(() => {
                showToast("0 archivos huérfanos encontrados", "success");
            }, 2000);
        }

        // ==========================================
        // 9. FUNCIONES AUXILIARES
        // ==========================================
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = document.querySelector('#themeBtn i');
            if(document.body.classList.contains('dark-mode')) {
                localStorage.setItem('global_theme', 'dark');
                icon.className = 'fas fa-sun';
            } else {
                localStorage.setItem('global_theme', 'light');
                icon.className = 'fas fa-moon';
            }
        }

        function initTheme() {
            const saved = localStorage.getItem('global_theme');
            const icon = document.querySelector('#themeBtn i');
            if(saved === 'dark') {
                document.body.classList.add('dark-mode');
                icon.className = 'fas fa-sun';
            } else {
                document.body.classList.remove('dark-mode');
                icon.className = 'fas fa-moon';
            }
        }

        function cerrarSesion() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        function abrirModalAgregarRef() {
            const select = document.getElementById('selectUsuarioRef');
            select.innerHTML = '<option value="">-- Seleccionar --</option>' +
                globalUsers.filter(u => u.tipo == 1).map(u => 
                    `<option value="${u.cedula}">${u.nombre} ${u.apellido} (${u.cedula})</option>`
                ).join('');
            document.getElementById('modalAgregarRef').classList.add('active');
        }

        document.getElementById('formAgregarRef').onsubmit = async function(e) {
            e.preventDefault();
            const cedula = document.getElementById('selectUsuarioRef').value;
            const fileInput = document.getElementById('fotoRef');
            
            if(!cedula || !fileInput.files.length) {
                alert("Completa todos los campos.");
                return;
            }
            
            const fd = new FormData();
            fd.append('cedula', cedula);
            fd.append('foto', fileInput.files[0]);
            
            try {
                const res = await fetch(`${API_URL}/agregar_referencia_facial`, {method:"POST", body:fd});
                const data = await res.json();
                if(data.mensaje) {
                    showToast("Foto de referencia agregada correctamente", "success");
                    closeModal('modalAgregarRef');
                    this.reset();
                } else {
                    showToast("Error: " + data.error, "error");
                }
            } catch(e) {
                showToast("Error de conexión", "error");
            }
        };

        function mostrarHistorialSolicitudes() {
            const historial = globalRequests.filter(r => r.Estado !== 'PENDIENTE');
            const content = document.getElementById('historialContent');
            
            if(historial.length === 0) {
                content.innerHTML = '<p style="text-align:center; padding:20px; color:var(--text-sec);">No hay historial de solicitudes</p>';
            } else {
                content.innerHTML = historial.map(r => `
                    <div style="padding:12px; border-bottom:1px solid var(--border-color);">
                        <div style="font-weight:600; color:${r.Estado === 'APROBAR' ? 'var(--secondary)' : 'var(--error)'};">${r.Tipo} - ${r.nombre}</div>
                        <div style="font-size:0.85rem; color:var(--text-sec);">${r.Detalle?.substring(0, 60) || 'Sin detalles'}...</div>
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-top:5px;">
                            ${r.fecha} • Estado: ${r.Estado}
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('modalHistorial').classList.add('active');
        }

        function verHistorialSolicitud(id) {
            const req = globalRequests.find(r => r.id === id);
            if(req) {
                alert(`Historial de solicitud #${id}\n\nUsuario: ${req.nombre}\nTipo: ${req.Tipo}\nEstado: ${req.Estado}\nFecha: ${req.fecha}\nDetalles: ${req.Detalle || 'Sin detalles'}`);
            }
        }

        function cambiarContraseñaUsuario() {
            alert("Para cambiar contraseña, ve a la pestaña 'Seguridad / Logs' y usa el formulario 'Cambiar Contraseña de Usuario'.");
            navTo('seguridad');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showToast(mensaje, tipo = 'info') {
            // Implementación simple de toast
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; bottom: 20px; right: 20px; 
                padding: 12px 20px; border-radius: 8px; z-index: 9999;
                color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: fadeInUp 0.3s;
                background: ${tipo === 'success' ? 'var(--secondary)' : tipo === 'error' ? 'var(--error)' : 'var(--info)'};
            `;
            toast.innerHTML = `<i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${mensaje}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Cerrar modales al hacer clic fuera
        document.addEventListener('click', (e) => {
            if(e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        });

    </script>
</body>
</html>