<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Panel de Administración - Gestión Educativa Avanzada">
    <meta name="theme-color" content="#6A0DAD">
    
    <title>Panel de Administración | U.E. Despertar</title>
    
    <link rel="icon" type="image/png" href="Img/Logo_pestaña.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ==========================================================================
           1. VARIABLES Y SISTEMA DE DISEÑO
           ========================================================================== */
        :root {
            --primary: #6A0DAD;       
            --primary-dark: #4a0072;  
            --primary-light: #9d46ff; 
            --primary-soft: rgba(106, 13, 173, 0.08);
            
            --secondary: #2E8B57;     
            --secondary-hover: #1e5e3a;
            
            --error: #d32f2f;         
            --warning: #f9a825;       
            --info: #0288d1;          
            
            --bg-image: url('Img/Claro.png'); 
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --bg-header: rgba(255, 255, 255, 0.95);
            --bg-sidebar: #ffffff;
            --bg-input: #f8f9fa;
            
            --text-main: #2c3e50;
            --text-sec: #5f6368;
            --text-muted: #9aa0a6;
            --text-inverse: #ffffff;
            
            --border-color: #e0e0e0;
            
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
            --shadow-card: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-hover: 0 10px 25px rgba(106, 13, 173, 0.15);
            --shadow-nav: 0 2px 15px rgba(0,0,0,0.05);
            
            --header-height: 80px;
            --header-height-mobile: 70px;
            --sidebar-width: 280px;
            --border-radius: 16px;
            --transition-speed: 0.3s;
        }

        body.dark-mode {
            --bg-image: url('Img/Oscuro.png');
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --bg-header: rgba(30, 30, 30, 0.95);
            --bg-sidebar: #1e1e1e;
            --bg-input: #2d2d2d;
            
            --text-main: #e8eaed;
            --text-sec: #b0b3b8;
            --text-muted: #6e7175;
            
            --border-color: #3c4043;
            
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.4);
            --shadow-hover: 0 10px 30px rgba(0,0,0,0.6);
        }

        /* ==========================================================================
           2. RESET & BASE
           ========================================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            background-image: var(--bg-image);
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            color: var(--text-main);
            padding-top: var(--header-height);
            transition: background var(--transition-speed), color var(--transition-speed);
            min-height: 100vh;
            display: flex; flex-direction: column;
            overflow-x: hidden;
        }

        a { text-decoration: none; color: inherit; transition: var(--transition-speed); }
        ul { list-style: none; }
        button, input, select, textarea { font-family: inherit; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-dark); }

        /* ==========================================================================
           3. HEADER (IDÉNTICO AL ESTUDIANTE)
           ========================================================================== */
        .main-header {
            position: fixed; top: 0; left: 0; width: 100%;
            height: var(--header-height);
            background: var(--bg-header);
            border-bottom: 3px solid var(--primary);
            box-shadow: var(--shadow-nav);
            z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 5%;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .logo-container img {
            height: 50px; width: auto;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .logo-container img:hover { transform: scale(1.05); }

        .header-actions { display: flex; align-items: center; gap: 15px; }

        .btn-icon-header {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer;
            transition: 0.3s;
            position: relative;
        }
        .btn-icon-header:hover {
            background: var(--primary-soft);
            transform: rotate(15deg);
        }

        .noti-badge {
            position: absolute; top: -5px; right: -5px;
            background: var(--error); color: white;
            font-size: 0.7rem; font-weight: 700;
            width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--bg-header);
        }

        .btn-logout-header {
            background: var(--error); color: white; border: none;
            padding: 0 25px; height: 42px; border-radius: 50px;
            font-weight: 600; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            transition: 0.3s;
        }
        .btn-logout-header:hover {
            background: #b71c1c; transform: translateY(-2px);
        }

        .menu-toggle {
            background: none; border: none; font-size: 1.8rem;
            color: var(--primary); cursor: pointer;
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            display: none;
        }

        .notis-dropdown {
            position: absolute; top: 60px; right: 0;
            width: 320px; max-height: 400px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            z-index: 1100;
            display: none; flex-direction: column; overflow: hidden;
        }
        .notis-dropdown.active { display: flex; }
        .noti-item {
            padding: 12px; border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem; cursor: pointer; transition: 0.2s;
            display: flex; gap: 10px; align-items: start;
        }
        .noti-item:hover { background: var(--bg-input); }
        .noti-item.unread { background: var(--primary-soft); border-left: 3px solid var(--primary); }

        /* ==========================================================================
           4. MENÚ LATERAL
           ========================================================================== */
        .sidebar-container {
            position: fixed; top: var(--header-height); left: 0;
            width: var(--sidebar-width); height: calc(100vh - var(--header-height));
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 20px; overflow-y: auto; z-index: 900;
            transition: transform 0.3s ease;
        }

        .sidebar-menu { list-style: none; display: flex; flex-direction: column; gap: 8px; }
        .sidebar-btn {
            width: 100%; text-align: left; background: transparent; border: none;
            padding: 12px 15px; border-radius: 10px;
            color: var(--text-sec); font-size: 0.95rem; font-weight: 500;
            cursor: pointer; display: flex; align-items: center; gap: 15px;
            transition: all 0.2s;
        }
        .sidebar-btn i { width: 20px; text-align: center; font-size: 1.1rem; }
        .sidebar-btn:hover { background: var(--bg-input); color: var(--primary); }
        .sidebar-btn.active { background: var(--primary); color: white; }

        /* ==========================================================================
           5. CONTENIDO PRINCIPAL
           ========================================================================== */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
            min-height: calc(100vh - var(--header-height) - 100px);
            transition: margin-left 0.3s ease;
        }

        .panel-section { display: none; }
        .panel-section.active { 
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-card); padding: 25px; border-radius: var(--border-radius);
            box-shadow: var(--shadow-card); border: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 20px; transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        .stat-icon {
            width: 50px; height: 50px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; color: white;
        }
        .stat-details h3 { font-size: 1.8rem; font-weight: 700; margin: 0; color: var(--text-main); }
        .stat-details p { font-size: 0.9rem; color: var(--text-sec); margin: 0; }
        
        .bg-purple { background: linear-gradient(135deg, #6A0DAD, #9d46ff); }
        .bg-green { background: linear-gradient(135deg, #2E8B57, #66bb6a); }
        .bg-blue { background: linear-gradient(135deg, #0288d1, #29b6f6); }
        .bg-orange { background: linear-gradient(135deg, #f57c00, #ffa726); }

        /* Calculadora real */
        .storage-calc {
            background: var(--bg-card); padding: 25px; border-radius: var(--border-radius);
            border: 1px solid var(--border-color); margin-bottom: 30px;
        }
        .storage-bar-bg { width: 100%; height: 10px; background: var(--bg-input); border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .storage-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 1s ease; }
        .cost-display { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-sec); }
        .cost-highlight { color: var(--text-main); font-weight: bold; font-size: 1.1rem; }

        /* Tablas - MEJORADO con responsive */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
        }
        .modern-table-wrapper {
            background: var(--bg-card); border-radius: var(--border-radius);
            overflow: hidden; border: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
            width: 100%;
        }
        .modern-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .modern-table th {
            background: var(--primary); color: white; padding: 15px; text-align: left;
            font-weight: 600; font-size: 0.9rem; position: sticky; top: 0;
        }
        .modern-table td {
            padding: 15px; border-bottom: 1px solid var(--border-color);
            color: var(--text-main); font-size: 0.9rem;
        }
        .modern-table tr:hover { background: var(--bg-input); }

        .action-btn {
            border: none; width: 32px; height: 32px; border-radius: 8px;
            cursor: pointer; font-size: 0.9rem; margin-right: 5px; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-edit { background: rgba(255, 193, 7, 0.15); color: #ff9800; } 
        .btn-edit:hover { background: #ff9800; color: white; }
        .btn-delete { background: rgba(244, 67, 54, 0.15); color: #f44336; } 
        .btn-delete:hover { background: #f44336; color: white; }
        .btn-view { background: rgba(33, 150, 243, 0.15); color: #2196F3; } 
        .btn-view:hover { background: #2196F3; color: white; }
        .btn-activate { background: rgba(46, 139, 87, 0.15); color: #2E8B57; }
        .btn-activate:hover { background: #2E8B57; color: white; }
        .btn-deactivate { background: rgba(245, 40, 40, 0.15); color: #f52828; }
        .btn-deactivate:hover { background: #f52828; color: white; }

        /* Formularios */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            border-radius: 10px; background: var(--bg-input); color: var(--text-main);
            transition: 0.3s;
        }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }
        
        .btn-primary {
            background: var(--primary); color: white; border: none;
            padding: 12px 24px; border-radius: 10px; font-weight: 600;
            cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }

        /* Grid evidencias */
        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px; min-height: 300px; padding-bottom: 120px; position: relative;
        }

        .evidence-card {
            background: var(--bg-card); border-radius: 12px;
            overflow: hidden; aspect-ratio: 1; position: relative;
            cursor: pointer; box-shadow: var(--shadow-soft);
            border: 2px solid transparent;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .evidence-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-hover); z-index: 2; }
        
        .card-media { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .evidence-card:hover .card-media { transform: scale(1.05); }

        .video-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            display:flex; align-items:center; justify-content:center;
            color: white; font-size: 3rem; background: rgba(0,0,0,0.3); opacity: 0.8;
        }

        .selection-check {
            position: absolute; top: 12px; right: 12px; width: 28px; height: 28px;
            background: rgba(255,255,255,0.95); border: 2px solid #ccc;
            border-radius: 50%; color: var(--primary); display: none; 
            align-items: center; justify-content: center; z-index: 10; font-size: 1rem;
        }
        .evidence-card.selected { border-color: var(--primary); transform: scale(0.95); background: var(--primary-soft); }
        .evidence-card.selected .selection-check { display: flex; background: var(--primary); color: white; border-color: var(--primary); }
        .selection-mode-active .selection-check { display: flex; }

        .empty-state {
            grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 60px 20px; color: var(--text-sec); display: none;
            min-height: 300px;
        }

        /* Lightbox mejorado - CON BOTÓN ELIMINAR */
        .lightbox-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 5000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .lightbox-modal.active { display: flex; opacity: 1; }

        .lb-content-wrapper {
            position: relative; width: 100%; height: 80%;
            display: flex; justify-content: center; align-items: center; pointer-events: none; 
        }
        .lb-media-item {
            max-width: 90%; max-height: 100%; border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); object-fit: contain;
            pointer-events: auto;
        }

        .lb-close-fixed {
            position: absolute; top: 30px; right: 30px;
            background: rgba(255,255,255,0.15); color: white; border: none;
            padding: 12px 24px; border-radius: 30px; font-weight: bold;
            cursor: pointer; z-index: 5005; display: flex; align-items: center; gap: 10px;
        }

        .lb-nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 70px; height: 70px; background: rgba(255,255,255,0.08);
            color: white; border: none; border-radius: 50%; font-size: 2rem;
            cursor: pointer; z-index: 5005; transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .lb-nav-btn:hover { background: var(--primary); transform: translateY(-50%) scale(1.1); }
        .lb-prev { left: 40px; }
        .lb-next { right: 40px; }

        .lb-actions-panel {
            margin-top: 25px; display: flex; gap: 20px; z-index: 5005; 
            pointer-events: auto; flex-wrap: wrap; justify-content: center;
        }
        .btn-lb-action {
            padding: 12px 30px; border-radius: 30px; font-weight: bold;
            cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 10px;
            border: none; font-size: 1rem; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-lb-action:hover { transform: translateY(-3px); }
        .btn-lb-delete {
            background: var(--error); color: white; border: none;
        }

        /* Barra flotante para selección múltiple - MEJORADA */
        .floating-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px);
            background: #222; color: white; padding: 15px 30px; border-radius: 50px;
            display: flex; align-items: center; gap: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.6); z-index: 4000;
            width: 90%; max-width: 650px; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .floating-bar.active { transform: translateX(-50%) translateY(0); }

        .btn-float {
            background: var(--primary); color: white; border: none;
            padding: 10px 24px; border-radius: 25px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; gap: 10px; font-size: 0.95rem; transition: 0.3s;
        }
        .btn-float:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-float.danger { background: var(--error); }
        
        .btn-float-cancel {
            background: transparent; color: white; border: 2px solid white;
            width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.3s; margin-left: 10px;
        }
        .btn-float-cancel:hover {
            background: white; color: #222; transform: rotate(90deg);
        }

        /* Botón de retroceso */
        .btn-back {
            background: var(--bg-card); border: 1px solid var(--border-color);
            color: var(--text-main); padding: 10px 20px; border-radius: 30px;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            font-weight: 600; transition: 0.3s; margin-bottom: 20px;
        }
        .btn-back:hover {
            background: var(--primary); color: white; border-color: var(--primary);
            transform: translateX(-5px);
        }

        /* Vista de evidencias por estudiante */
        .student-evidence-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 25px; flex-wrap: wrap; gap: 15px;
        }
        .student-info-card {
            background: var(--bg-card); padding: 20px; border-radius: var(--border-radius);
            display: flex; align-items: center; gap: 20px; margin-bottom: 25px;
            border: 1px solid var(--border-color); box-shadow: var(--shadow-soft);
        }
        .student-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            object-fit: cover; border: 3px solid var(--primary);
        }

        /* Modales */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 5000; display: none; 
            justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-card {
            background: var(--bg-card); width: 95%; max-width: 500px;
            border-radius: 16px; padding: 30px; position: relative;
            max-height: 90vh; overflow-y: auto;
        }

        /* Footer */
        footer {
            background: #1a1a1a; color: white; padding: 30px 20px;
            text-align: center; margin-top: auto; border-top: 4px solid var(--primary);
        }
        .footer-logo Img { height: 60px; margin-bottom: 10px; }
        .footer-social { margin: 20px 0; }
        .footer-social a { 
            display: inline-flex; width: 40px; height: 40px; 
            background: #333; color: white; border-radius: 50%; 
            align-items: center; justify-content: center; margin: 0 8px; 
            text-decoration: none; transition: 0.3s;
        }
        .footer-social a:hover { background: var(--primary); transform: translateY(-3px); }
        .footer-links a { color: #aaa; text-decoration: none; margin: 0 10px; }
        .footer-links a:hover { color: var(--primary); }
        .copyright { font-size: 0.85rem; color: #888; border-top: 1px solid #333; padding-top: 15px; }

        /* Dropdown para acciones móviles */
        .mobile-actions-dropdown {
            position: relative; display: none;
        }
        .mobile-actions-btn {
            background: var(--primary); color: white; border: none;
            padding: 8px 16px; border-radius: 8px; font-size: 0.9rem;
            cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .mobile-actions-menu {
            position: absolute; top: 100%; right: 0; background: var(--bg-card);
            border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow-soft);
            min-width: 150px; z-index: 100; display: none;
        }
        .mobile-actions-menu.active { display: block; }
        .mobile-action-item {
            padding: 10px 15px; display: flex; align-items: center; gap: 10px;
            cursor: pointer; transition: 0.2s; border-bottom: 1px solid var(--border-color);
        }
        .mobile-action-item:hover { background: var(--bg-input); }
        .mobile-action-item:last-child { border-bottom: none; }

        /* Solicitudes mejoradas */
        .request-card {
            background: var(--bg-card); border-radius: var(--border-radius);
            padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
        }
        .request-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; flex-wrap: wrap; gap: 10px;
        }
        .request-badge {
            padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
        }
        .badge-pending { background: rgba(249, 168, 37, 0.15); color: var(--warning); }
        .badge-resolved { background: rgba(46, 139, 87, 0.15); color: var(--secondary); }
        .badge-rejected { background: rgba(211, 47, 47, 0.15); color: var(--error); }
        .request-actions {
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        .request-preview {
            max-width: 200px; max-height: 200px; border-radius: 8px;
            margin-top: 10px; cursor: pointer; border: 1px solid var(--border-color);
        }

        /* Estilos para SweetAlert modal personalizado */
        .swal2-popup .swal2-content {
            color: #333 !important;
            text-align: left !important;
        }
        
        .swal2-popup .swal2-content div {
            margin-bottom: 10px;
        }
        
        .swal2-popup .swal2-content img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* ==========================================================================
           6. RESPONSIVE (MEJORADO)
           ========================================================================== */
        @media (max-width: 992px) {
            .sidebar-container { transform: translateX(-100%); width: 280px; }
            .sidebar-container.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 20px 15px; }
            .menu-toggle { display: flex; }
            
            .main-header { padding: 0 15px; height: var(--header-height-mobile); }
            .logo-container img { height: 40px; }
            .btn-logout-header span { display: none; }
            .btn-logout-header { padding: 0 15px; }
            
            .stat-card { flex-direction: column; text-align: center; padding: 15px; }
            .stat-details h3 { font-size: 1.5rem; }
            
            .btn-primary { padding: 10px 18px; font-size: 0.9rem; }
            .action-btn { width: 36px; height: 36px; margin-right: 3px; }
            .form-grid { grid-template-columns: 1fr; }
            .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
            .cost-display { flex-direction: column; gap: 10px; }
            
            /* Tablas responsivas */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .modern-table { min-width: 800px; }
            
            /* Lightbox móvil */
            .lb-nav-btn { display: none; } 
            .lb-close-fixed { top: 15px; right: 15px; padding: 8px 15px; font-size: 0.9rem; }
            .lb-media-item { max-width: 100%; border-radius: 0; }
            .lb-actions-panel { flex-direction: column; width: 90%; gap: 12px; }
            .btn-lb-action { width: 100%; justify-content: center; }
            
            /* Barra flotante móvil */
            .floating-bar { 
                flex-direction: column; width: 100%; border-radius: 20px 20px 0 0;
                padding: 20px; gap: 15px; bottom: 0; left: 0; transform: translateY(100%); max-width: 100%;
            }
            .floating-bar.active { transform: translateY(0); }
            .floating-bar div { text-align: center; width: 100%; margin-bottom: 5px; }
            .btn-float { width: 100%; justify-content: center; }
            .btn-float-cancel { align-self: flex-end; margin-top: 10px; }
            
            /* Botón de retroceso en móvil */
            .btn-back.desktop-only { display: none; }
            
            /* Mostrar dropdown de acciones en móvil */
            .mobile-actions-dropdown { display: block; }
        }

        @media (max-width: 480px) {
            .header-actions { gap: 8px; }
            .btn-icon-header { width: 38px; height: 38px; font-size: 1rem; }
            .notis-dropdown { width: 280px; }
            .modal-card { padding: 20px 15px; }
            .storage-calc { padding: 20px 15px; }
            .modern-table { font-size: 0.8rem; }
            .modern-table th, .modern-table td { padding: 10px 8px; }
            
            /* Ocultar botones de acción individuales en móvil */
            .action-btn { display: none; }
            .mobile-actions-dropdown { display: block; }
            
            .student-info-card { flex-direction: column; text-align: center; }
            .student-avatar { width: 100px; height: 100px; }
        }

        @media (min-width: 481px) {
            .mobile-actions-dropdown { display: none; }
        }
        
        .modal-card textarea {
            resize: vertical;
            min-height: 100px;
        }

        .request-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }

        .request-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Estilos para los tipos de solicitud */
        .solicitud-tipo {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .tipo-reporte {
            background: rgba(211, 47, 47, 0.1);
            color: var(--error);
        }

        .tipo-problema {
            background: rgba(249, 168, 37, 0.1);
            color: var(--warning);
        }

        .tipo-subida {
            background: rgba(33, 150, 243, 0.1);
            color: var(--info);
        }

        .tipo-contrasena {
            background: rgba(106, 13, 173, 0.1);
            color: var(--primary);
        }
        
        /* Estilos para el modal de responder */
        .respuesta-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .respuesta-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            color: var(--text-main);
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
        }
        
        .respuesta-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-soft);
        }
        .drop-zone {
            border: 2px dashed var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        .drop-zone.drag-over {
            border-color: var(--primary);
            background: rgba(106, 13, 173, 0.05); /* var(--primary-soft) */
            transform: scale(1.01);
            box-shadow: 0 0 15px rgba(106, 13, 173, 0.2);
        }
        /* Hacemos que el contenido no interfiera con el arrastre */
        .drop-zone * {
            pointer-events: none;
        }
        /* PERMITIMOS INTERACCIÓN EN BOTONES, INPUTS Y EL LOG (SCROLL) */
        .drop-zone button, 
        .drop-zone input, 
        .drop-zone #uploadLog {   /* <--- ESTA ES LA CLAVE */
            pointer-events: auto;
        }
        .modal-overlay {
        z-index: 10000 !important; /* Fuerza al modal a estar encima de todo */
    }

    /* ESTILO PARA SELECCIONAR VARIOS USUARIOS */
    .usuario-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
    }
    .usuario-item:hover {
        background-color: #f5f5f5;
    }
    .usuario-item.seleccionado {
        background-color: #e0f7fa; /* Azul claro cuando está seleccionado */
        border-left: 4px solid var(--info);
    }
    </style>
</head>

<body>
    <!-- HEADER IDÉNTICO AL PERFIL ESTUDIANTE -->
    <header class="main-header">
        <div class="logo-container">
            <a href="index.html">
                <img src="Img/Logo-Despertar-SKAS-Unidad-Educativa23.png" alt="Logo">
            </a>
        </div>
        <div class="header-actions">
            <button onclick="toggleTheme()" class="btn-icon-header" id="themeBtn" title="Cambiar Tema">
                <i class="fas fa-moon"></i>
            </button>

            <div style="position:relative;">
                <button class="btn-icon-header" onclick="toggleNotis()" title="Notificaciones">
                    <i class="fas fa-bell"></i>
                    <span id="notisBadge" class="noti-badge" style="display:none;">0</span>
                </button>
                <div id="notisDropdown" class="notis-dropdown">
                    <div style="padding:15px; background:var(--bg-input); font-weight:bold; border-bottom:1px solid var(--border-color);">
                        Solicitudes Pendientes
                    </div>
                    <div id="notisList" style="max-height:300px; overflow-y:auto;">
                        <p style="padding:20px; text-align:center; color:var(--text-sec);">Cargando...</p>
                    </div>
                </div>
            </div>

            <button onclick="cerrarSesion()" class="btn-logout-header" title="Cerrar Sesión">
                <i class="fas fa-sign-out-alt"></i> <span>Salir</span>
            </button>

            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- MENÚ LATERAL -->
    <nav class="sidebar-container" id="sidebar">
        <div style="margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid var(--border-color);">
            <h4 style="color:var(--primary); font-weight:700;">Panel Admin</h4>
            <p style="font-size:0.85rem; color:var(--text-sec);">Gestión Integral</p>
        </div>
        <ul class="sidebar-menu">
            <li><button class="sidebar-btn active" onclick="navTo('dashboard', this)"><i class="fas fa-chart-line"></i> Resumen</button></li>
            <li><button class="sidebar-btn" onclick="navTo('usuarios', this)"><i class="fas fa-users-cog"></i> Usuarios</button></li>
            <li><button class="sidebar-btn" onclick="navTo('upload', this)"><i class="fas fa-cloud-upload-alt"></i> Subir Archivos</button></li>
            <li><button class="sidebar-btn" onclick="navTo('evidencias', this)"><i class="fas fa-folder-open"></i> Evidencias</button></li>
            <li><button class="sidebar-btn" onclick="navTo('solicitudes', this)"><i class="fas fa-inbox"></i> Solicitudes</button></li>
            <li><button class="sidebar-btn" onclick="navTo('seguridad', this)"><i class="fas fa-shield-alt"></i> Seguridad / Logs</button></li>
            <li><button class="sidebar-btn" onclick="navTo('mantenimiento', this)"><i class="fas fa-server"></i> Mantenimiento</button></li>
        </ul>
        <div style="margin-top:auto; padding-top:20px; border-top:1px solid var(--border-color);">
            <small style="color:var(--text-muted); display:block; margin-bottom:5px;">Espacio Estimado:</small>
            <div style="background:var(--bg-input); border-radius:4px; height:6px; overflow:hidden;">
                <div id="sidebarStorageBar" style="width:0%; background:var(--secondary); height:100%;"></div>
            </div>
            <small id="sidebarStorageText" style="color:var(--text-main); font-weight:bold;">0 GB usados</small>
        </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="main-content" id="mainContainer">
        
        <!-- PANEL: DASHBOARD -->
        <section id="panel-dashboard" class="panel-section active">
            <h2 style="margin-bottom:25px; color:var(--primary);">Panel de Control</h2>
            
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-purple"><i class="fas fa-users"></i></div>
                    <div class="stat-details">
                        <h3 id="statUsers">0</h3>
                        <p>Usuarios Activos</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-orange"><i class="fas fa-bell"></i></div>
                    <div class="stat-details">
                        <h3 id="statReqs">0</h3>
                        <p>Solicitudes Pendientes</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-green"><i class="fas fa-database"></i></div>
                    <div class="stat-details">
                        <h3 id="statFiles">0</h3>
                        <p>Evidencias Totales</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-blue"><i class="fas fa-hdd"></i></div>
                    <div class="stat-details">
                        <h3 id="statSize">0 GB</h3>
                        <p>Almacenamiento</p>
                    </div>
                </div>
            </div>

            <!-- CALCULADORA REAL CON DATOS PRECISOS -->
            <div class="storage-calc">
                <h3 style="font-size:1.1rem; margin-bottom:10px;"><i class="fas fa-calculator"></i> Estimación de Costos (Backblaze B2)</h3>
                <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:15px;">
                    Datos reales de Backblaze:<br>
                    • $0.005/GB al mes<br>
                    • Primeros 10GB gratuitos<br>
                    • Transferencia saliente: $0.01/GB
                </p>
                
                <div class="storage-bar-bg">
                    <div id="mainStorageBar" class="storage-bar-fill"></div>
                </div>
                
                <div class="cost-display">
                    <span>Uso Actual: <strong id="realSizeDisplay">0 GB</strong></span>
                    <span>Costo Mensual: <span id="monthlyCost" class="cost-highlight">$0.00</span></span>
                    <span>Costo Anual: <span id="yearlyCost" class="cost-highlight">$0.00</span></span>
                </div>
                
                <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn-primary" onclick="analizarDuplicados()" style="background:var(--secondary);">
                        <i class="fas fa-broom"></i> Analizar Duplicados
                    </button>
                    <button class="btn-primary" onclick="limpiarCache()" style="background:var(--text-sec);">
                        <i class="fas fa-wind"></i> Limpiar Caché
                    </button>
                    <button class="btn-primary" onclick="limpiarHuerfanos()" style="background:var(--error);">
                        <i class="fas fa-trash-alt"></i> Limpiar Huérfanos
                    </button>
                </div>
            </div>

            <!-- ACCIONES RÁPIDAS -->
            <div class="storage-calc">
                <h3 style="font-size:1.1rem; margin-bottom:15px; color:var(--primary);">
                    <i class="fas fa-bolt"></i> Acciones Rápidas
                </h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                    <button class="btn-primary" onclick="navTo('usuarios')" style="background:var(--info);">
                        <i class="fas fa-user-plus"></i> Registrar Usuario
                    </button>
                    <button class="btn-primary" onclick="navTo('upload')" style="background:var(--warning); color:#333;">
                        <i class="fas fa-cloud-upload-alt"></i> Subir con IA
                    </button>
                    <button class="btn-primary" onclick="navTo('evidencias')" style="background:var(--secondary);">
                        <i class="fas fa-search"></i> Buscar Evidencias
                    </button>
                    <button class="btn-primary" onclick="navTo('seguridad')">
                        <i class="fas fa-key"></i> Cambiar Contraseña
                    </button>
                </div>
            </div>
        </section>

        <!-- PANEL: USUARIOS -->
        <section id="panel-usuarios" class="panel-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h2 style="color:var(--primary); margin:0;">Gestión de Usuarios</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" onclick="abrirModalAgregarRef()">
                        <i class="fas fa-camera"></i> Agregar Foto Ref.
                    </button>
                </div>
            </div>

            <!-- FORMULARIO REGISTRO -->
            <div class="storage-calc" style="margin-bottom:30px;">
                <h4 style="margin-bottom:15px; color:var(--primary);">Registrar Nuevo Usuario</h4>
                <form id="formRegistro">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" name="nombre" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Apellido *</label>
                            <input type="text" name="apellido" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Cédula * (10 dígitos)</label>
                            <input type="text" name="cedula" class="form-control" pattern="\d{10}" 
                                   title="10 dígitos numéricos" required maxlength="10">
                        </div>
                        <div class="form-group">
                            <label>Contraseña * (Mínimo 6 caracteres)</label>
                            <input type="password" name="contrasena" class="form-control" 
                                   minlength="6" required>
                            <small style="color:var(--text-sec); font-size:0.85rem;">La contraseña debe tener al menos 6 caracteres</small>
                        </div>
                        <div class="form-group">
                            <label>Rol *</label>
                            <select name="tipo_usuario" class="form-control">
                                <option value="1">Estudiante</option>
                                <option value="0">Administrador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Foto de Perfil *</label>
                            <input type="file" name="foto" class="form-control" accept="image/*" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top:15px;">
                        <i class="fas fa-user-plus"></i> Guardar Usuario
                    </button>
                </form>
            </div>

            <!-- BUSCADOR CERCANO A LA TABLA -->
            <div style="margin-bottom:15px;">
                <input type="text" id="searchUser" placeholder="Buscar por cédula o nombre..." 
                       class="form-control" style="max-width:400px;" onkeyup="filterUsers()">
            </div>

            <!-- TABLA USUARIOS MEJORADA CON RESPONSIVE -->
            <div class="table-responsive">
                <div class="modern-table-wrapper">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Cédula</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- Datos cargados por JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Dropdown para acciones móviles -->
            <div class="mobile-actions-dropdown">
                <button class="mobile-actions-btn">
                    <i class="fas fa-ellipsis-v"></i> Acciones
                </button>
                <div class="mobile-actions-menu">
                    <div class="mobile-action-item" onclick="navTo('dashboard')">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </div>
                    <div class="mobile-action-item" onclick="navTo('solicitudes')">
                        <i class="fas fa-inbox"></i> Solicitudes
                    </div>
                    <div class="mobile-action-item" onclick="navTo('seguridad')">
                        <i class="fas fa-shield-alt"></i> Seguridad
                    </div>
                </div>
            </div>
        </section>

        <!-- SUBIDA CON IA -->
        <section id="panel-upload" class="panel-section">
        <h2 style="color:var(--primary); margin-bottom:20px;">Subida de Evidencias</h2>
            
            <div id="dropZoneIA" class="storage-calc drop-zone" style="text-align:center; margin-bottom:30px;">
                <i class="fas fa-robot" style="font-size:3rem; color:var(--primary); margin-bottom:15px;"></i>
                <h3>Subida Inteligente (Reconocimiento Facial)</h3>
                <p style="margin-bottom:20px; color:var(--text-sec);">
                    Arrastra tus archivos aquí o haz clic para seleccionar.<br>
                    <small>El sistema asignará automáticamente la foto al estudiante correcto.</small>
                </p>
                
                <input type="file" id="fileInputIA" multiple 
                       accept="image/*,video/*,.pdf,.doc,.docx,.mp3,.mp4" 
                       style="display:none" onchange="handleUploadIA(this)">
                
                <button class="btn-primary" onclick="document.getElementById('fileInputIA').click()" 
                        style="font-size:1.1rem; padding:15px 30px;">
                    <i class="fas fa-cloud-upload-alt"></i> Seleccionar Archivos
                </button>
                
                <div id="uploadProgress" style="margin-top:20px; display:none;">
                    <div class="storage-bar-bg">
                        <div id="progressBar" class="storage-bar-fill" style="width:0%"></div>
                    </div>
                    <p id="progressText" style="margin-top:10px;">Procesando...</p>
                </div>
               <div id="uploadLog" style="text-align:left; margin-top:20px; max-height:300px;
                     overflow-y:auto; font-size:0.9rem; padding:10px; background:var(--bg-input); 
                     border-radius:8px;"></div>
            </div>
            <div style="border-top:2px solid var(--border-color); padding-top:30px;">
                <h4><i class="fas fa-hand-pointer"></i> Subida Manual</h4>
                ...

            <!-- SUBIDA MANUAL -->
            <div style="border-top:2px solid var(--border-color); padding-top:30px;">
                <h4><i class="fas fa-hand-pointer"></i> Subida Manual</h4>
                <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:15px;">
                    Para archivos sin rostro (PDF, Docs) o correcciones.
                </p>
                <form id="formManual" onsubmit="subirManual(event)">
                    <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:end;">
                        <div style="flex:1; min-width:200px;">
                            <label class="form-group" style="display:block;">
                                <div style="margin-bottom:8px; font-weight:600; font-size:0.9rem; color:var(--text-main);">
                                    Archivo *</div>
                                <input type="file" id="manualFile" class="form-control" 
                                       accept="image/*,video/*,.pdf,.doc,.docx,.mp3,.mp4" required>
                            </label>
                        </div>
                        <div style="flex:2; min-width:300px; position:relative;">
                            <label class="form-group" style="display:block;">
                                <div style="margin-bottom:8px; font-weight:600; font-size:0.9rem; color:var(--text-main);">
                                    Nombre(s) del Estudiante *</div>
                                <input type="text" id="manualNombres" 
                                       placeholder="Ej: Juan Pérez, María Gómez" 
                                       class="form-control" required 
                                       onkeyup="mostrarSugerencias(this.value)">
                            </label>
                            <div id="suggestionsBox" style="display:none; position:absolute; 
                                 background:var(--bg-card); border:1px solid var(--border-color); 
                                 max-height:150px; overflow-y:auto; width:100%; z-index:100; 
                                 border-radius:8px; margin-top:5px;"></div>
                        </div>
                        <button type="submit" class="btn-primary" style="background:var(--secondary);">
                            <i class="fas fa-user-check"></i> Asignar Manualmente
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- PANEL: EVIDENCIAS (VISTA DE ESTUDIANTES) -->
        <section id="panel-evidencias" class="panel-section">
            <div class="student-evidence-header">
                <div>
                    <h2 style="color:var(--primary); margin:0;">Galería de Evidencias</h2>
                    <p style="color:var(--text-sec); font-size:0.9rem; margin-top:5px;">Haz clic en un estudiante para ver sus evidencias</p>
                </div>
                <input type="text" id="filterEvidence" placeholder="Buscar estudiante..." 
                       class="form-control" style="width:250px;" onkeyup="filtrarEvidencias()">
            </div>
            
            <div id="evidenceContainer" style="position:relative;">
                <div id="evidenceGrid" class="gallery-grid">
                    <!-- Grid generado por JavaScript -->
                </div>
                <div id="evidenceEmpty" class="empty-state" style="display:none;">
                    <i class="fas fa-search" style="font-size:5rem; opacity:0.2; margin-bottom:25px;"></i>
                    <h3>No se encontraron evidencias</h3>
                    <p>Intenta con otro término de búsqueda</p>
                </div>
            </div>
        </section>

        <!-- PANEL: EVIDENCIAS POR ESTUDIANTE (NUEVA SECCIÓN) -->
        <section id="panel-evidencias-estudiante" class="panel-section">
            <div class="student-evidence-header">
                <div>
                    <button class="btn-back" onclick="volverAEvidencias()">
                        <i class="fas fa-arrow-left"></i> Volver a Estudiantes
                    </button>
                    <h2 id="studentNameTitle" style="color:var(--primary); margin:10px 0 0 0;">Evidencias del Estudiante</h2>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" onclick="toggleModoSeleccion()" id="btnSelectMode">
                        <i class="fas fa-check-square"></i> Seleccionar
                    </button>
                </div>
            </div>

            <div id="studentInfoContainer" class="student-info-card" style="display:none;">
                <!-- Información del estudiante cargada dinámicamente -->
            </div>

            <div id="studentEvidenceGrid" class="gallery-grid">
                <!-- Evidencias del estudiante cargadas dinámicamente -->
            </div>
            <div id="studentEvidenceEmpty" class="empty-state" style="display:none;">
                <i class="fas fa-folder-open" style="font-size:5rem; opacity:0.2; margin-bottom:25px;"></i>
                <h3>Este estudiante no tiene evidencias</h3>
                <p>Sube nuevas evidencias desde la sección "Subir Archivos"</p>
            </div>
        </section>

        <!-- PANEL: SOLICITUDES MEJORADO -->
        <section id="panel-solicitudes" class="panel-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h2 style="color:var(--primary); margin:0;">Centro de Solicitudes</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" style="background:var(--info);" onclick="navTo('seguridad')">
                        <i class="fas fa-key"></i> Cambiar Contraseña
                    </button>
                </div>
            </div>
            
            <div id="requestsContainer">
                <!-- Solicitudes cargadas dinámicamente -->
            </div>
        </section>

        <!-- PANEL: SEGURIDAD Y LOGS -->
        <section id="panel-seguridad" class="panel-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h2 style="color:var(--primary); margin:0;">Seguridad y Registro de Actividad</h2>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="searchLogs" placeholder="Buscar en logs..." 
                           class="form-control" style="width:200px;" onkeyup="filtrarLogs()">
                    <button onclick="cargarLogs()" class="btn-primary" style="font-size:0.9rem;">
                        <i class="fas fa-sync"></i> Actualizar
                    </button>
                </div>
            </div>
            
            <!-- CAMBIAR CONTRASEÑA -->
            <div class="storage-calc" style="margin-bottom:30px;">
                <h4 style="color:var(--primary); margin-bottom:15px;">
                    <i class="fas fa-key"></i> Cambiar Contraseña de Usuario
                </h4>
                <form id="formCambiarPassword" onsubmit="cambiarPassword(event)">
                    <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:end;">
                        <div style="flex:1; min-width:250px; position:relative;">
                            <label class="form-group" style="display:block;">
                                <div style="margin-bottom:8px; font-weight:600; font-size:0.9rem; color:var(--text-main);">
                                    Nombre del Estudiante *</div>
                                <input type="text" id="nombrePassword" class="form-control" 
                                       placeholder="Buscar por nombre" 
                                       onkeyup="sugerirUsuariosPassword(this.value)">
                            </label>
                            <div id="suggestionsPass" style="display:none; position:absolute; 
                                 background:var(--bg-card); border:1px solid var(--border-color); 
                                 max-height:150px; overflow-y:auto; width:100%; z-index:100; 
                                 border-radius:8px; margin-top:5px;"></div>
                        </div>
                        <div style="flex:1; min-width:250px;">
                            <label class="form-group" style="display:block;">
                                <div style="margin-bottom:8px; font-weight:600; font-size:0.9rem; color:var(--text-main);">
                                    Nueva Contraseña *</div>
                                <input type="password" id="nuevaPassword" class="form-control" 
                                       minlength="6" required>
                            </label>
                        </div>
                        <button type="submit" class="btn-primary" style="background:var(--warning); color:#333;">
                            <i class="fas fa-key"></i> Cambiar Contraseña
                        </button>
                    </div>
                </form>
            </div>

            <!-- LOGS DE ACTIVIDAD -->
            <div class="table-responsive">
                <div class="modern-table-wrapper">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Fecha (EC)</th>
                                <th>Acción</th>
                                <th>Detalle</th>
                                <th>Usuario</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <!-- Logs cargados por JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PANEL: MANTENIMIENTO -->
        <section id="panel-mantenimiento" class="panel-section">
            <h2 style="color:var(--primary); margin-bottom:20px;">Respaldos y Mantenimiento</h2>
            
            <div class="dashboard-grid" style="margin-bottom:30px;">
                <div class="stat-card" style="cursor:pointer;" onclick="descargarBackup('db')">
                    <div class="stat-icon bg-green"><i class="fas fa-database"></i></div>
                    <div class="stat-details">
                        <h3>Base de Datos</h3>
                        <p>Descargar SQL completo</p>
                    </div>
                </div>
                <div class="stat-card" style="cursor:pointer;" onclick="descargarBackup('media')">
                    <div class="stat-icon bg-blue"><i class="fas fa-photo-video"></i></div>
                    <div class="stat-details">
                        <h3>Multimedia</h3>
                        <p>Descargar ZIP evidencias</p>
                    </div>
                </div>
                <div class="stat-card" style="cursor:pointer;" onclick="optimizarSistema()">
                    <div class="stat-icon bg-orange"><i class="fas fa-tools"></i></div>
                    <div class="stat-details">
                        <h3>Optimización</h3>
                        <p>Limpiar y optimizar</p>
                    </div>
                </div>
            </div>

            <!-- ESTIMACIÓN DE COSTOS AWS PRECISA -->
            <div class="storage-calc">
                <h3 style="font-size:1.1rem; margin-bottom:10px; color:var(--primary);">
                    <i class="fas fa-robot"></i> Estimación Costos AWS Rekognition (Precisa)
                </h3>
                <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:15px;">
                    Precio: $1.00 por 1000 imágenes analizadas. Basado en uso real del mes actual.
                </p>
                <div style="margin:15px 0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Imágenes procesadas este mes:</span>
                        <strong id="rekognitionCount">0</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Costo estimado AWS:</span>
                        <strong id="rekognitionCost" class="cost-highlight">$0.00</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span>Total mensual (Storage + IA):</span>
                        <strong id="totalCost" class="cost-highlight" style="color:var(--error);">$0.00</strong>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- BARRA FLOTANTE PARA SELECCIÓN MÚLTIPLE - MEJORADA -->
    <div id="floatingBar" class="floating-bar">
        <div style="flex:1;">
            <span style="color:#aaa; font-size:0.8rem; letter-spacing:1px;">SELECCIONADOS</span><br>
            <strong style="font-size:1.2rem;"><span id="countSelection" style="color:var(--secondary);">0</span> archivos</strong>
        </div>
        <button class="btn-float" onclick="descargarSeleccionadas()"><i class="fas fa-download"></i> Descargar</button>
        
        <button class="btn-float" onclick="abrirModalReasignar()" style="background:var(--info);">
            <i class="fas fa-exchange-alt"></i> Reasignar
        </button>
        <button class="btn-float danger" onclick="eliminarSeleccionadas()"><i class="fas fa-trash"></i> Eliminar</button>
        <button class="btn-float-cancel" onclick="cancelarSeleccion()" title="Cancelar">&times;</button>
    </div>

    <!-- FOOTER IDÉNTICO AL PERFIL ESTUDIANTE -->
    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <img src="Img/Logo-Despertar-SKAS-Unidad-Educativa23.png" alt="Logo">
                <h3>Unidad Educativa Particular Despertar</h3>
            </div>
            <div class="footer-links" style="margin-bottom:20px;">
                <a href="https://uepdespertar.edu.ec/nosotros/" target="_blank">Sobre Nosotros</a>
            </div>
            <div class="footer-social">
                <a href="https://www.facebook.com/uepdespertar"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.youtube.com/@DespertarSKAS"><i class="fab fa-youtube"></i></a>
                <a href="https://www.instagram.com/skas_despertar"><i class="fab fa-instagram"></i></a>
            </div>
            <div class="copyright">
                <p>© 2025 Plataforma Educativa - Unidad Educativa Particular Despertar.</p>
            </div>
        </div>
    </footer>

    <!-- LIGHTBOX MEJORADO CON BOTÓN ELIMINAR -->
    <div class="lightbox-modal" id="lightbox" onclick="cerrarLightboxSiFondo(event)">
        <button class="lb-close-fixed" onclick="cerrarLightbox()">
            <i class="fas fa-times"></i> Cerrar
        </button>
        <button class="lb-nav-btn lb-prev" onclick="imagenAnterior(event)" title="Anterior">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="lb-nav-btn lb-next" onclick="imagenSiguiente(event)" title="Siguiente">
            <i class="fas fa-chevron-right"></i>
        </button>
        <div class="lb-content-wrapper" id="lightboxContent"></div>
        <div class="lb-actions-panel">
            <a id="lbDownloadLink" href="#" target="_blank" download class="btn-lb-action" 
               style="background:white; color:#333;">
                <i class="fas fa-download"></i> Descargar
            </a>
            <button class="btn-lb-action btn-lb-delete" onclick="eliminarEvidenciaActual()">
                <i class="fas fa-trash"></i> Eliminar Evidencia
            </button>
        </div>
    </div>

    <!-- MODALES -->
    <div class="modal-overlay" id="modalAgregarRef">
        <div class="modal-card">
            <button onclick="cerrarModal('modalAgregarRef')" 
                    style="position:absolute; top:15px; right:15px; border:none; background:none; 
                           font-size:1.5rem; cursor:pointer; color:var(--text-sec);">
                &times;
            </button>
            <h3 style="color:var(--primary); margin-bottom:15px;">
                <i class="fas fa-camera"></i> Agregar Foto de Referencia
            </h3>
            <form id="formAgregarRef" onsubmit="agregarReferencia(event)">
                <div class="form-group">
                    <label>Seleccionar Usuario *</label>
                    <select id="selectUsuarioRef" class="form-control" required>
                        <option value="">-- Seleccionar --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Foto de Referencia *</label>
                    <input type="file" id="fotoRef" class="form-control" accept="image/*" required>
                </div>
                <button type="submit" class="btn-primary" style="width:100%;">
                    <i class="fas fa-save"></i> Agregar Referencia
                </button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modalResponderSolicitud">
        <div class="modal-card">
            <button onclick="cerrarModal('modalResponderSolicitud')" 
                    style="position:absolute; top:15px; right:15px; border:none; background:none; 
                           font-size:1.5rem; cursor:pointer; color:var(--text-sec);">
                &times;
            </button>
            <div id="modalSolicitudContenido">
                <!-- Contenido cargado dinámicamente -->
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalReasignar">
        <div class="modal-card" style="max-height: 80vh; display: flex; flex-direction: column;">
            <button onclick="cerrarModal('modalReasignar')" 
                    style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            
            <h3 style="color:var(--primary); margin-bottom:10px;">
                <i class="fas fa-users"></i> Reasignar a Estudiantes
            </h3>
            
            <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">
                Selecciona 1 o más estudiantes. El archivo se copiará a todos los seleccionados.
            </p>
            
            <div class="form-group">
                <input type="text" id="busquedaReasignar" class="form-control" 
                       placeholder="Buscar estudiante..." 
                       onkeyup="filtrarUsuariosReasignar(this.value)">
            </div>
            
            <div id="listaUsuariosReasignar" style="flex:1; overflow-y:auto; border:1px solid #ddd; border-radius:8px; margin-bottom:15px;">
                </div>
            
            <button class="btn-primary" onclick="enviarReasignacionMasiva()" style="width:100%; justify-content:center;">
                <i class="fas fa-check-circle"></i> CONFIRMAR ASIGNACIÓN
            </button>
        </div>
    </div>

    <script>
    // ==========================================
    // 1. CONFIGURACIÓN E INICIALIZACIÓN
    // ==========================================
    const API_URL = "https://proyecto-de-grado-oficial-production.up.railway.app";
    let usuarios = [];
    let evidencias = [];
    let solicitudes = [];
    let logs = [];
    
    // Variables globales
    let modoSeleccion = false;
    let evidenciasSeleccionadas = [];
    let estudianteActual = null;
    let evidenciasEstudianteActual = [];
    let usuarioSeleccionadoPassword = null;
    let intervaloActualizaciones = null;
    let indiceVisorActual = 0;
    let evidenciasVisor = [];

    // Inicializar al cargar
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar Admin
        const tipoUsuario = localStorage.getItem('usuario_tipo');
        if (tipoUsuario !== "0") {
            Swal.fire({
                title: 'Acceso restringido',
                text: 'Solo administradores pueden acceder a esta sección',
                icon: 'error',
                confirmButtonColor: '#6A0DAD'
            }).then(() => {
                window.location.href = "index.html";
            });
            return;
        }

        inicializarTema();
        cargarDatosIniciales();
        configurarDragAndDrop(); 
        // Iniciar actualizaciones automáticas
        iniciarActualizacionesAutomaticas();
        
        // Eventos Globales
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });
        
        // Cerrar menús al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 992 && !e.target.closest('#sidebar') && !e.target.closest('#menuToggle')) {
                document.getElementById('sidebar').classList.remove('active');
            }
            if (!e.target.closest('.notis-dropdown') && !e.target.closest('.btn-icon-header')) {
                document.getElementById('notisDropdown').classList.remove('active');
            }
        });
        
        // Configurar formularios
        configurarFormularios();
        
        // Configurar eventos del teclado para el lightbox
        configurarEventosTeclado();
    });

    const tipoUsuario = localStorage.getItem('usuario_tipo');
    
    // Si NO hay usuario, O si el usuario NO es 0 (Admin) -> ¡FUERA!
    // Usamos '!=' para que funcione con 0 (número) y "0" (texto)
    if (tipoUsuario === null || tipoUsuario == undefined || tipoUsuario != 0) {
        alert("⛔ ACCESO DENEGADO: Área exclusiva para administradores.");
        window.location.href = 'biblioteca.html'; // Lo mandamos al login
    } else {
        console.log("✅ Bienvenido Admin. Acceso autorizado.");
    }

    function iniciarActualizacionesAutomaticas() {
        // Actualizar dashboard y notificaciones cada 10 segundos
        intervaloActualizaciones = setInterval(() => {
            actualizarDatosDashboard();
            cargarSolicitudesPendientes();
        }, 10000);
        
        // Actualizar solicitudes cada 15 segundos
        setInterval(() => {
            if (document.getElementById('panel-solicitudes').classList.contains('active')) {
                cargarSolicitudes();
            }
        }, 15000);
    }

    async function actualizarDatosDashboard() {
        try {
            const res = await fetch(`${API_URL}/estadisticas_almacenamiento`);
            
            if (!res.ok) throw new Error("Error del servidor");

            const stats = await res.json();
            
            // Actualizar contadores con animación simple
            actualizarContador('statUsers', stats.usuarios_activos || 0);
            actualizarContador('statFiles', stats.total_evidencias || 0);
            
            // Almacenamiento
            const gb = stats.almacenamiento_gb || 0;
            document.getElementById('statSize').textContent = gb.toFixed(2) + ' GB';
            document.getElementById('realSizeDisplay').textContent = gb.toFixed(2) + ' GB';
            
            // Costos
            const costoMensual = (gb * 0.005).toFixed(3);
            const costoAnual = (gb * 0.005 * 12).toFixed(3);
            
            document.getElementById('monthlyCost').textContent = '$' + costoMensual;
            document.getElementById('yearlyCost').textContent = '$' + costoAnual;
            
            // Barras de progreso
            document.getElementById('mainStorageBar').style.width = Math.min(100, (gb/50)*100) + '%';
            if(document.getElementById('sidebarStorageBar')) {
                document.getElementById('sidebarStorageBar').style.width = Math.min(100, (gb/50)*100) + '%';
                document.getElementById('sidebarStorageText').textContent = gb.toFixed(1) + ' GB usados';
            }
            
            // Sección Mantenimiento (Costos AWS)
            if(document.getElementById('rekognitionCount')) {
                document.getElementById('rekognitionCount').textContent = stats.total_evidencias || 0;
                
                // Priorizar datos precisos del backend si existen
                let iaCost = 0;
                if (stats.costo_estimado_usd && stats.costo_estimado_usd.rekognition) {
                    iaCost = parseFloat(stats.costo_estimado_usd.rekognition);
                } else {
                    iaCost = ((stats.total_evidencias || 0) / 1000);
                }
                
                document.getElementById('rekognitionCost').textContent = '$' + iaCost.toFixed(2);
                
                // Costo Total = Storage + IA
                const totalMensual = (parseFloat(costoMensual) + iaCost).toFixed(2);
                document.getElementById('totalCost').textContent = '$' + totalMensual;
            }
            
        } catch (error) {
            console.error("Error conectando al dashboard:", error);
            // Mostrar visualmente que hay un error de conexión
            document.getElementById('statUsers').innerHTML = '<span style="font-size:1rem; color:var(--error);">Offline</span>';
            document.getElementById('statFiles').innerHTML = '<span style="font-size:1rem; color:var(--error);">Offline</span>';
            document.getElementById('statSize').innerHTML = '<span style="font-size:1rem; color:var(--error);">Offline</span>';
        }
    }

    // Pequeña función auxiliar para animar los números (opcional, pero se ve profesional)
    function actualizarContador(id, valorFinal) {
        const elemento = document.getElementById(id);
        if(!elemento) return;
        // Si dice "Offline" o está vacío, poner el valor directo
        if(elemento.innerText === 'Offline' || elemento.innerText === '') {
            elemento.textContent = valorFinal;
            return;
        }
        elemento.textContent = valorFinal;
    }

    async function cargarDatosIniciales() {
        try {
            // Cargar datos en paralelo
            const [resUsers, resEvidencias, resSolicitudes, resLogs] = await Promise.all([
                fetch(`${API_URL}/listar_usuarios`),
                fetch(`${API_URL}/resumen_estudiantes_con_evidencias`),
                fetch(`${API_URL}/obtener_solicitudes`),
                fetch(`${API_URL}/obtener_logs`)
            ]);

            // Procesar usuarios
            const usuariosData = await resUsers.json();
            usuarios = usuariosData.map(u => {
                // Función auxiliar para buscar claves ignorando mayúsculas/minúsculas
                const get = (k) => u[k] || u[k.toLowerCase()] || u[k.charAt(0).toUpperCase() + k.slice(1)] || '';

                return {
                    // Buscamos todas las variantes posibles: Nombre, nombre, NOMBRE...
                    nombre: get('Nombre') || get('nombre'),
                    apellido: get('Apellido') || get('apellido'),
                    cedula: get('CI') || get('ci') || get('Cedula') || get('cedula'),
                    // CORRECCIÓN CLAVE: Agregamos 'password' y 'Password' a la búsqueda
                    contrasena: get('Password') || get('password') || get('Contrasena') || get('contrasena') || '***', 
                    // Aseguramos que el tipo sea un número
                    tipo: Number(u.Tipo !== undefined ? u.Tipo : (u.tipo !== undefined ? u.tipo : 1)),
                    activo: (u.Activo !== undefined ? u.Activo : (u.activo !== undefined ? u.activo : 1)),
                    foto: get('Foto') || get('foto') || '',
                    email: get('Email') || get('email') || '',
                    telefono: get('Telefono') || get('telefono') || ''
                };
            });

            // Procesar evidencias
            const evidenciasRaw = await resEvidencias.json();
            evidencias = evidenciasRaw.map(e => ({
                nombre: e.Nombre || '',
                apellido: e.Apellido || '',
                cedula: e.CI || '',
                foto: e.Foto || '',
                total_evidencias: e.total_evidencias || 0,
                total_kb: e.total_kb || 0
            }));

            // Procesar resto de datos
            solicitudes = await resSolicitudes.json();
            logs = await resLogs.json();

            // Actualizar interfaz
            await actualizarDatosDashboard();
            await cargarSolicitudesPendientes();
            
            renderizarUsuarios();
            renderizarEvidencias();
            renderizarSolicitudes();
            renderizarLogs();
            
        } catch (error) {
            console.error("Error inicializando:", error);
            mostrarMensaje("Error al cargar datos iniciales", "error");
        }
    }

    async function cargarSolicitudesPendientes() {
        try {
            const res = await fetch(`${API_URL}/obtener_solicitudes?limit=50`);
            const todasSolicitudes = await res.json();
            
            const solicitudesPendientes = todasSolicitudes.filter(s => {
                const estado = (s.Estado || '').toUpperCase();
                return estado === 'PENDIENTE' || estado === '';
            });
            
            actualizarNotificaciones(solicitudesPendientes);
            document.getElementById('statReqs').textContent = solicitudesPendientes.length;
            
        } catch (error) {
            console.error("Error cargando solicitudes pendientes:", error);
        }
    }

    function actualizarNotificaciones(pendientes) {
        const badge = document.getElementById('notisBadge');
        const list = document.getElementById('notisList');
        
        if (pendientes.length > 0) {
            badge.style.display = 'flex';
            badge.textContent = pendientes.length > 9 ? '9+' : pendientes.length;
            
            list.innerHTML = pendientes.slice(0, 5).map(sol => {
                let icono = 'fas fa-exclamation-circle';
                let color = 'var(--warning)';
                let tipoTexto = 'Solicitud';
                
                switch(sol.Tipo) {
                    case 'REPORTE_EVIDENCIA': 
                        icono = 'fas fa-user-times'; 
                        color = 'var(--error)';
                        tipoTexto = 'Reporte de evidencia';
                        break;
                    case 'PROBLEMA_ERROR': 
                        icono = 'fas fa-bug'; 
                        color = 'var(--warning)';
                        tipoTexto = 'Problema/Error';
                        break;
                    case 'SUBIR_EVIDENCIA': 
                        icono = 'fas fa-cloud-upload-alt'; 
                        color = 'var(--info)';
                        tipoTexto = 'Subir evidencia';
                        break;
                    case 'RECUPERACION_CONTRASENA': 
                        icono = 'fas fa-key'; 
                        color = 'var(--primary)';
                        tipoTexto = 'Recuperar contraseña';
                        break;
                }
                
                const usuario = usuarios.find(u => u.cedula === sol.CI_Solicitante);
                const nombreUsuario = usuario ? `${usuario.nombre} ${usuario.apellido}` : sol.CI_Solicitante || 'Usuario';
                
                return `
                    <div class="noti-item unread" onclick="navTo('solicitudes'); toggleNotis();">
                        <i class="${icono}" style="color:${color}; margin-top:3px;"></i>
                        <div style="flex:1;">
                            <div style="font-weight:600;">${tipoTexto}</div>
                            <div style="font-size:0.8rem;">${nombreUsuario}</div>
                            <div style="font-size:0.7rem; color:#888;">${formatearFecha(sol.Fecha)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (pendientes.length > 5) {
                list.innerHTML += `<div style="padding:10px; text-align:center; border-top:1px solid var(--border-color);">
                    <small>${pendientes.length - 5} más pendientes...</small>
                </div>`;
            }
        } else {
            badge.style.display = 'none';
            list.innerHTML = '<div style="padding:15px; text-align:center; color:#888;">No hay notificaciones nuevas</div>';
        }
    }

    function formatearFecha(fechaStr) {
        if (!fechaStr) return 'Fecha no disponible';
        const fecha = new Date(fechaStr);
        return fecha.toLocaleDateString('es-EC', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function toggleNotis() {
        document.getElementById('notisDropdown').classList.toggle('active');
    }

    // ==========================================
    // 2. NAVEGACIÓN Y UI
    // ==========================================
    function navTo(seccionId, boton) {
        window.scrollTo(0, 0);
        document.querySelectorAll('.panel-section').forEach(s => s.classList.remove('active'));
        document.getElementById('panel-' + seccionId).classList.add('active');
        
        document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
        if(boton) boton.classList.add('active');
        document.getElementById('sidebar').classList.remove('active');
    }

    function inicializarTema() {
        const temaGuardado = localStorage.getItem('tema');
        const iconoTema = document.querySelector('#themeBtn i');
        
        if (temaGuardado === 'oscuro') {
            document.body.classList.add('dark-mode');
            iconoTema.className = 'fas fa-sun';
        } else {
            document.body.classList.remove('dark-mode');
            iconoTema.className = 'fas fa-moon';
        }
    }

    function toggleTheme() {
        const iconoTema = document.querySelector('#themeBtn i');
        
        if (document.body.classList.contains('dark-mode')) {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('tema', 'claro');
            iconoTema.className = 'fas fa-moon';
        } else {
            document.body.classList.add('dark-mode');
            localStorage.setItem('tema', 'oscuro');
            iconoTema.className = 'fas fa-sun';
        }
    }

    function cerrarSesion() {
        if (intervaloActualizaciones) {
            clearInterval(intervaloActualizaciones);
        }
        localStorage.clear();
        window.location.href = 'index.html';
    }

    function mostrarMensaje(mensaje, tipo) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed; bottom: 20px; right: 20px;
            padding: 12px 20px; border-radius: 8px; z-index: 9999;
            color: white; font-weight: 600;
            background: ${tipo === 'success' ? 'var(--secondary)' : 
                       tipo === 'error' ? 'var(--error)' : 
                       tipo === 'warning' ? 'var(--warning)' : 'var(--info)'};
            animation: fadeIn 0.3s;
        `;
        
        toast.innerHTML = `
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : 
                               tipo === 'error' ? 'exclamation-circle' : 
                               tipo === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            ${mensaje}
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function cerrarModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // ==========================================
    // 3. GESTIÓN DE USUARIOS - CORREGIDA
    // ==========================================
    function configurarFormularios() {
        // Formulario registro usuario
        document.getElementById('formRegistro').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formulario = e.target;
            const boton = formulario.querySelector('button[type="submit"]');
            const datos = new FormData(formulario);
            
            // Validaciones frontend
            const cedula = datos.get('cedula');
            const contrasena = datos.get('contrasena');
            
            if (!/^\d{10}$/.test(cedula)) {
                Swal.fire({
                    title: 'Error de validación',
                    text: 'La cédula debe tener exactamente 10 dígitos numéricos',
                    icon: 'error',
                    confirmButtonColor: '#6A0DAD'
                });
                return;
            }
            
            if (contrasena.length < 6) {
                Swal.fire({
                    title: 'Error de validación',
                    text: 'La contraseña debe tener al menos 6 caracteres',
                    icon: 'error',
                    confirmButtonColor: '#6A0DAD'
                });
                return;
            }
            
            try {
                boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                boton.disabled = true;
                
                const respuesta = await fetch(`${API_URL}/registrar_usuario`, {
                    method: 'POST',
                    body: datos
                });
                
                const resultado = await respuesta.json();
                
                if (resultado.mensaje) {
                    mostrarMensaje('Usuario registrado correctamente', 'success');
                    formulario.reset();
                    await cargarDatosIniciales();
                } else {
                    mostrarMensaje('Error: ' + (resultado.error || 'Desconocido'), 'error');
                }
            } catch (error) {
                mostrarMensaje('Error de conexión: ' + error.message, 'error');
            } finally {
                boton.innerHTML = '<i class="fas fa-user-plus"></i> Guardar Usuario';
                boton.disabled = false;
            }
        });
    }

    function renderizarUsuarios() {
        const tbody = document.getElementById('userTableBody');
        if(!tbody) return;

        tbody.innerHTML = usuarios.map(u => {
            const esAdmin = parseInt(u.tipo) === 0; // Asegúrate que coincida con tu dato (Tipo o tipo)
            const rol = esAdmin ? 'Administrador' : 'Estudiante';
            const claseRol = esAdmin ? 'tipo-contrasena' : 'tipo-subida';
            
            const esActivo = parseInt(u.activo) === 1;
            const estadoTexto = esActivo ? 'Activo' : 'Inactivo';
            const claseEstado = esActivo ? 'badge-resolved' : 'badge-rejected';

            return `
                <tr id="user-row-${u.cedula}">
                    <td>
                        <strong>${u.nombre} ${u.apellido}</strong><br>
                        <small style="color:#888;">${u.contrasena || '***'}</small>
                    </td>
                    <td>${u.cedula}</td>
                    <td><span class="solicitud-tipo ${claseRol}">${rol}</span></td>
                    <td><span id="user-status-${u.cedula}" class="request-badge ${claseEstado}">${estadoTexto}</span></td>
                    <td>
                        <button class="action-btn" onclick="verUsuario('${u.cedula}')" style="background:#e3f2fd; color:#2196f3;" title="Ver Detalles">
                            <i class="fas fa-eye"></i>
                        </button>

                        ${esActivo ? 
                            `<button class="action-btn btn-deactivate" onclick="cambiarEstadoUsuario('${u.cedula}', 0)" title="Desactivar">
                                <i class="fas fa-user-slash"></i>
                             </button>` : 
                            `<button class="action-btn btn-activate" onclick="cambiarEstadoUsuario('${u.cedula}', 1)" title="Activar">
                                <i class="fas fa-user-check"></i>
                             </button>`
                        }

                        <button class="action-btn btn-delete" onclick="eliminarUsuario('${u.cedula}')" style="background:#ffebee; color:#d32f2f;" title="Eliminar Usuario">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function filterUsers() {
        const busqueda = document.getElementById('searchUser').value.toLowerCase();
        const filas = document.querySelectorAll('#userTableBody tr');
        
        filas.forEach(fila => {
            const texto = fila.textContent.toLowerCase();
            fila.style.display = texto.includes(busqueda) ? '' : 'none';
        });
    }

    async function cambiarEstadoUsuario(cedula, nuevoEstado) {
    const usuario = usuarios.find(u => u.cedula === cedula);
    if (!usuario) return;

    const accion = nuevoEstado == 1 ? 'activar' : 'desactivar';
    
    const confirmacion = await Swal.fire({
        title: `¿${accion.charAt(0).toUpperCase() + accion.slice(1)} usuario?`,
        text: `¿Estás seguro de querer ${accion} a ${usuario.nombre} ${usuario.apellido}?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: nuevoEstado == 1 ? '#2E8B57' : '#d32f2f',
        cancelButtonColor: '#5f6368',
        confirmButtonText: `Sí, ${accion}`,
        cancelButtonText: 'Cancelar'
    });

    if (!confirmacion.isConfirmed) return;

    try {
        const respuesta = await fetch(`${API_URL}/cambiar_estado_usuario`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cedula: cedula, activo: nuevoEstado })
        });

        const resultado = await respuesta.json();

        if (resultado.mensaje) {
            // 1. Actualizar memoria
            const usuarioIndex = usuarios.findIndex(u => u.cedula === cedula);
            if (usuarioIndex !== -1) usuarios[usuarioIndex].activo = nuevoEstado;

            // 2. Actualizar Badge de estado (sin borrar estilos)
            const statusBadge = document.getElementById(`user-status-${cedula}`);
            if (statusBadge) {
                statusBadge.textContent = nuevoEstado == 1 ? 'Activo' : 'Inactivo';
                // Mantenemos la clase base 'request-badge' si existe en tu CSS, o usamos las tuyas directas
                statusBadge.className = nuevoEstado == 1 ? 'request-badge badge-resolved' : 'request-badge badge-rejected';
                statusBadge.style.fontSize = '0.75rem';
                statusBadge.style.padding = '3px 8px';
            }

            // 3. ACTUALIZACIÓN DEL BOTÓN (Aquí estaba el error)
            const fila = document.getElementById(`user-row-${cedula}`);
            if (fila) {
                // Buscamos el botón por la clase que tiene AHORA antes de cambiarlo
                const btn = fila.querySelector(nuevoEstado == 1 ? '.btn-activate' : '.btn-deactivate');
                
                if (btn) {
                    if (nuevoEstado == 1) {
                        // Cambiar a estado ACTIVO (Botón rojo para desactivar)
                        btn.className = 'action-btn btn-deactivate';
                        btn.title = 'Desactivar';
                        btn.innerHTML = '<i class="fas fa-user-slash"></i>';
                        // IMPORTANTE: Actualizamos el onclick para que la próxima vez envíe 0
                        btn.setAttribute('onclick', `cambiarEstadoUsuario('${cedula}', 0)`);
                    } else {
                        // Cambiar a estado INACTIVO (Botón verde para activar)
                        btn.className = 'action-btn btn-activate';
                        btn.title = 'Activar';
                        btn.innerHTML = '<i class="fas fa-user-check"></i>';
                        // IMPORTANTE: Actualizamos el onclick para que la próxima vez envíe 1
                        btn.setAttribute('onclick', `cambiarEstadoUsuario('${cedula}', 1)`);
                    }
                }
            }

            mostrarMensaje(`Usuario ${accion}do correctamente`, 'success');
        } else {
            mostrarMensaje('Error al cambiar estado', 'error');
        }
    } catch (error) {
        console.error(error);
        mostrarMensaje('Error de conexión', 'error');
    }
}
    function verUsuario(cedula) {
        const usuario = usuarios.find(u => u.cedula === cedula);
        if (usuario) {
            Swal.fire({
                title: `${usuario.nombre} ${usuario.apellido}`,
                html: `
                    <div style="text-align:left; color:#333 !important;">
                        <p><strong>Cédula:</strong> ${usuario.cedula}</p>
                        <p><strong>Rol:</strong> ${parseInt(usuario.tipo) === 0 ? 'Administrador' : 'Estudiante'}</p>
                        <p><strong>Estado:</strong> ${parseInt(usuario.activo) === 1 ? 'Activo' : 'Inactivo'}</p>
                        <p><strong>Contraseña:</strong> ${usuario.contrasena || 'No disponible'}</p>
                        ${usuario.foto ? `<p><strong>Foto:</strong> <br><img src="${usuario.foto}" style="max-width:200px; margin-top:10px; border-radius:8px;"></p>` : ''}
                    </div>
                `,
                icon: 'info',
                confirmButtonColor: '#6A0DAD',
                confirmButtonText: 'Cerrar',
                background: 'var(--bg-card)',
                color: 'var(--text-main)'
            });
        }
    }

    async function eliminarUsuario(cedula) {
        const usuario = usuarios.find(u => u.cedula === cedula);
        if (!usuario) return;
        
        const confirmacion = await Swal.fire({
            title: '¿Eliminar usuario?',
            text: `Esta acción eliminará permanentemente a ${usuario.nombre} ${usuario.apellido} y todas sus evidencias.`,
            icon: 'error',
            showCancelButton: true,
            confirmButtonColor: '#d32f2f',
            cancelButtonColor: '#5f6368',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        });
        
        if (!confirmacion.isConfirmed) return;
        
        try {
            const respuesta = await fetch(`${API_URL}/eliminar_usuario/${cedula}`, {
                method: 'DELETE'
            });
            
            if (respuesta.ok) {
                // Eliminar del DOM inmediatamente
                const fila = document.getElementById(`user-row-${cedula}`);
                if (fila) {
                    fila.remove();
                }
                
                // Eliminar del array en memoria
                const usuarioIndex = usuarios.findIndex(u => u.cedula === cedula);
                if (usuarioIndex !== -1) {
                    usuarios.splice(usuarioIndex, 1);
                }
                
                mostrarMensaje('Usuario eliminado correctamente', 'success');
            } else {
                mostrarMensaje('Error al eliminar usuario', 'error');
            }
        } catch (error) {
            mostrarMensaje('Error de conexión', 'error');
        }
    }

    // ==========================================
    // 4. SISTEMA DE SOLICITUDES - COMPLETAMENTE REESCRITO
    // ==========================================
    async function cargarSolicitudes() {
        try {
            const respuesta = await fetch(`${API_URL}/obtener_solicitudes?limit=100`);
            solicitudes = await respuesta.json();
            renderizarSolicitudes();
        } catch (error) {
            console.error("Error cargando solicitudes:", error);
        }
    }

    function renderizarSolicitudes() {
        const container = document.getElementById('requestsContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Separar solicitudes pendientes y resueltas
        const pendientes = solicitudes.filter(s => {
            const estado = (s.Estado || '').toUpperCase();
            return estado === 'PENDIENTE' || estado === '';
        });
        const resueltas = solicitudes.filter(s => {
            const estado = (s.Estado || '').toUpperCase();
            return estado !== 'PENDIENTE' && estado !== '';
        });
        
        if (pendientes.length === 0 && resueltas.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="display:flex;">
                    <i class="fas fa-inbox" style="font-size:5rem; opacity:0.2; margin-bottom:25px;"></i>
                    <h3>No hay solicitudes</h3>
                    <p>Todas las solicitudes han sido procesadas</p>
                </div>
            `;
            return;
        }
        
        // Mostrar solicitudes pendientes primero
        if (pendientes.length > 0) {
            container.innerHTML += `
                <h3 style="color:var(--primary); margin-bottom:15px; border-bottom:2px solid var(--primary); padding-bottom:10px;">
                    <i class="fas fa-clock"></i> Solicitudes Pendientes (${pendientes.length})
                </h3>
            `;
            
            pendientes.forEach(solicitud => {
                container.innerHTML += crearCardSolicitud(solicitud);
            });
        }
        
        // Mostrar historial después
        if (resueltas.length > 0) {
            container.innerHTML += `
                <h3 style="color:var(--text-sec); margin:30px 0 15px 0; border-bottom:2px solid var(--border-color); padding-bottom:10px;">
                    <i class="fas fa-history"></i> Historial de Solicitudes (${resueltas.length})
                </h3>
            `;
            
            resueltas.slice(0, 10).forEach(solicitud => {
                container.innerHTML += crearCardSolicitud(solicitud);
            });
        }
    }

    function crearCardSolicitud(sol) {
        // Manejo de estado
        const estado = (sol.Estado || '').toUpperCase();
        const esPendiente = estado === 'PENDIENTE' || estado === '';
        
        // Determinar la clase del badge y el texto
        let badgeClass, badgeText;
        if (esPendiente) {
            badgeClass = 'badge-pending';
            badgeText = 'PENDIENTE';
        } else if (estado === 'APROBADA' || estado === 'RESUELTO') {
            badgeClass = 'badge-resolved';
            badgeText = 'RESUELTA';
        } else {
            badgeClass = 'badge-rejected';
            badgeText = 'RECHAZADA';
        }
        
        // Buscar información del usuario
        const usuario = usuarios.find(u => u.cedula === sol.CI_Solicitante);
        const nombreUsuario = usuario ? `${usuario.nombre} ${usuario.apellido}` : sol.CI_Solicitante || 'Usuario';
        
        return `
            <div class="request-card">
                <div class="request-header">
                    <div>
                        <h4 style="color:var(--text-main); margin-bottom:5px;">
                            ${sol.Tipo ? sol.Tipo.replace(/_/g, ' ') : 'Solicitud'} - ${nombreUsuario}
                            <span class="solicitud-tipo ${sol.Tipo ? 'tipo-' + sol.Tipo.toLowerCase().split('_')[0] : 'tipo-reporte'}">
                                ${sol.Tipo ? sol.Tipo.replace(/_/g, ' ') : 'General'}
                            </span>
                        </h4>
                        <p style="color:var(--text-sec); font-size:0.9rem; margin-bottom:5px;">
                            ${sol.Detalle || 'Sin detalles'}
                        </p>
                        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                            <span class="request-badge ${badgeClass}">${badgeText}</span>
                            <span style="color:var(--text-muted); font-size:0.8rem;">${formatearFecha(sol.Fecha)}</span>
                            ${sol.Email ? `<span style="color:var(--text-muted); font-size:0.8rem;"><i class="fas fa-envelope"></i> ${sol.Email}</span>` : ''}
                        </div>
                    </div>
                    ${esPendiente ? 
                        `<button class="btn-primary" onclick="procesarSolicitudDesdeCard('${sol.Tipo}', ${sol.id})" 
                                 style="background:var(--info); padding:8px 15px;">
                            <i class="fas fa-reply"></i> Responder
                         </button>` : 
                        `<div style="font-size:0.85rem; text-align:right; color:var(--text-main);">
                            <div><strong>Resuelto por:</strong> ${sol.Resuelto_Por || 'Admin'}</div>
                            ${sol.Respuesta ? `<div style="color:var(--primary); margin-top:3px;"><em>"${sol.Respuesta.substring(0,30)}..."</em></div>` : ''}
                         </div>`
                    }
                </div>
                ${sol.Evidencia_Reportada_Url ? `
                    <div style="margin-top:10px;">
                        <p style="color:var(--text-sec); font-size:0.9rem; margin-bottom:5px;">Evidencia relacionada:</p>
                        <img src="${sol.Evidencia_Reportada_Url}" class="request-preview" 
                             onclick="abrirPrevisualizacion('${sol.Evidencia_Reportada_Url}')">
                    </div>
                ` : ''}
                ${!esPendiente && sol.Respuesta ? `
                    <div style="margin-top:15px; padding:10px; background:var(--bg-input); border-radius:8px;">
                        <strong style="color:var(--primary);">Respuesta enviada:</strong>
                        <p style="margin-top:5px; color:var(--text-main);">${sol.Respuesta}</p>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // ==========================================
    // 5. GESTIÓN COMPLETA DE SOLICITUDES
    // ==========================================
    // ==========================================
    // 12. GESTIÓN DE SOLICITUDES (CON VISOR DE FOTOS Y EMAIL)
    // ==========================================
    
    function procesarSolicitudDesdeCard(tipo, solicitudId) {
        const solicitud = solicitudes.find(s => s.id == solicitudId);
        if (!solicitud) return;

        const usuario = usuarios.find(u => u.cedula === solicitud.CI_Solicitante);
        const nombreUsuario = usuario ? `${usuario.nombre} ${usuario.apellido}` : solicitud.CI_Solicitante;
        
        let contenido = `
            <div style="text-align:left;">
                <h3 style="color:var(--primary); margin-bottom:10px;">
                    <i class="fas fa-tasks"></i> Gestionar Solicitud
                </h3>
                <div style="background:var(--bg-input); padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.9rem;">
                    <p><strong>Usuario:</strong> ${nombreUsuario}</p>
                    <p><strong>Tipo:</strong> ${tipo.replace(/_/g, ' ')}</p>
                    <p><strong>Mensaje del usuario:</strong> "${solicitud.Detalle || 'Sin detalles'}"</p>
                </div>
        `;

        // --- INTERFAZ DINÁMICA (SIN TEXTO POR DEFECTO PARA OBLIGAR A ESCRIBIR) ---

        if (tipo === 'REPORTE_EVIDENCIA') {
            contenido += `
                <div style="text-align:center; margin-bottom:15px; border:2px solid var(--error); padding:10px; border-radius:8px;">
                    <p style="color:var(--error); font-weight:bold;">Reporte: "No soy yo"</p>
                    <img src="${solicitud.Evidencia_Reportada_Url}" style="max-width:100%; max-height:200px; border-radius:5px;">
                </div>
                <div class="form-group">
                    <label style="color:var(--error); font-weight:bold;">Respuesta Obligatoria:</label>
                    <textarea id="mensajeAdmin" class="form-control" rows="3" placeholder="Explica por qué aceptas borrar la foto o por qué rechazas el reporte..."></textarea>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" onclick="enviarGestion(${solicitudId}, 'aprobar')" style="background:var(--error); flex:1;">
                        <i class="fas fa-trash"></i> Aceptar (Borrar)
                    </button>
                    <button class="btn-primary" onclick="enviarGestion(${solicitudId}, 'rechazar')" style="background:var(--secondary); flex:1;">
                        <i class="fas fa-times"></i> Rechazar
                    </button>
                </div>
            `;
        } 
        else if (tipo === 'SUBIR_EVIDENCIA') {
            contenido += `
                <div style="text-align:center; margin-bottom:15px; border:2px solid var(--info); padding:10px; border-radius:8px;">
                    <p style="color:var(--info); font-weight:bold;">Propuesta de Evidencia</p>
                    <img src="${solicitud.Evidencia_Reportada_Url}" style="max-width:100%; max-height:200px; border-radius:5px;">
                </div>
                <div class="form-group">
                    <label style="color:var(--info); font-weight:bold;">Respuesta Obligatoria:</label>
                    <textarea id="mensajeAdmin" class="form-control" rows="2" placeholder="Escribe un comentario para el estudiante..."></textarea>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" onclick="enviarGestion(${solicitudId}, 'aprobar')" style="background:var(--secondary); flex:1;">
                        <i class="fas fa-check"></i> Aceptar (Publicar)
                    </button>
                    <button class="btn-primary" onclick="enviarGestion(${solicitudId}, 'rechazar')" style="background:var(--error); flex:1;">
                        <i class="fas fa-times"></i> Rechazar
                    </button>
                </div>
            `;
        }
        else if (tipo === 'RECUPERACION_CONTRASENA') {
    contenido += `
        <div style="background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:15px;">
            <p><strong>Instrucción:</strong> El correo se enviará automáticamente con un diseño profesional.</p>
        </div>
        <div class="form-group">
            <label style="color:var(--primary); font-weight:bold;">SOLO ESCRIBE LA CONTRASEÑA (Asegúrate que sea la funcional):</label>
            <textarea id="mensajeAdmin" class="form-control" rows="2" placeholder="Ejemplo: Clave12345 (No escribas nada más, solo la clave)"></textarea>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-primary" onclick="enviarGestion(${solicitudId}, 'aprobar')" style="background:var(--secondary); flex:1;">
                <i class="fas fa-paper-plane"></i> Enviar Contraseña
            </button>
            <button class="btn-primary" onclick="enviarGestion(${solicitudId}, 'rechazar')" style="background:var(--error); flex:1;">
                <i class="fas fa-ban"></i> Denegar
            </button>
        </div>
    `;
}
        else { 
            contenido += `
                <div class="form-group">
                    <label style="font-weight:bold;">Respuesta / Solución:</label>
                    <textarea id="mensajeAdmin" class="form-control" rows="4" placeholder="Escribe tu respuesta aquí..."></textarea>
                </div>
                <button class="btn-primary" onclick="enviarGestion(${solicitudId}, 'aprobar')" style="width:100%;">
                    <i class="fas fa-paper-plane"></i> Enviar Respuesta
                </button>
            `;
        }

        contenido += `</div>`;
        document.getElementById('modalSolicitudContenido').innerHTML = contenido;
        document.getElementById('modalResponderSolicitud').classList.add('active');
    }

    async function enviarGestion(id, accion) {
        const mensajeInput = document.getElementById('mensajeAdmin');
        const mensaje = mensajeInput.value.trim();
        
        // --- VALIDACIÓN DE CAMPO VACÍO ---
        if(!mensaje) {
            // Animación de error (sacudida)
            mensajeInput.style.border = "2px solid red";
            mensajeInput.classList.add('shake');
            setTimeout(() => mensajeInput.classList.remove('shake'), 500);
            
            // Alerta visual clara
            Swal.fire({
                title: '¡Mensaje Obligatorio!',
                text: 'Debes escribir una razón o respuesta para el estudiante antes de continuar.',
                icon: 'warning',
                confirmButtonColor: '#d32f2f',
                confirmButtonText: 'Entendido'
            });
            return; // DETIENE LA EJECUCIÓN AQUÍ
        }

        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...'; 
        btn.disabled = true;

        const fd = new FormData();
        fd.append('id_solicitud', id);
        fd.append('accion', accion);
        fd.append('mensaje', mensaje);
        fd.append('id_admin', 'Administrador');

        try {
            const res = await fetch(`${API_URL}/gestionar_solicitud`, { method: 'POST', body: fd });
            const data = await res.json();

            if (data.status === 'ok') {
                Swal.fire('Éxito', data.mensaje, 'success');
                document.getElementById('modalResponderSolicitud').classList.remove('active');
                cargarSolicitudes(); 
                actualizarDatosDashboard();
            } else {
                Swal.fire('Error', data.mensaje, 'error');
            }
        } catch (e) {
            Swal.fire('Error', 'Error de conexión', 'error');
        } finally {
            if(btn) { btn.innerHTML = originalText; btn.disabled = false; }
        }
    }

    async function procesarSolicitud(accion) {
        const id = document.getElementById('solicitudIdRespuesta').value;
        const tipo = document.getElementById('tipoRespuesta').value;
        const mensaje = document.getElementById('respuestaAdmin').value;
        const nuevaPassInput = document.getElementById('nuevaContrasena');
        const nuevaPass = nuevaPassInput ? nuevaPassInput.value : null;

        if (!mensaje.trim()) {
            Swal.fire({
                title: 'Campo requerido',
                text: 'Por favor escribe un mensaje de respuesta para el usuario.',
                icon: 'warning',
                confirmButtonColor: '#6A0DAD'
            });
            return;
        }

        const solicitud = solicitudes.find(s => s.id == id);
        if (!solicitud) {
            mostrarMensaje('Solicitud no encontrada', 'error');
            return;
        }

        // Determinar estado final según el tipo de solicitud y acción
        let estadoFinal = 'PENDIENTE';
        
        if (accion === 'aceptar') {
            if (tipo === 'PROBLEMA_ERROR') {
                estadoFinal = 'RESUELTO';
            } else if (tipo === 'RECUPERACION_CONTRASENA') {
                estadoFinal = 'APROBADA';
            } else {
                estadoFinal = 'APROBADA';
            }
        } else {
            estadoFinal = 'RECHAZADA';
        }

        // Crear FormData para enviar al endpoint
        const formData = new FormData();
        formData.append('id_solicitud', id);
        formData.append('accion', accion === 'aceptar' ? 'aprobar' : 'rechazar');
        formData.append('mensaje', mensaje);
        formData.append('id_admin', 'Admin');

        try {
            mostrarMensaje("Procesando solicitud...", "info");
            
            const res = await fetch(`${API_URL}/gestionar_solicitud`, {
                method: 'POST',
                body: formData
            });
            
            const result = await res.json();
            
            if (result.status === 'ok' || result.mensaje) {
                // Mostrar confirmación
                Swal.fire({
                    title: '¡Solicitud procesada!',
                    text: `La respuesta ha sido enviada al estudiante${tipo === 'RECUPERACION_CONTRASENA' ? ' por correo' : ''}.`,
                    icon: 'success',
                    confirmButtonColor: '#6A0DAD'
                });
                
                cerrarModal('modalResponderSolicitud');
                
                // Recargar datos
                await cargarSolicitudes();
                await cargarSolicitudesPendientes();
                
            } else {
                mostrarMensaje("Error: " + (result.error || "Desconocido"), "error");
            }
        } catch (error) {
            console.error(error);
            mostrarMensaje("Error de conexión con el servidor", "error");
        }
    }

    // ==========================================
    // 6. FUNCIONES DE EVIDENCIAS
    // ==========================================
    function renderizarEvidencias() {
        const grid = document.getElementById('evidenceGrid');
        const vacio = document.getElementById('evidenceEmpty');
        
        if (!grid || evidencias.length === 0) {
            if (vacio) vacio.style.display = 'flex';
            return;
        }
        
        if (vacio) vacio.style.display = 'none';
        grid.innerHTML = '';
        
        evidencias.forEach(estudiante => {
            const tarjeta = document.createElement('div');
            tarjeta.className = 'evidence-card';
            tarjeta.onclick = () => verEvidenciasEstudiante(estudiante);
            
            tarjeta.innerHTML = `
                <img src="${estudiante.foto || 'Img/Logo_pestaña.png'}" 
                     class="card-media" 
                     onerror="this.src='Img/Logo_pestaña.png'"
                      alt="${estudiante.nombre} ${estudiante.apellido}">
                ${estudiante.total_evidencias > 0 ? `
                    <div style="position:absolute; top:10px; left:10px; background:var(--primary); 
                                color:white; padding:2px 8px; border-radius:10px; font-size:0.8rem;">
                        ${estudiante.total_evidencias}
                    </div>
                ` : ''}
                <div style="position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.7); 
                            color:white; padding:10px; text-align:center;">
                    <div style="font-weight:600; font-size:0.9rem;">${estudiante.nombre} ${estudiante.apellido}</div>
                    <div style="font-size:0.8rem; opacity:0.8;">CI: ${estudiante.cedula}</div>
                </div>
            `;
            
            grid.appendChild(tarjeta);
        });
    }

    function filtrarEvidencias() {
        const filtro = document.getElementById('filterEvidence').value.toLowerCase();
        const tarjetas = document.querySelectorAll('.evidence-card');
        const vacio = document.getElementById('evidenceEmpty');
        let visibles = 0;
        
        tarjetas.forEach(tarjeta => {
            const texto = tarjeta.textContent.toLowerCase();
            if (texto.includes(filtro)) {
                tarjeta.style.display = 'block';
                visibles++;
            } else {
                tarjeta.style.display = 'none';
            }
        });
        
        if (visibles === 0 && tarjetas.length > 0 && vacio) {
            vacio.style.display = 'flex';
        } else if (vacio) {
            vacio.style.display = 'none';
        }
    }

    async function verEvidenciasEstudiante(estudiante) {
        estudianteActual = estudiante;
        
        try {
            const respuesta = await fetch(`${API_URL}/todas_evidencias?cedula=${estudiante.cedula}`);
            evidenciasEstudianteActual = await respuesta.json();
            
            // Actualizar título
            document.getElementById('studentNameTitle').textContent = `Evidencias de ${estudiante.nombre} ${estudiante.apellido}`;
            
            // Mostrar información del estudiante
            const infoContainer = document.getElementById('studentInfoContainer');
            infoContainer.innerHTML = `
                <img src="${estudiante.foto || 'Img/Logo_pestaña.png'}" 
                 class="student-avatar" 
                 onerror="this.src='Img/Logo_pestaña.png'"
                 alt="${estudiante.nombre} ${estudiante.apellido}">
                <div>
                    <h3 style="color:var(--primary); margin-bottom:5px;">${estudiante.nombre} ${estudiante.apellido}</h3>
                    <p style="color:var(--text-sec); margin-bottom:5px;">Cédula: ${estudiante.cedula}</p>
                    <p style="color:var(--text-sec);">Total evidencias: ${evidenciasEstudianteActual.length}</p>
                </div>
            `;
            infoContainer.style.display = 'flex';
            
            // Mostrar evidencias
            renderizarEvidenciasEstudiante();
            
            // Cambiar a la sección de evidencias del estudiante
            document.querySelectorAll('.panel-section').forEach(seccion => {
                seccion.classList.remove('active');
            });
            document.getElementById('panel-evidencias-estudiante').classList.add('active');
            
            // Ir al inicio de la página
            window.scrollTo(0, 0);
            
        } catch (error) {
            console.error('Error cargando evidencias del estudiante:', error);
            mostrarMensaje('Error al cargar evidencias del estudiante: ' + error.message, 'error');
        }
    }

    function renderizarEvidenciasEstudiante() {
        const grid = document.getElementById('studentEvidenceGrid');
        const vacio = document.getElementById('studentEvidenceEmpty');
        
        if (!grid) return;
        
        if (evidenciasEstudianteActual.length === 0) {
            grid.innerHTML = '';
            if (vacio) vacio.style.display = 'flex';
            return;
        }
        
        if (vacio) vacio.style.display = 'none';
        grid.innerHTML = '';
        
        evidenciasEstudianteActual.forEach((evidencia, index) => {
            const tarjeta = document.createElement('div');
            tarjeta.className = `evidence-card ${modoSeleccion ? 'selection-mode-active' : ''}`;
            if (evidenciasSeleccionadas.includes(evidencia.id)) {
                tarjeta.classList.add('selected');
            }
            
            tarjeta.onclick = () => {
                if (modoSeleccion) {
                    toggleSeleccionEvidencia(evidencia.id, tarjeta);
                } else {
                    abrirVisor(index);
                }
            };
            
            const esVideo = evidencia.Url_Archivo && evidencia.Url_Archivo.match(/\.(mp4|avi|mov|webm)$/i);
            const esImagen = evidencia.Url_Archivo && evidencia.Url_Archivo.match(/\.(jpg|jpeg|png|gif|webp)$/i);
            
            let contenido = '';
            
            if (esImagen) {
                contenido = `<img src="${evidencia.Url_Archivo}" class="card-media" loading="lazy" onerror="this.src='Img/Logo_pestaña.png'">`;
            } else if (esVideo) {
                contenido = `
                    <video src="${evidencia.Url_Archivo}#t=0.1" class="card-media"></video>
                    <div class="video-overlay"><i class="fas fa-play-circle"></i></div>
                `;
            } else {
                contenido = `
                    <div style="width:100%;height:100%;background:var(--bg-input);display:flex;align-items:center;justify-content:center;color:var(--text-main);">
                        <i class="fas fa-file-alt" style="font-size:2.5rem;"></i>
                    </div>
                `;
            }
            
            tarjeta.innerHTML = `
                <div class="selection-check"><i class="fas fa-check"></i></div>
                ${contenido}
            `;
            
            grid.appendChild(tarjeta);
        });
        
        // Actualizar contador de selección
        document.getElementById('countSelection').textContent = evidenciasSeleccionadas.length;
    }

    function volverAEvidencias() {
        // Detener videos antes de salir
        document.querySelectorAll('video, audio').forEach(media => media.pause());
        
        modoSeleccion = false;
        evidenciasSeleccionadas = [];
        document.getElementById('floatingBar').classList.remove('active');
        
        document.querySelectorAll('.panel-section').forEach(seccion => {
            seccion.classList.remove('active');
        });
        document.getElementById('panel-evidencias').classList.add('active');
        
        window.scrollTo(0, 0);
    }

    // ==========================================
    // 7. FUNCIONES DE LIGHTBOX Y VISOR
    // ==========================================
    function configurarEventosTeclado() {
        document.addEventListener('keydown', (e) => {
            const lightbox = document.getElementById('lightbox');
            if (!lightbox.classList.contains('active')) return;
            
            switch(e.key) {
                case 'Escape':
                    cerrarLightbox();
                    break;
                case 'ArrowLeft':
                    imagenAnterior();
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    imagenSiguiente();
                    e.preventDefault();
                    break;
            }
        });
    }

    function abrirPrevisualizacion(url) {
        const lightbox = document.getElementById('lightbox');
        const contenido = document.getElementById('lightboxContent');
        
        contenido.innerHTML = `
            <img src="${url}" class="lb-media-item" style="max-height:70vh; object-fit:contain;">
        `;
        
        const enlaceDescarga = document.getElementById('lbDownloadLink');
        enlaceDescarga.href = url;
        enlaceDescarga.download = url.split('/').pop();
        
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function cerrarLightbox() {
        const lightbox = document.getElementById('lightbox');
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
        
        // SOLUCIÓN: Limpiar el contenido HTML mata el reproductor de video/audio
        document.getElementById('lightboxContent').innerHTML = '';
    }

    function cerrarLightboxSiFondo(evento) {
        if (evento.target.id === 'lightbox') {
            cerrarLightbox();
        }
    }

    function abrirVisor(indice) {
        evidenciasVisor = evidenciasEstudianteActual;
        indiceVisorActual = indice;
        actualizarVisor();
        document.getElementById('lightbox').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function actualizarVisor() {
        const contenido = document.getElementById('lightboxContent');
        const enlaceDescarga = document.getElementById('lbDownloadLink');
        
        if (evidenciasVisor.length === 0) return;
        
        const evidenciaActual = evidenciasVisor[indiceVisorActual];
        
        enlaceDescarga.href = evidenciaActual.Url_Archivo;
        enlaceDescarga.download = evidenciaActual.Url_Archivo.split('/').pop();
        
        const esVideo = evidenciaActual.Url_Archivo && evidenciaActual.Url_Archivo.match(/\.(mp4|avi|mov|webm)$/i);
        
        if (esVideo) {
            contenido.innerHTML = `
                <video src="${evidenciaActual.Url_Archivo}" class="lb-media-item" controls autoplay></video>
            `;
        } else {
            contenido.innerHTML = `
               <img src="${evidenciaActual.Url_Archivo}" class="lb-media-item" onerror="this.src='Img/Logo_pestaña.png'">
            `;
        }
    }

    function imagenSiguiente(evento) {
        if (evento) evento.stopPropagation();
        indiceVisorActual = (indiceVisorActual + 1) % evidenciasVisor.length;
        actualizarVisor();
    }

    function imagenAnterior(evento) {
        if (evento) evento.stopPropagation();
        indiceVisorActual = (indiceVisorActual - 1 + evidenciasVisor.length) % evidenciasVisor.length;
        actualizarVisor();
    }

    async function eliminarEvidenciaActual() {
        // 1. CERRAR PRIMERO LA GALERÍA (Esto arregla el error aria-hidden)
        cerrarLightbox();
        
        // Esperamos un poquito a que se cierre
        setTimeout(async () => {
            const evidencia = evidenciasVisor[indiceVisorActual];
            
            const result = await Swal.fire({
                title: '¿Eliminar evidencia?',
                text: 'Se borrará permanentemente.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d32f2f',
                confirmButtonText: 'Sí, eliminar'
            });

            if (result.isConfirmed) {
                try {
                    await fetch(`${API_URL}/eliminar_evidencia/${evidencia.id}`, { method: 'DELETE' });
                    
                    // Actualizar pantalla
                    evidenciasVisor.splice(indiceVisorActual, 1);
                    verEvidenciasEstudiante(estudianteActual); 
                    
                    Swal.fire('Eliminado', '', 'success');
                } catch (error) {
                    Swal.fire('Error', 'No se pudo eliminar', 'error');
                }
            }
        }, 200);
    }
    // ==========================================
    // 8. FUNCIONES DE SEGURIDAD Y LOGS
    // ==========================================
    async function cargarLogs() {
        try {
            const respuesta = await fetch(`${API_URL}/obtener_logs`);
            logs = await respuesta.json();
            renderizarLogs();
            mostrarMensaje('Logs actualizados', 'success');
        } catch (error) {
            console.error('Error cargando logs:', error);
            mostrarMensaje('Error al cargar logs: ' + error.message, 'error');
        }
    }

    function renderizarLogs() {
        const tbody = document.getElementById('logsTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = logs.map(log => {
            const fechaFormateada = formatearFecha(log.Fecha);
            const colorAccion = obtenerColorAccion(log.Accion);
            const usuario = log.Usuario || 'Sistema';
            
            return `
                <tr>
                    <td>${fechaFormateada}</td>
                    <td>
                        <span style="font-weight:600; color:${colorAccion}">
                            ${log.Accion || 'Sin acción'}
                        </span>
                    </td>
                    <td>${log.Detalle || 'Sin detalle'}</td>
                    <td>${usuario}</td>
                </tr>
            `;
        }).join('');
    }

    function obtenerColorAccion(accion) {
        if (!accion) return 'var(--text-main)';
        if (accion.includes('ELIMIN') || accion.includes('ERROR')) {
            return 'var(--error)';
        } else if (accion.includes('REGISTRO') || accion.includes('APROB')) {
            return 'var(--secondary)';
        } else if (accion.includes('LOGIN') || accion.includes('SUBIDA')) {
            return 'var(--info)';
        } else if (accion.includes('ACTUALIZ') || accion.includes('CAMBIAR')) {
            return 'var(--primary)';
        }
        return 'var(--text-main)';
    }

    function filtrarLogs() {
        const busqueda = document.getElementById('searchLogs').value.toLowerCase();
        const filas = document.querySelectorAll('#logsTableBody tr');
        
        filas.forEach(fila => {
            const texto = fila.textContent.toLowerCase();
            fila.style.display = texto.includes(busqueda) ? '' : 'none';
        });
    }

    // ==========================================
    // 9. FUNCIONES AUXILIARES RESTANTES
    // ==========================================
    async function ejecutarMantenimiento(tipo) {
        let titulo, texto, icono;
        
        if (tipo === 'duplicados') {
            titulo = '¿Analizar y Borrar Duplicados?';
            texto = 'El sistema buscará archivos idénticos y borrará las copias sobrantes para ahorrar espacio.';
            icono = 'question';
        } else if (tipo === 'cache') {
            titulo = '¿Limpiar Caché y Compactar?';
            texto = 'Se ejecutará VACUUM para reducir el tamaño de la base de datos y acelerar el sistema.';
            icono = 'info';
        } else if (tipo === 'huerfanos') {
            titulo = '¿Limpiar Archivos Fantasma?';
            texto = 'Se eliminarán de la lista los archivos que no existen físicamente en la nube/disco.';
            icono = 'warning';
        }

        const confirmacion = await Swal.fire({
            title: titulo,
            text: texto,
            icon: icono,
            showCancelButton: true,
            confirmButtonColor: '#6A0DAD',
            confirmButtonText: 'Sí, ejecutar',
            cancelButtonText: 'Cancelar'
        });
        
        if (!confirmacion.isConfirmed) return;

        try {
            mostrarMensaje('Ejecutando mantenimiento...', 'info');
            
            // TODOS llaman a la función maestra V4.1 porque ella hace todo junto de forma segura
            const respuesta = await fetch(`${API_URL}/optimizar_sistema`, { method: 'POST' });
            const resultado = await respuesta.json();
            
            if (resultado.status === 'ok') {
                mostrarMensaje('Proceso finalizado correctamente.', 'success');
                // Recargar estadísticas para ver el ahorro de espacio
                setTimeout(() => actualizarDatosDashboard(), 2000);
            } else {
                mostrarMensaje('Error: ' + resultado.error, 'error');
            }
        } catch (error) {
            mostrarMensaje('Error de conexión', 'error');
        }
    }

    // Botones individuales que llaman a la maestra
    function analizarDuplicados() { ejecutarMantenimiento('duplicados'); }
    function limpiarCache() { ejecutarMantenimiento('cache'); }
    function limpiarHuerfanos() { ejecutarMantenimiento('huerfanos'); }

    // (Aquí sigue tu función abrirModalAgregarRef...)
    function abrirModalAgregarRef() {
        const select = document.getElementById('selectUsuarioRef');
        select.innerHTML = '<option value="">-- Seleccionar --</option>' +
            usuarios.filter(u => u.tipo == 1).map(u => 
                `<option value="${u.cedula}">${u.nombre} ${u.apellido} (${u.cedula})</option>`
            ).join('');
        
        document.getElementById('modalAgregarRef').classList.add('active');
    }

    async function agregarReferencia(evento) {
        evento.preventDefault();
        
        const cedula = document.getElementById('selectUsuarioRef').value;
        const archivoInput = document.getElementById('fotoRef');
        
        if (!cedula || !archivoInput.files.length) {
            mostrarMensaje('Completa todos los campos', 'warning');
            return;
        }
        
        const datos = new FormData();
        datos.append('cedula', cedula);
        datos.append('foto', archivoInput.files[0]);
        
        const boton = evento.target.querySelector('button[type="submit"]');
        
        try {
            boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
            boton.disabled = true;
            
            const respuesta = await fetch(`${API_URL}/agregar_referencia_facial`, {
                method: 'POST',
                body: datos
            });
            
            const resultado = await respuesta.json();
            
            if (resultado.mensaje) {
                mostrarMensaje('Foto de referencia agregada correctamente', 'success');
                cerrarModal('modalAgregarRef');
                evento.target.reset();
            } else {
                mostrarMensaje('Error: ' + (resultado.error || 'Desconocido'), 'error');
            }
        } catch (error) {
            mostrarMensaje('Error de conexión: ' + error.message, 'error');
        } finally {
            boton.innerHTML = '<i class="fas fa-save"></i> Agregar Referencia';
            boton.disabled = false;
        }
    }

    // ==========================================
    // 10. FUNCIONES DE SUBIDA DE ARCHIVOS
    // ==========================================
    function mostrarSugerencias(texto) {
        const sugerencias = document.getElementById('suggestionsBox');
        
        if (texto.length < 2) {
            sugerencias.style.display = 'none';
            return;
        }
        
        const coincidencias = usuarios.filter(usuario => {
            const nombreCompleto = `${usuario.nombre} ${usuario.apellido}`.toLowerCase();
            return nombreCompleto.includes(texto.toLowerCase());
        }).slice(0, 5);
        
        if (coincidencias.length === 0) {
            sugerencias.style.display = 'none';
            return;
        }
        
        sugerencias.innerHTML = coincidencias.map(usuario => `
            <div onclick="seleccionarUsuario('${usuario.cedula}')" 
                 style="padding:8px 12px; cursor:pointer; border-bottom:1px solid var(--border-color); color:var(--text-main);">
                ${usuario.nombre} ${usuario.apellido} 
                <small style="color:var(--text-sec);">(${usuario.cedula})</small>
            </div>
        `).join('');
        
        sugerencias.style.display = 'block';
    }

    function seleccionarUsuario(cedula) {
        const usuario = usuarios.find(u => u.cedula === cedula);
        if (usuario) {
            document.getElementById('manualNombres').value = 
                `${usuario.nombre} ${usuario.apellido}`;
            document.getElementById('suggestionsBox').style.display = 'none';
        }
    }

    async function subirManual(evento) {
        evento.preventDefault();
        
        const archivoInput = document.getElementById('manualFile');
        const nombresInput = document.getElementById('manualNombres');
        
        if (!archivoInput.files.length) {
            mostrarMensaje('Selecciona un archivo primero', 'warning');
            return;
        }
        
        if (!nombresInput.value.trim()) {
            mostrarMensaje('Ingresa al menos un nombre de estudiante', 'warning');
            return;
        }
        
        // Buscar cédulas por nombres
        const nombres = nombresInput.value.split(',').map(n => n.trim());
        const cedulas = [];
        
        nombres.forEach(nombre => {
            const usuario = usuarios.find(u => {
                const nombreCompleto = `${u.nombre} ${u.apellido}`.toLowerCase();
                return nombreCompleto.includes(nombre.toLowerCase());
            });
            
            if (usuario) {
                cedulas.push(usuario.cedula);
            }
        });
        
        if (cedulas.length === 0) {
            Swal.fire({
                title: 'Error de validación',
                text: 'No se encontraron estudiantes con esos nombres. Verifica los nombres e intenta nuevamente.',
                icon: 'error',
                confirmButtonColor: '#6A0DAD'
            });
            return;
        }
        
        const datos = new FormData();
        datos.append('archivo', archivoInput.files[0]);
        datos.append('cedulas', cedulas.join(','));
        
        const boton = evento.target.querySelector('button[type="submit"]');
        
        try {
            boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
            boton.disabled = true;
            
            const respuesta = await fetch(`${API_URL}/subir_manual`, {
                method: 'POST',
                body: datos
            });
            
            const resultado = await respuesta.json();
            
            if (resultado.mensaje === 'OK' || resultado.status === 'ok') {
                mostrarMensaje(`Archivo asignado a ${resultado.asignado_a?.length || cedulas.length} estudiantes`, 'success');
                archivoInput.value = '';
                nombresInput.value = '';
                await cargarDatosIniciales();
            } else {
                Swal.fire({
                    title: 'Error al subir',
                    text: resultado.error || 'Error desconocido al subir el archivo',
                    icon: 'error',
                    confirmButtonColor: '#6A0DAD'
                });
            }
        } catch (error) {
            Swal.fire({
                title: 'Error de conexión',
                text: 'No se pudo conectar con el servidor: ' + error.message,
                icon: 'error',
                confirmButtonColor: '#6A0DAD'
            });
        } finally {
            boton.innerHTML = '<i class="fas fa-user-check"></i> Asignar Manualmente';
            boton.disabled = false;
        }
    }

    async function handleUploadIA(input) {
        const archivos = input.files;
        if (archivos.length === 0) return;
        
        const log = document.getElementById('uploadLog');
        const progreso = document.getElementById('uploadProgress');
        const barra = document.getElementById('progressBar');
        const texto = document.getElementById('progressText');
        
        log.innerHTML = '<div><i class="fas fa-info-circle"></i> Iniciando análisis de reconocimiento facial...</div>';
        progreso.style.display = 'block';
        
        let completados = 0;
        const total = archivos.length;
        
        for (let i = 0; i < total; i++) {
            const archivo = archivos[i];
            const datos = new FormData();
            datos.append('archivo', archivo);
            
            texto.textContent = `Procesando ${i + 1}/${total}: ${archivo.name}`;
            barra.style.width = ((i / total) * 100) + '%';
            
            try {
                const respuesta = await fetch(`${API_URL}/subir_evidencia_ia`, {
                    method: 'POST',
                    body: datos
                });
                
                const resultado = await respuesta.json();
                
                // --- CORRECCIÓN AQUÍ ---
                // Antes ignoraba el mensaje del servidor. Ahora lo mostramos.
                if (resultado.status === 'exito') {
                    // Usamos resultado.mensaje porque ahí vienen los NOMBRES
                    log.innerHTML += `<div style="color:var(--secondary); margin-top:5px; padding:5px; border-bottom:1px solid #eee;">
                        <strong>${archivo.name}:</strong><br>${resultado.mensaje}
                    </div>`;
                } else if (resultado.status === 'alerta') {
                    log.innerHTML += `<div style="color:var(--warning); margin-top:5px; padding:5px; border-bottom:1px solid #eee;">
                        <strong>⚠ ${archivo.name}:</strong> ${resultado.mensaje}
                    </div>`;
                } else {
                    log.innerHTML += `<div style="color:var(--error); margin-top:5px; padding:5px; border-bottom:1px solid #eee;">
                        <strong>❌ ${archivo.name}:</strong> ${resultado.mensaje || 'Error desconocido'}
                    </div>`;
                }
            } catch (error) {
                log.innerHTML += `<div style="color:var(--error);">❌ ${archivo.name}: Error de conexión - ${error.message}</div>`;
            }
            
            completados++;
            barra.style.width = ((completados / total) * 100) + '%';
        }
        
        texto.textContent = 'Proceso completado ✅';
        if (input.tagName === 'INPUT') {
        input.value = '';
    }
        
        setTimeout(() => {
            cargarDatosIniciales();
        }, 1500);
    }

    // ==========================================
    // 11. FUNCIONES DE CAMBIO DE CONTRASEÑA
    // ==========================================
    function sugerirUsuariosPassword(texto) {
        const sugerencias = document.getElementById('suggestionsPass');
        
        if (texto.length < 2) {
            sugerencias.style.display = 'none';
            return;
        }
        
        const coincidencias = usuarios.filter(usuario => {
            const nombreCompleto = `${usuario.nombre} ${usuario.apellido}`.toLowerCase();
            return nombreCompleto.includes(texto.toLowerCase());
        }).slice(0, 5);
        
        if (coincidencias.length === 0) {
            sugerencias.style.display = 'none';
            return;
        }
        
        sugerencias.innerHTML = coincidencias.map(usuario => `
            <div onclick="seleccionarUsuarioPassword('${usuario.cedula}')" 
                 style="padding:8px 12px; cursor:pointer; border-bottom:1px solid var(--border-color); color:var(--text-main);">
                ${usuario.nombre} ${usuario.apellido}
                <small style="color:var(--text-sec);">(${usuario.cedula})</small>
            </div>
        `).join('');
        
        sugerencias.style.display = 'block';
    }

    function seleccionarUsuarioPassword(cedula) {
        usuarioSeleccionadoPassword = usuarios.find(u => u.cedula === cedula);
        if (usuarioSeleccionadoPassword) {
            document.getElementById('nombrePassword').value = 
                `${usuarioSeleccionadoPassword.nombre} ${usuarioSeleccionadoPassword.apellido}`;
            document.getElementById('suggestionsPass').style.display = 'none';
        }
    }

    async function cambiarPassword(evento) {
        evento.preventDefault();
        
        if (!usuarioSeleccionadoPassword) {
            mostrarMensaje('Selecciona un usuario primero', 'warning');
            return;
        }
        
        const nuevaPassword = document.getElementById('nuevaPassword').value;
        
        if (nuevaPassword.length < 6) {
            Swal.fire({
                title: 'Error de validación',
                text: 'La contraseña debe tener al menos 6 caracteres',
                icon: 'error',
                confirmButtonColor: '#6A0DAD'
            });
            return;
        }
        
        const confirmacion = await Swal.fire({
            title: '¿Cambiar contraseña?',
            text: `¿Cambiar contraseña de ${usuarioSeleccionadoPassword.nombre} a: ${nuevaPassword}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#6A0DAD',
            cancelButtonColor: '#5f6368',
            confirmButtonText: 'Sí, cambiar',
            cancelButtonText: 'Cancelar'
        });
        
        if (!confirmacion.isConfirmed) return;
        
        try {
            const respuesta = await fetch(`${API_URL}/cambiar_contrasena`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cedula: usuarioSeleccionadoPassword.cedula,
                    nueva_contrasena: nuevaPassword
                })
            });
            
            const resultado = await respuesta.json();
            
            if (resultado.mensaje) {
                mostrarMensaje(`Contraseña cambiada para ${usuarioSeleccionadoPassword.nombre}`, 'success');
                document.getElementById('formCambiarPassword').reset();
                usuarioSeleccionadoPassword = null;
                await cargarDatosIniciales();
            } else {
                mostrarMensaje('Error al cambiar contraseña: ' + (resultado.error || 'Desconocido'), 'error');
            }
        } catch (error) {
            mostrarMensaje('Error de conexión: ' + error.message, 'error');
        }
    }

    // ==========================================
    // 12. FUNCIONES DE MANTENIMIENTO
    // ==========================================
    function descargarBackup(tipo) {
        const url = tipo === 'db' 
            ? `${API_URL}/crear_backup` 
            : `${API_URL}/descargar_multimedia_zip`;
        
        // Crear enlace invisible para descarga
        const enlace = document.createElement('a');
        enlace.href = url;
        enlace.style.display = 'none';
        enlace.target = '_blank';
        document.body.appendChild(enlace);
        enlace.click();
        document.body.removeChild(enlace);
        
        mostrarMensaje(`Descarga de ${tipo === 'db' ? 'base de datos' : 'multimedia'} iniciada`, 'info');
    }

    async function optimizarSistema() {
        const confirmacion = await Swal.fire({
            title: '¿Optimizar sistema?',
            text: '¿Deseas optimizar el sistema y limpiar caché? Esto puede mejorar el rendimiento.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#6A0DAD',
            cancelButtonColor: '#5f6368',
            confirmButtonText: 'Sí, optimizar',
            cancelButtonText: 'Cancelar'
        });
        
        if (!confirmacion.isConfirmed) return;
        
        try {
            const respuesta = await fetch(`${API_URL}/optimizar_sistema`, {
                method: 'POST'
            });
            
            const resultado = await respuesta.json();
            
            if (resultado.status === 'ok') {
                mostrarMensaje('Sistema optimizado correctamente', 'success');
                await cargarDatosIniciales();
            } else {
                mostrarMensaje('Error al optimizar sistema', 'error');
            }
        } catch (error) {
            mostrarMensaje('Error de conexión: ' + error.message, 'error');
        }
    }

    // ==========================================
    // 13. FUNCIONES DE SELECCIÓN MÚLTIPLE
    // ==========================================
    function toggleModoSeleccion() {
        modoSeleccion = !modoSeleccion;
        
        if (modoSeleccion) {
            document.getElementById('floatingBar').classList.add('active');
            document.getElementById('btnSelectMode').innerHTML = '<i class="fas fa-times"></i> Cancelar';
        } else {
            document.getElementById('floatingBar').classList.remove('active');
            document.getElementById('btnSelectMode').innerHTML = '<i class="fas fa-check-square"></i> Seleccionar';
            evidenciasSeleccionadas = [];
        }
        
        renderizarEvidenciasEstudiante();
    }

    function toggleSeleccionEvidencia(id, elemento) {
        const index = evidenciasSeleccionadas.indexOf(id);
        if (index === -1) {
            evidenciasSeleccionadas.push(id);
            elemento.classList.add('selected');
        } else {
            evidenciasSeleccionadas.splice(index, 1);
            elemento.classList.remove('selected');
        }
        
        document.getElementById('countSelection').textContent = evidenciasSeleccionadas.length;
    }

    function cancelarSeleccion() {
        modoSeleccion = false;
        evidenciasSeleccionadas = [];
        document.getElementById('floatingBar').classList.remove('active');
        document.getElementById('btnSelectMode').innerHTML = '<i class="fas fa-check-square"></i> Seleccionar';
        renderizarEvidenciasEstudiante();
    }

    async function descargarSeleccionadas() {
        if (evidenciasSeleccionadas.length === 0) {
            mostrarMensaje('Selecciona al menos una evidencia', 'warning');
            return;
        }
        
        try {
            mostrarMensaje('Preparando descarga...', 'info');
            
            const formData = new FormData();
            formData.append('ids', evidenciasSeleccionadas.join(','));
            
            const respuesta = await fetch(`${API_URL}/descargar_evidencias_zip`, {
                method: 'POST',
                body: formData
            });
            
            if (respuesta.ok) {
                const blob = await respuesta.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `evidencias_${estudianteActual.cedula}_${Date.now()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                mostrarMensaje('Descarga iniciada', 'success');
                cancelarSeleccion();
            } else {
                mostrarMensaje('Error al preparar la descarga', 'error');
            }
        } catch (error) {
            console.error('Error descargando evidencias:', error);
            mostrarMensaje('Error de conexión al descargar: ' + error.message, 'error');
        }
    }

    async function eliminarSeleccionadas() {
        if (evidenciasSeleccionadas.length === 0) {
            mostrarMensaje('Selecciona al menos una evidencia', 'warning');
            return;
        }
        
        const confirmacion = await Swal.fire({
            title: '¿Eliminar evidencias seleccionadas?',
            text: `Se eliminarán ${evidenciasSeleccionadas.length} evidencias permanentemente.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d32f2f',
            cancelButtonColor: '#5f6368',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        });
        
        if (!confirmacion.isConfirmed) return;
        
        try {
            mostrarMensaje('Eliminando evidencias...', 'info');
            
            for (const id of evidenciasSeleccionadas) {
                await fetch(`${API_URL}/eliminar_evidencia/${id}`, {
                    method: 'DELETE'
                });
            }
            
            mostrarMensaje(`${evidenciasSeleccionadas.length} evidencias eliminadas`, 'success');
            
            await verEvidenciasEstudiante(estudianteActual);
            cancelarSeleccion();
            
        } catch (error) {
            console.error('Error eliminando evidencias:', error);
            mostrarMensaje('Error al eliminar evidencias: ' + error.message, 'error');
        }
    }
    function configurarDragAndDrop() {
        const dropZone = document.getElementById('dropZoneIA');
        const fileInput = document.getElementById('fileInputIA');
        
        if(!dropZone) return;

        // Prevenir comportamientos por defecto del navegador (para que no abra la foto al soltarla)
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Efectos visuales: Iluminar al entrar
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
        });

        // Efectos visuales: Apagar al salir o soltar
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
        });

        // AL SOLTAR LOS ARCHIVOS
        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            // Enviamos los archivos a tu función de subida existente
            // Simulamos que viene de un input para no romper tu código actual
            handleUploadIA({ files: files, value: '' });
        }, false);
    }
    // ==========================================
    // 14. LÓGICA DE REASIGNACIÓN (NUEVO)
    // ==========================================
    
    let destinosSeleccionados = new Set(); // Almacén de cédulas seleccionadas

    function abrirModalReasignar() {
        if (evidenciasSeleccionadas.length === 0) return;
        destinosSeleccionados.clear(); // Limpiar selección anterior
        renderizarListaReasignar(usuarios); // Mostrar todos los usuarios
        document.getElementById('modalReasignar').classList.add('active');
    }

    function renderizarListaReasignar(listaUsuarios) {
        const contenedor = document.getElementById('listaUsuariosReasignar');
        // Filtramos para no mostrar la bandeja ni administradores
        const usuariosValidos = listaUsuarios.filter(u => u.tipo == 1 && u.cedula !== '9999999990');

        contenedor.innerHTML = usuariosValidos.map(u => {
            // Verificamos si ya estaba seleccionado para pintarlo azul
            const isSelected = destinosSeleccionados.has(u.cedula) ? 'seleccionado' : '';
            const iconCheck = destinosSeleccionados.has(u.cedula) 
                ? '<i class="fas fa-check-square" style="color:var(--info);"></i>' 
                : '<i class="far fa-square" style="color:#ccc;"></i>';
            
            return `
            <div class="usuario-item ${isSelected}" onclick="toggleDestino('${u.cedula}')" id="user-row-${u.cedula}">
                <div>
                    <strong>${u.nombre} ${u.apellido}</strong><br>
                    <small>${u.cedula}</small>
                </div>
                ${iconCheck}
            </div>
        `}).join('');
    }

    function toggleDestino(cedula) {
        // Si ya está, lo quita. Si no está, lo agrega.
        if (destinosSeleccionados.has(cedula)) {
            destinosSeleccionados.delete(cedula);
        } else {
            destinosSeleccionados.add(cedula);
        }
        // Refrescamos la lista visualmente manteniendo el filtro de búsqueda
        const textoBusqueda = document.getElementById('busquedaReasignar').value;
        filtrarUsuariosReasignar(textoBusqueda);
    }

    function filtrarUsuariosReasignar(texto) {
        const busqueda = texto.toLowerCase();
        // Filtramos la lista global de usuarios
        const filtrados = usuarios.filter(u => 
            (u.tipo == 1 && u.cedula !== '9999999990') &&
            (u.nombre + ' ' + u.apellido + u.cedula).toLowerCase().includes(busqueda)
        );
        renderizarListaReasignar(filtrados);
    }

    async function enviarReasignacionMasiva() {
        if (destinosSeleccionados.size === 0) {
            Swal.fire('Atención', 'Selecciona al menos un estudiante.', 'warning');
            return;
        }

        const cedulasArray = Array.from(destinosSeleccionados);
        
        try {
            mostrarMensaje('Procesando asignación...', 'info');
            
            const respuesta = await fetch(`${API_URL}/reasignar_evidencias`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    ids: evidenciasSeleccionadas.join(','),
                    cedula_destino: cedulasArray.join(',') // Enviamos lista separada por comas
                })
            });

            const res = await respuesta.json();
            
            if (res.mensaje) {
                mostrarMensaje(res.mensaje, 'success');
                cerrarModal('modalReasignar');
                cancelarSeleccion();
                // Recargar para ver los cambios si estamos viendo un perfil
                if (estudianteActual) verEvidenciasEstudiante(estudianteActual);
            } else {
                mostrarMensaje('Error: ' + res.error, 'error');
            }
        } catch (e) {
            mostrarMensaje('Error de conexión', 'error');
        }
    }
    </script>
</body>
</html>